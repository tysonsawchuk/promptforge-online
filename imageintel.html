<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PromptForge — ImageIntel Pro Visor v12.6 (Local-Only Core)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="PromptForge ImageIntel Pro Visor v12.6 — On-device, local-only MediaPipe Tasks with cinematic overlays and diagnostics.">
  <link rel="canonical" href="https://promptforge.online/tools/imageintel-v12-6-local.html">
  <style>
    :root{
      --bg:#0b0f14;--panel:#0f141b;--ink:#d6f5ff;--muted:#9db1bd;
      --hl:#64f2e3;--ok:#23d7ba;--bad:#fa528e;--grid:#1c2430;--accent:#9b8cff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,ui-monospace,monospace}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .title{display:flex;align-items:center;gap:12px}
    .badge{border:1px solid var(--hl);color:var(--hl);padding:2px 8px;border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
    .card{background:var(--panel);border:1px solid #1b222c;border-radius:14px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #17202a;background:#0e131a;font-weight:600}
    .body{padding:12px 14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button{background:#121821;color:var(--ink);border:1px solid #2a3543;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{border-color:var(--hl);color:var(--hl)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input[type="file"]{display:none}
    .fileLabel{border:1px dashed #2a3543;border-radius:10px;padding:10px 14px;cursor:pointer}
    .pill{border:1px solid #253142;padding:4px 8px;border-radius:999px;font-size:12px}
    #stageWrap{position:relative;background:#0b1118;border:1px solid #18202a;border-radius:12px;overflow:hidden}
    #stage{display:block;width:100%;height:auto;background:#000}
    #overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #diag{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f15;border-radius:10px;padding:10px;white-space:pre-wrap;line-height:1.35;border:1px solid #19222c}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .gaugeRow{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .gauge{background:#0c1219;border:1px solid #1a2330;border-radius:8px;padding:6px 8px}
    .gauge b{display:block;font-size:12px;margin-bottom:4px;color:#bfe9ff}
    .bar{height:6px;background:#0e1520;border-radius:999px;overflow:hidden}
    .bar span{display:block;height:100%;background:linear-gradient(90deg,var(--hl),var(--accent))}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:13px;color:#cbe7ff}
    .kv .k{color:#81d1ff}
    canvas.gridBG{position:absolute; inset:0; width:100%; height:100%; pointer-events:none; mix-blend-mode:screen; opacity:.22}
    .legend{display:flex;gap:12px;font-size:12px;color:#b6c7d4}
    .legend .sw{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
    .sw-mesh{background:#60f8e9}.sw-iris{background:#ff89f0}.sw-aux{background:#ffd166}
    .footerNote{margin-top:12px;color:#9fb0bc;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0">ImageIntel Pro Visor <span class="badge">v12.6 · local-only</span></h1>
      <span class="muted">Face first; Pose/Seg/Obj re-enable after greenlights</span>
    </div>

    <div class="grid">
      <!-- LEFT: Stage + Controls -->
      <div class="card">
        <h3>Stage</h3>
        <div class="body">
          <div class="toolbar">
            <label class="fileLabel"><input id="fileInput" type="file" accept="image/*">Choose image…</label>
            <span class="pill" id="imgInfo">No image loaded</span>
            <span class="pill">Mode: IMAGE</span>
            <span class="pill">Runtime: MediaPipe Tasks</span>
          </div>

          <div id="stageWrap">
            <canvas id="stage" width="1024" height="640"></canvas>
            <canvas id="overlay" width="1024" height="640"></canvas>
            <canvas id="gridbg" class="gridBG" width="1024" height="640"></canvas>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="switch">
              <input type="checkbox" id="toggleMesh" checked>
              <label for="toggleMesh">Face mesh</label>
            </div>
            <div class="switch">
              <input type="checkbox" id="toggleIris" checked>
              <label for="toggleIris">Iris</label>
            </div>
            <div class="switch">
              <input type="checkbox" id="toggleAux" checked>
              <label for="toggleAux">Axes + Guides</label>
            </div>
            <div class="switch">
              <input type="checkbox" id="toggleGrid" checked>
              <label for="toggleGrid">HUD Grid</label>
            </div>
          </div>

          <div class="legend" style="margin-top:8px">
            <span><span class="sw sw-mesh"></span>Mesh</span>
            <span><span class="sw sw-iris"></span>Iris</span>
            <span><span class="sw sw-aux"></span>Guides</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Diagnostics + Blendshapes -->
      <div class="card">
        <h3>Diagnostics</h3>
        <div class="body">
          <div id="diag">Ready.\nUpload an image to begin.</div>
          <div style="height:10px"></div>
          <div class="kv">
            <div class="k">Bundle</div><div id="kvBundle" class="v muted">—</div>
            <div class="k">Fileset</div><div id="kvFileset" class="v muted">—</div>
            <div class="k">Face model</div><div id="kvFaceModel" class="v muted">—</div>
            <div class="k">Inference</div><div id="kvInfer" class="v muted">—</div>
          </div>
          <div style="height:12px"></div>
          <div class="gaugeRow" id="blendshapeGauges"></div>
          <div class="footerNote">Tip: If you see <span class="bad">Unexpected token '&lt;'</span>, your server is serving HTML for a binary path. Fix the path or MIME (wasm: <code>application/wasm</code>, task/tflite: <code>application/octet-stream</code>).</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------- tiny HUD grid backdrop ----------
    const gridBG = document.getElementById('gridbg');
    const gb = gridBG.getContext('2d');
    function drawGrid(){
      const w = gridBG.width, h = gridBG.height;
      gb.clearRect(0,0,w,h);
      gb.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid') || '#1c2430';
      gb.lineWidth = 1;
      const step = 32;
      gb.beginPath();
      for(let x=0;x<=w;x+=step){ gb.moveTo(x,0); gb.lineTo(x,h); }
      for(let y=0;y<=h;y+=step){ gb.moveTo(0,y); gb.lineTo(w,y); }
      gb.stroke();
      // crosshair
      gb.strokeStyle = '#223041';
      gb.beginPath();
      gb.moveTo(w/2,0); gb.lineTo(w/2,h);
      gb.moveTo(0,h/2); gb.lineTo(w,h/2);
      gb.stroke();
    }
    drawGrid();
  </script>

  <script>
  // ---------- App state ----------
  const diagEl = document.getElementById('diag');
  const kv = (id,val,ok)=>{ const el=document.getElementById(id); el.textContent=val; el.className = ok ? 'ok' : (val==='—'?'muted':'bad'); };
  const log = (...a)=>{ diagEl.textContent += '\\n' + a.join(' '); diagEl.scrollTop = diagEl.scrollHeight; };
  const ok  = (t)=>{ log('✓', t); };
  const bad = (t)=>{ log('✗', t); };

  const stage = document.getElementById('stage');
  const overlay = document.getElementById('overlay');
  const s = stage.getContext('2d');
  const o = overlay.getContext('2d');
  const fileInput = document.getElementById('fileInput');
  const imgInfo = document.getElementById('imgInfo');

  const toggleMesh = document.getElementById('toggleMesh');
  const toggleIris = document.getElementById('toggleIris');
  const toggleAux  = document.getElementById('toggleAux');
  const toggleGrid = document.getElementById('toggleGrid');

  // resize overlay to match image ratio
  function fitCanvasTo(img){
    const maxW = stage.width, maxH = stage.height;
    const r = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight);
    const w = Math.round(img.naturalWidth * r);
    const h = Math.round(img.naturalHeight * r);
    // clear
    s.clearRect(0,0,stage.width,stage.height);
    o.clearRect(0,0,overlay.width,overlay.height);
    // center
    const x = Math.floor((stage.width - w)/2);
    const y = Math.floor((stage.height - h)/2);
    return {x,y,w,h};
  }

  // draw image
  function drawImageCentered(img,rect){
    s.fillStyle = '#000'; s.fillRect(0,0,stage.width, stage.height);
    s.drawImage(img, rect.x, rect.y, rect.w, rect.h);
  }

  // draw overlay features
  function drawOverlay(detections, rect){
    o.clearRect(0,0,overlay.width, overlay.height);
    if(!detections || !detections.faceLandmarks || detections.faceLandmarks.length===0) return;

    const meshColor = '#60f8e9';
    const irisColor = '#ff89f0';
    const auxColor  = '#ffd166';

    const faces = detections.faceLandmarks;
    // helpers map from normalized landmark -> canvas coords
    const toXY = (pt)=>({ 
      x: rect.x + pt.x * rect.w,
      y: rect.y + pt.y * rect.h
    });

    // Mesh points
    if (toggleMesh.checked){
      o.fillStyle = meshColor;
      faces.forEach(face=>{
        for (let i=0;i<face.length;i++){
          const p = toXY(face[i]);
          o.beginPath(); o.arc(p.x, p.y, 1.6, 0, Math.PI*2); o.fill();
        }
      });
    }
    // Iris (approx by drawing around eye landmarks if present)
    if (toggleIris.checked){
      o.strokeStyle = irisColor; o.lineWidth = 1.5;
      faces.forEach(face=>{
        // Common iris indices from MediaPipe iris (approx): 468.. — face model may include iris landmarks near the end
        const IRIS = [468,469,470,471,472].filter(i=>i<face.length);
        if (IRIS.length){
          const pts = IRIS.map(i=>toXY(face[i]));
          o.beginPath(); pts.forEach((p,idx)=> idx? o.lineTo(p.x,p.y): o.moveTo(p.x,p.y)); o.closePath(); o.stroke();
        }
      });
    }
    // Axes + guides
    if (toggleAux.checked){
      o.strokeStyle = auxColor; o.lineWidth=1;
      // bounds
      o.strokeRect(rect.x, rect.y, rect.w, rect.h);
      // thirds
      o.beginPath();
      o.moveTo(rect.x + rect.w/3, rect.y); o.lineTo(rect.x + rect.w/3, rect.y+rect.h);
      o.moveTo(rect.x + 2*rect.w/3, rect.y); o.lineTo(rect.x + 2*rect.w/3, rect.y+rect.h);
      o.moveTo(rect.x, rect.y + rect.h/3); o.lineTo(rect.x + rect.w, rect.y + rect.h/3);
      o.moveTo(rect.x, rect.y + 2*rect.h/3); o.lineTo(rect.x + rect.w, rect.y + 2*rect.h/3);
      o.stroke();
    }
  }

  // Blendshape gauges UI
  function renderBlendshapeGauges(categories){
    const host = document.getElementById('blendshapeGauges');
    host.innerHTML = '';
    if(!categories || !categories.length){ return; }
    // show top 8 strongest magnitudes
    const top = [...categories].sort((a,b)=>b.score-a.score).slice(0,8);
    for(const c of top){
      const div = document.createElement('div');
      div.className = 'gauge';
      const label = document.createElement('b');
      label.textContent = c.categoryName;
      const bar = document.createElement('div'); bar.className = 'bar';
      const fill = document.createElement('span'); fill.style.width = Math.round(c.score*100) + '%';
      bar.appendChild(fill);
      const pct = document.createElement('div'); pct.style.fontSize='12px'; pct.style.color='#cfe9ff';
      pct.textContent = (c.score*100).toFixed(1) + '%';
      div.appendChild(label); div.appendChild(bar); div.appendChild(pct);
      host.appendChild(div);
    }
  }

  // grid toggle
  toggleGrid.addEventListener('change', ()=>{
    document.getElementById('gridbg').style.display = toggleGrid.checked ? 'block':'none';
  });

  // ---------- MediaPipe (local-only) ----------
  const VISION_SRC = '/vendor/mediapipe/vision_bundle.js';
  const WASM_BASE = '/vendor/mediapipe/wasm';
  const FACE_MODEL = '/models/face_landmarker.task';

  let vision, FilesetResolver, FaceLandmarker, resolver, faceLandmarker;

  async function loadVisionLocal(){
    log('Loading vision bundle:', VISION_SRC);
    kv('kvBundle','/vendor/mediapipe/vision_bundle.js', false);
    const el = document.createElement('script');
    el.src = VISION_SRC; el.async = true;
    await new Promise((res,rej)=>{ el.onload=res; el.onerror=rej; document.head.appendChild(el); });
    if(!window.vision) throw new Error('window.vision undefined');
    vision = window.vision;
    ({ FilesetResolver, FaceLandmarker } = vision);
    ok('Vision bundle ✓'); kv('kvBundle','OK',true);
  }

  async function initFace(){
    if(!FilesetResolver) throw new Error('FilesetResolver missing');
    log('Resolving fileset… base:', WASM_BASE);
    kv('kvFileset', WASM_BASE, false);
    resolver = await FilesetResolver.forVisionTasks({ baseUrl: WASM_BASE });
    ok('FilesetResolver ✓'); kv('kvFileset','OK',true);

    log('Loading face model:', FACE_MODEL);
    kv('kvFaceModel', FACE_MODEL, false);
    faceLandmarker = await FaceLandmarker.createFromOptions(resolver, {
      baseOptions: { modelAssetPath: FACE_MODEL },
      outputFaceBlendshapes: true,
      runningMode: 'IMAGE',
      numFaces: 2
    });
    ok('FaceLandmarker ✓'); kv('kvFaceModel','OK',true);
  }

  async function bootstrap(){
    try{
      await loadVisionLocal();
      await initFace();
    }catch(e){
      bad('Init error: ' + (e && e.message || e));
      if((e+'').includes('<')) bad('You are likely receiving HTML for a binary path. Check 404/redirect/MIME.');
    }
  }

  bootstrap();

  // ---------- Image flow ----------
  fileInput.addEventListener('change', async (ev)=>{
    const f = ev.target.files && ev.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = async ()=>{
      const rect = fitCanvasTo(img);
      drawImageCentered(img, rect);
      imgInfo.textContent = `${img.naturalWidth}×${img.naturalHeight} · ${(f.size/1024).toFixed(1)} KB`;
      await runFace(img, rect);
    };
    img.src = URL.createObjectURL(f);
  });

  async function runFace(img, rect){
    if(!faceLandmarker){ bad('FaceLandmarker not ready'); return; }
    kv('kvInfer','—', false);
    try{
      const result = await faceLandmarker.detect(img);
      ok('Inference ✓'); kv('kvInfer','OK', true);

      const faces = result.faceLandmarks || [];
      drawOverlay({ faceLandmarks: faces }, rect);

      // blendshapes
      if(result.faceBlendshapes && result.faceBlendshapes.length){
        renderBlendshapeGauges(result.faceBlendshapes[0].categories);
      }else{
        renderBlendshapeGauges([]);
      }
    }catch(e){
      bad('Run error: ' + (e && e.message || e));
    }
  }
  </script>
</body>
</html>
