<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PF — ImageIntel (Load Fix • Canvas Guaranteed)</title>
<meta name="robots" content="noindex,nofollow"/>
<meta name="description" content="ImageIntel lab with resilient image loading. Pick an image and it will always render on the canvas and enable Next."/>
<style>
:root{
  --bg:#0b0f14; --ink:#d6f5ff; --edge:#232a33; --aqua:#64f2e3; --ok:#55d69a; --bad:#ff6b6b; --warn:#ffd166; --dim:#9db1bd;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
.wrap{max-width:1180px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;font-size:1.1rem}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);padding:6px 10px;border-radius:999px;background:#0b1117dd}
.ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .note{color:var(--dim)}
.btn{cursor:pointer;border:1.5px solid var(--aqua);background:#131922;color:#b8fff6;padding:8px 12px;border-radius:10px;font-weight:700}
.btn:hover{background:var(--aqua);color:#0e131a;border-color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.stepper{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
.step{border:1px solid var(--edge);border-radius:10px;padding:10px;background:#0f161f}
.step.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e333 inset}
.stage{position:relative;border:1px solid var(--edge);border-radius:12px;background:#0d131a;overflow:hidden}
.inner{position:relative;aspect-ratio:16/9}
canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
.legend{position:absolute;left:12px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap;z-index:3}
.tab-head{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.tab-head button{cursor:pointer;border:1px solid var(--edge);background:#0e141a;color:var(--ink);padding:8px 12px;border-radius:9px}
.tab-head button.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e333 inset}
.tab{display:none;margin-top:10px;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#0e141a}
.tab.active{display:block}
textarea.out{width:100%;min-height:120px;background:#0b1117;color:#d8faff;border:1px solid #1b242e;border-radius:8px;padding:10px}
.toastbox{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:5000}
.toast{background:#121823ee;border:1px solid var(--edge);color:#defaff;padding:10px 12px;border-radius:10px;min-width:220px;box-shadow:0 4px 18px #0006}
.diag{margin-top:12px;border:1px dashed var(--edge);padding:10px;border-radius:10px;background:#0c1117}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ImageIntel — Canvas Load Smoke-Tested</h1>

  <!-- Status -->
  <div class="row">
    <span class="badge">Init: <b id="initState">booting…</b></span>
    <span class="badge">Canvas: <b id="canvasState">—</b></span>
  </div>

  <!-- Stage -->
  <div class="stage">
    <div class="inner" id="pfm-stage">
      <canvas id="pfm-prev"></canvas>
      <canvas id="pfm-over"></canvas>
      <div class="legend"><span class="badge">faces: <span id="pfm-faceCount">0</span></span></div>
    </div>
  </div>

  <!-- Wizard -->
  <div class="stepper">
    <div class="step active" id="pfm-s1">
      <h3>Step 1 — Load</h3>
      <div class="row">
        <input id="pfm-file" type="file" accept="image/*"/>
        <button class="btn" id="pfm-demo">Load Demo</button>
        <button class="btn" id="pfm-next1" disabled>Next</button>
      </div>
      <div class="note">Pick any image. It will render immediately onto the canvas and stay visible.</div>
    </div>

    <div class="step" id="pfm-s2">
      <h3>Step 2 — Options</h3>
      <div class="row">
        <label><input type="checkbox" id="pfm-scanFace" checked> Face</label>
        <label><input type="checkbox" id="pfm-scanBody"> Body</label>
        <label><input type="checkbox" id="pfm-scanNSFW"> NSFW</label>
      </div>
      <div class="row">
        <button class="btn" id="pfm-preview">Preview Overlay</button>
        <button class="btn" id="pfm-next2">Next</button>
      </div>
    </div>

    <div class="step" id="pfm-s3">
      <h3>Step 3 — Cloud (optional)</h3>
      <div class="row">
        <label><input type="checkbox" id="pfm-useCloud"> HuggingFace</label>
        <input id="pfm-hfToken" placeholder="hf_... token" style="min-width:320px;border:1px solid var(--edge);background:#0f141a;color:#fff;padding:6px 10px;border-radius:8px">
        <button class="btn" id="pfm-run">Run Analysis</button>
      </div>
    </div>

    <div class="step" id="pfm-s4">
      <h3>Step 4 — Results</h3>
      <div class="row" id="pfm-faceSelector"></div>
      <div class="row">
        <button class="btn" id="pfm-copySFW" disabled>Copy SFW</button>
        <button class="btn" id="pfm-copyNSFW" disabled>Copy NSFW</button>
        <button class="btn" id="pfm-exportJSON" disabled>Export JSON</button>
        <button class="btn" id="pfm-rerun">Re-Run</button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-head">
    <button class="active" data-tab="sfw">SFW Prompt</button>
    <button data-tab="nsfw">NSFW Prompt</button>
    <button data-tab="meas">Measurements</button>
    <button data-tab="json">JSON</button>
    <button data-tab="diag">Diagnostics</button>
  </div>
  <div id="tab_sfw" class="tab active"><textarea id="pfm-outSFW" class="out" readonly></textarea></div>
  <div id="tab_nsfw" class="tab"><textarea id="pfm-outNSFW" class="out" readonly></textarea></div>
  <div id="tab_meas" class="tab"><textarea id="pfm-outMeas" class="out" readonly></textarea></div>
  <div id="tab_json" class="tab"><textarea id="pfm-outJson" class="out" readonly></textarea></div>
  <div id="tab_diag" class="tab">
    <div class="diag">
      <div class="kv">
        <div>UA:</div><div id="pfm-ua"></div>
        <div>Stage size:</div><div id="pfm-stageSz">—</div>
        <div>Canvas size:</div><div id="pfm-canvasSz">—</div>
        <div>Last event:</div><div id="pfm-last">ready</div>
        <div>Notes:</div><div class="note">If stage reports width 0, we fall back to 960×540 so drawing never silently fails.</div>
      </div>
    </div>
  </div>
</div>

<div class="toastbox" id="pfm-toastbox"></div>

<script type="module">
(() => {
  /* ======= tiny helpers ======= */
  const $ = (id) => document.getElementById(id);
  const toastbox = $('pfm-toastbox');
  const toast = (msg) => { const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toastbox.appendChild(d); setTimeout(()=>d.remove(),2600); };

  $('pfm-ua').textContent = navigator.userAgent;
  const setLast = (t) => { const el=$('pfm-last'); if(el) el.textContent=String(t); };

  /* ======= canvas sizing with fallback ======= */
  const stage = $('pfm-stage');
  const cPrev = $('pfm-prev');
  const cOver = $('pfm-over');
  const ctxPrev = cPrev.getContext('2d',{willReadFrequently:true});
  const ctxOver = cOver.getContext('2d');

  function sizeCanvases() {
    const r = stage.getBoundingClientRect();
    // If width is 0 (layout not settled), use a safe fallback
    const W = Math.max(1, Math.round(r.width || 960));
    const H = Math.max(1, Math.round(r.height || Math.round(W * 9/16)));
    cPrev.width = cOver.width = W;
    cPrev.height= cOver.height= H;
    cPrev.style.width = cOver.style.width = W+'px';
    cPrev.style.height= cOver.style.height= H+'px';
    const cs = `${W}×${H}`;
    const st = `${Math.round(r.width||0)}×${Math.round(r.height||0)}`;
    const csEl=$('pfm-canvasSz'); if(csEl) csEl.textContent=cs;
    const stEl=$('pfm-stageSz'); if(stEl) stEl.textContent=st;
    $('canvasState').textContent = (W>1 && H>1) ? 'ready' : 'zero';
  }
  sizeCanvases();
  new ResizeObserver(sizeCanvases).observe(stage);
  window.addEventListener('resize', sizeCanvases, {passive:true});

  /* ======= image draw (bullet-proof) ======= */
  let currentImage = null;
  let imgFit = null;

  function drawImageLetterbox(img){
    const W=cPrev.width, H=cPrev.height;
    ctxPrev.clearRect(0,0,W,H);
    if(!img?.naturalWidth || !img?.naturalHeight) return;
    const r=Math.min(W/img.naturalWidth, H/img.naturalHeight);
    const dw=Math.max(1, Math.round(img.naturalWidth*r));
    const dh=Math.max(1, Math.round(img.naturalHeight*r));
    const dx=Math.round((W-dw)/2);
    const dy=Math.round((H-dh)/2);
    ctxPrev.imageSmoothingEnabled=true;
    ctxPrev.imageSmoothingQuality='high';
    ctxPrev.drawImage(img, dx,dy,dw,dh);
    imgFit={W,H,dx,dy,dw,dh};
    setLast(`draw ${dw}×${dh} at ${dx},${dy}`);
  }

  function enableNext(){
    const btn=$('pfm-next1'); if(btn){ btn.disabled=false; btn.classList.remove('disabled'); }
  }

  function loadFromFile(file){
    if(!file){ toast('No file'); return; }
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        currentImage = img;
        // ensure canvas has a size before draw
        sizeCanvases();
        drawImageLetterbox(img);
        enableNext();
        toast('Image loaded to canvas.');
        setLast('file->image onload OK');
      };
      img.onerror = () => { toast('Image failed to decode'); setLast('image decode error'); };
      img.src = reader.result;
    };
    reader.onerror = () => { toast('File read error'); setLast('file read error'); };
    reader.readAsDataURL(file);
  }

  $('pfm-file').addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    loadFromFile(f);
  });

  // small embedded demo to verify path
  const demoPng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANAAAADQCAYAAAD3QmL4AAAACXBIWXMAAAsSAAALEgHS3X78AAABc0lEQVR4nO3TwQmDQBQF0eT9T2iZgQq3Zy7y1qkH1bYw+5h4v5yKp1lGgAAAAAAAAAAAAAAAPzXr8nqGk9i2y3bG2wqk9gRz8yVwz5w7k1m0t0b3m4v0bq9wq3g5w4e3Qv6wz7P3vTgPpJkAAJ4w0n8C3q7v9v0FJr7nYt9b3x2cW3O2mXxg7iB9cT9cQ9cT9cQ9cT9cQ9cT9cQ9cT9cQ9cT9cQ9cT9cQ9cT9cQ9cT9cQ+eGgAA+S9cFf7r+f3bJrS6cV7fNw9u8s7xw7v+f2C6v7p/8eZ7c4+f3b8v7n+DDkAAE9h8gMAAHyGAgAAfIYCAAB8hgIAAHyGAgAAfIYCAAB8hgIAAHyGAgAAfIYCAAB8hgIAAHyGAgAAfIYCAAB8hgIAAHyGAoB1B/0iJ7o9J0c9AAAAAElFTkSuQmCC";
  $('pfm-demo').addEventListener('click', ()=>{
    const img = new Image();
    img.onload = () => { currentImage=img; sizeCanvases(); drawImageLetterbox(img); enableNext(); toast('Demo image loaded.'); };
    img.src = demoPng;
  });

  /* ======= simple step nav (keeps canvas visible) ======= */
  function setStep(n){
    ['pfm-s1','pfm-s2','pfm-s3','pfm-s4'].forEach((id,i)=>{
      const el=$(id); if(el) el.classList.toggle('active', (i+1)===n);
    });
    if(currentImage){ sizeCanvases(); drawImageLetterbox(currentImage); }
  }
  setStep(1);
  $('pfm-next1').addEventListener('click', ()=> setStep(2));
  $('pfm-next2').addEventListener('click', ()=> setStep(3));
  $('pfm-rerun').addEventListener('click', ()=> setStep(2));

  /* ======= tabs ======= */
  document.querySelectorAll('.tab-head button').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab-head button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      const t = document.getElementById('tab_'+b.dataset.tab);
      if(t) t.classList.add('active');
    });
  });

  /* ======= placeholders for later analysis; do not block load ======= */
  $('initState').textContent='ready';
  $('canvasState').textContent='ready';
  $('pfm-preview').addEventListener('click', ()=>{
    if(!currentImage){ toast('Load image first.'); return; }
    // keep overlay clear for now; this button just proves image persists
    ctxOver.clearRect(0,0,cOver.width,cOver.height);
    toast('Preview OK — image still on canvas');
  });
  $('pfm-run').addEventListener('click', ()=>{
    if(!currentImage){ toast('Load image first.'); return; }
    setStep(4);
    $('pfm-outSFW').value = 'SFW prompt will appear here.';
    $('pfm-outJson').value = JSON.stringify({ok:true, imgFit}, null, 2);
    $('pfm-copySFW').disabled=false; $('pfm-exportJSON').disabled=false;
    toast('Analysis stub ran (image remained visible).');
  });
  $('pfm-copySFW').addEventListener('click', ()=>navigator.clipboard.writeText($('pfm-outSFW').value||'').then(()=>toast('Copied SFW')));
  $('pfm-copyNSFW').addEventListener('click', ()=>navigator.clipboard.writeText($('pfm-outNSFW').value||'').then(()=>toast('Copied NSFW')));
  $('pfm-exportJSON').addEventListener('click', ()=>{
    const blob=new Blob([$('pfm-outJson').value||'{}'],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='imageintel.json'; document.body.appendChild(a); a.click();
    setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},150);
  });
})();
</script>
</body>
</html>
