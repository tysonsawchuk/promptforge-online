<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ImageIntel — local Human (face+pose+segments)</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f1621;--ink:#e9fbff;--mut:#9fb3c0;--aqua:#64f2e3;--lime:#6dffb8;--mag:#ff5ad6;--gold:#ffd166;--red:#ff6b6b}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  h1{margin:0 0 8px;font-size:1.1rem}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#172335;border:1px solid #2a3a50;color:var(--aqua);padding:8px 12px;border-radius:9px;font-weight:700;cursor:pointer}
  .btn:hover{border-color:#3b5678;background:#1a2b43}
  .input{background:#0f1621;border:1px solid #233044;color:#bfefff;border-radius:8px;padding:8px 10px;min-width:240px}
  .stage{position:relative;display:inline-block;max-width:100%}
  .stage img{display:block;max-width:100%;height:auto;border-radius:10px;border:1px solid #1b2531}
  canvas.overlay{position:absolute;left:0;top:0;pointer-events:none}
  .term{background:#071019;border:1px solid #193047;border-radius:10px;padding:10px;height:210px;overflow:auto;white-space:pre-wrap;font-family:ui-monospace,Consolas,Menlo,monospace}
  .kv{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#0e1722;border:1px solid #243246;color:#9ad7ff;font-size:.8rem}
  .panel{background:#0e1520;border:1px solid #1c2b3f;border-radius:10px;padding:10px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ImageIntel — local Human (alpha)</h1>
  <div class="row">
    <input id="fileInput" type="file" accept="image/*" class="input"/>
    <button class="btn" id="btnAnalyze">Analyze</button>
    <button class="btn" id="btnClear">Clear</button>
    <button class="btn" id="btnGrid">Test Grid</button>
    <button class="btn" id="btnSelfTest">Self-Test</button>
  </div>
  <div class="kv">
    <span class="pill">DPR: <span id="kDpr">–</span></span>
    <span class="pill">Image: <span id="kImg">–</span></span>
    <span class="pill">Canvas: <span id="kCan">–</span></span>
    <span class="pill">Engine: <span id="kEng">–</span></span>
  </div>

  <div class="stage" style="margin-top:10px">
    <img id="imgEl" alt="preview" decoding="async" loading="eager"/>
    <canvas id="cv" class="overlay"></canvas>
  </div>

  <div class="panel"><div id="term" class="term"></div></div>
  <div class="panel" id="outPrompt" style="display:none"></div>
  <div class="panel" id="outJSON" style="display:none; white-space:pre-wrap"></div>
</div>

<!-- Load local Human bundle (no CDN) -->
<script src="/vendor/human/human.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const imgEl=$('#imgEl'); const cv=$('#cv'); const term=$('#term');
  const DPR=Math.max(1,window.devicePixelRatio||1); $('#kDpr').textContent=DPR.toFixed(2);

  let human=null;

  function log(msg, lvl='log'){
    const d=document.createElement('div');
    d.textContent=msg;
    d.style.color = lvl==='err'?'#ff6b6b':(lvl==='warn'?'#ffd166':'#bff3ff');
    term.appendChild(d); term.scrollTop=term.scrollHeight;
    try{ console[lvl==='err'?'error':lvl==='warn'?'warn':'log'](msg); }catch{}
  }

  async function headOK(url){
    try{
      const r=await fetch(url,{method:'HEAD'}); return r.ok;
    }catch{ return false; }
  }

  async function selfTest(){
    log('— Self-Test —');
    const paths=[
      '/vendor/human/human.js',
      '/models/human/face/face-detection-short-range.json',
      '/models/human/body/movenet-lightning.json',
      '/models/human/segmentation/selfie_segmentation_landscape.json',
      '/models/human/object/ssd_mobilenetv1.json'
    ];
    for(const p of paths){
      const ok = await headOK(p);
      log((ok?'OK  ':'X   ')+p, ok?'log':'err');
    }
  }

  function fitCanvas(){
    if(!imgEl.naturalWidth) return;
    const r=imgEl.getBoundingClientRect();
    cv.style.width=r.width+'px'; cv.style.height=r.height+'px';
    cv.width=Math.max(1,Math.round(r.width*DPR));
    cv.height=Math.max(1,Math.round(r.height*DPR));
    const ctx=cv.getContext('2d'); ctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.clearRect(0,0,cv.width,cv.height);
    $('#kImg').textContent=imgEl.naturalWidth+'×'+imgEl.naturalHeight;
    $('#kCan').textContent=Math.round(cv.width/DPR)+'×'+Math.round(cv.height/DPR);
  }
  addEventListener('resize', ()=>{ if(imgEl.naturalWidth) fitCanvas(); }, {passive:true});

  $('#fileInput').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f){ log('no file','warn'); return; }
    const url=URL.createObjectURL(f);
    imgEl.onload=()=>{ URL.revokeObjectURL(url); fitCanvas(); log(`image loaded ${imgEl.naturalWidth}×${imgEl.naturalHeight}`); };
    imgEl.onerror=()=>{ log('image failed to load','err'); };
    imgEl.crossOrigin='anonymous';
    imgEl.src=url;
  });

  $('#btnGrid').addEventListener('click', ()=>{
    if(!imgEl.naturalWidth){ log('load image first','warn'); return; }
    const ctx=cv.getContext('2d'); const w=cv.width/DPR,h=cv.height/DPR;
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.strokeStyle='#64f2e380';
    for(let x=0;x<w;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=0;y<h;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    ctx.fillStyle='#ff5ad6'; ctx.font='12px ui-monospace'; ctx.fillText('grid ok',10,20);
    log('grid drawn ✓');
  });

  $('#btnSelfTest').addEventListener('click', selfTest);

  async function ensureHuman(){
    if (human) return true;
    if (!window.Human){ log('Human bundle not found at /vendor/human/human.js','err'); return false; }
    try{
      const cfg={
        backend:'webgl',
        modelBasePath:'/models/human', // LOCAL models
        face:{enabled:true, mesh:{enabled:true}, iris:{enabled:true}, detector:{maxDetected:1}},
        body:{enabled:true, model:'movenet', maxDetections:1},
        segmentation:{enabled:true, person:true, resolution:256},
        object:{enabled:true, model:'mobilenet', skipAllowed:true},
        debug:false
      };
      human = new window.Human.Human(cfg);
      await human.load(); log('models loaded ✓');
      await human.warmup(); log('warmup ✓');
      $('#kEng').textContent='Human (local)';
      return true;
    }catch(e){
      log('Human init failed: '+(e?.message||e),'err');
      return false;
    }
  }

  function drawOverlay(result){
    const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
    // face
    for(const face of result.face||[]){
      if(face.mesh){
        ctx.fillStyle='rgba(100,240,255,0.95)';
        for(const p of face.mesh){ ctx.beginPath(); ctx.arc(p[0],p[1],1.2,0,Math.PI*2); ctx.fill(); }
      }
      if(face.box){ const [x,y,w,h]=face.box; ctx.strokeStyle='#64f2e3'; ctx.lineWidth=1.2; ctx.strokeRect(x,y,w,h); }
    }
    // pose
    for(const body of result.body||[]){
      const kp=body.keypoints||[]; ctx.strokeStyle='#6dffb8'; ctx.fillStyle='#6dffb8'; ctx.lineWidth=2;
      const C=(a,b)=>{ if(kp[a]?.score>0.3&&kp[b]?.score>0.3){ ctx.beginPath(); ctx.moveTo(kp[a].x,kp[a].y); ctx.lineTo(kp[b].x,kp[b].y); ctx.stroke(); } };
      C(5,7); C(7,9); C(6,8); C(8,10); C(11,13); C(13,15); C(12,14); C(14,16); C(5,6); C(5,11); C(6,12); C(11,12);
      kp.forEach(k=>{ if(k.score>0.3){ ctx.beginPath(); ctx.arc(k.x,k.y,2,0,Math.PI*2); ctx.fill(); } });
    }
    // segmentation
    if(result.segmentation?.data){
      const {width,height,data}=result.segmentation;
      const id=ctx.createImageData(width,height);
      for(let i=0;i<width*height;i++){ const a=data[i]; id.data[i*4+0]=255; id.data[i*4+1]=120; id.data[i*4+2]=120; id.data[i*4+3]=a?60:0; }
      const tmp=document.createElement('canvas'); tmp.width=width; tmp.height=height;
      tmp.getContext('2d').putImageData(id,0,0);
      ctx.drawImage(tmp,0,0,cv.width/(window.devicePixelRatio||1),cv.height/(window.devicePixelRatio||1));
    }
    // objects
    if(result.object?.length){
      ctx.strokeStyle='#ff5ad6'; ctx.fillStyle='#ff5ad6'; ctx.lineWidth=2; ctx.font='12px ui-monospace';
      for(const o of result.object){ if(!o.box) continue; const [x,y,w,h]=o.box; ctx.strokeRect(x,y,w,h); ctx.fillText(`${o.label} ${(o.score*100|0)}%`, x, y-4); }
    }
  }

  function avgColor(ctx, box){
    const [x,y,w,h]=box.map(v=>Math.max(0,Math.round(v)));
    if (w<2||h<2) return {word:'unknown'};
    const data=ctx.getImageData(x,y,w,h).data; let r=0,g=0,b=0,n=0;
    for(let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; n++; }
    if(!n) return {word:'unknown'};
    r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
    if (r>200 && g>180 && b<140) return {word:'blonde'};
    if (r<70&&g<70&&b<70) return {word:'black'};
    if (r>200&&g>200&&b>200) return {word:'pale'};
    if (g>r && g>b) return {word:'olive'};
    if (r>g && r>b) return {word:'auburn'};
    return {word:'tan'};
  }

  function computeAttrs(result){
    const tmp=document.createElement('canvas');
    const r=imgEl.getBoundingClientRect(); tmp.width=Math.round(r.width); tmp.height=Math.round(r.height);
    const cx=tmp.getContext('2d'); cx.drawImage(imgEl,0,0,tmp.width,tmp.height);

    let faceShape='unknown', eyeTilt=0, hairWord='unknown', eyeWord='unknown', skinWord='unknown', cameraAngle='frontal', lighting='unknown', bgTag='unknown';
    const f=result.face?.[0];
    if(f?.box){
      const [x,y,w,h]=f.box;
      hairWord=avgColor(cx,[x+w*0.2, Math.max(0,y-h*0.2), w*0.6, h*0.15]).word;
      skinWord=avgColor(cx,[x+w*0.3, y+h*0.45, w*0.4, h*0.2]).word;
      eyeWord =avgColor(cx,[x+w*0.35, y+h*0.28, w*0.3, h*0.1]).word;
      const wh=w/Math.max(1,h); faceShape=wh<0.75?'long':(wh>0.9?'round':'oval');
    }
    if(f?.annotations?.leftEyeUpper0 && f?.annotations?.rightEyeUpper0){
      const L=f.annotations.leftEyeUpper0[0], R=f.annotations.rightEyeUpper0.slice(-1)[0];
      eyeTilt=+(Math.atan2((R[1]-L[1]),(R[0]-L[0]))*180/Math.PI).toFixed(1);
    }
    const objs=result.object||[];
    if (objs.length){
      const set=new Set(objs.map(o=>o.label));
      if (set.has('chair')||set.has('couch')) bgTag='indoor';
      else if (set.has('car')||set.has('bicycle')) bgTag='street';
      else bgTag=[...set].slice(0,3).join('/');
    }
    // quick lighting
    (()=>{
      const data=cx.getImageData(0,0,tmp.width,tmp.height).data; let lum=0;
      for(let i=0;i<data.length;i+=4){ lum+= (0.2126*data[i]+0.7152*data[i+1]+0.0722*data[i+2]); }
      lum/= (data.length/4);
      lighting = lum>180?'bright studio': lum<60?'low / moody':'natural soft';
    })();

    return {faceShape,eyeTilt,hairWord,eyeWord,skinWord,cameraAngle,lighting,bgTag};
  }

  function buildPrompts(attr){
    const sfw=['portrait photo',`${attr.faceShape} face`,`eye tilt ${attr.eyeTilt}°`,
               `${attr.hairWord} hair, ${attr.eyeWord} eyes, ${attr.skinWord} skin`,
               `${attr.cameraAngle}, ${attr.lighting}, ${attr.bgTag}`,
               'photorealistic, sharp micro-detail, minimal distortion'].join(', ');
    const negative='lowres, bad anatomy, extra limbs, deformed hands, oversharpen, cartoonish, unrealistic skin, fused features, duplicate face';
    return {sfw,negative};
  }

  $('#btnAnalyze').addEventListener('click', async ()=>{
    if(!imgEl.naturalWidth){ log('load an image first','warn'); return; }
    const ok = await ensureHuman(); if(!ok) return;
    const t0=performance.now();
    const result=await human.detect(imgEl);
    log(`detect ${(performance.now()-t0|0)}ms faces:${result.face?.length||0} body:${result.body?.length||0} objs:${result.object?.length||0} seg:${result.segmentation?'1':'0'}`);
    drawOverlay(result);
    const a=computeAttrs(result); const p=buildPrompts(a);
    const outP=$('#outPrompt'), outJ=$('#outJSON');
    outP.style.display='block'; outJ.style.display='block';
    outP.textContent=`SFW (Replica)\n${p.sfw}\n\nNegative\n${p.negative}`;
    const j={version:'pf_imageintel_v4', image:{natural:{w:imgEl.naturalWidth,h:imgEl.naturalHeight}},
             face:{shape:a.faceShape,angles:{eye_tilt_deg:a.eyeTilt},palette:{hair_word:a.hairWord,eyes_word:a.eyeWord,skin_word:a.skinWord}},
             scene:{bgTag:a.bgTag,lighting:a.lighting,camera_angle:a.cameraAngle}};
    outJ.textContent=JSON.stringify(j,null,2);
  });

  $('#btnClear').addEventListener('click', ()=>{
    cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
    $('#outPrompt').style.display='none'; $('#outJSON').style.display='none';
  });

  // boot note
  if (window.Human){ $('#kEng').textContent='Human (pending init)'; } else { $('#kEng').textContent='not loaded'; }
  log('Ready. Step 1: choose an image. Step 2: Self-Test. Step 3: Analyze.');
})();
</script>
</body>
</html>
