<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PF — ImageIntel Pro Visor (Fixed Mesh Alignment)</title>
<meta name="robots" content="noindex,nofollow"/>
<style>
:root{--bg:#0b0f14;--ink:#eaf9ff;--dim:#93a8b5;--edge:#22303b;--aqua:#64f2e3;--vio:#be9cff;--pink:#ff78a0;--ok:#55d69a;--bad:#ff6b6b}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
.wrap{max-width:1240px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--edge);padding:6px 10px;border-radius:999px;background:#0d141add}
.ok{color:var(--ok)} .bad{color:var(--bad)}
.btn{cursor:pointer;border:1.5px solid var(--aqua);background:#131a22;color:#b8fff6;padding:8px 12px;border-radius:10px;font-weight:700}
.btn:disabled{opacity:.5;cursor:not-allowed}
.stage{position:relative;border:1px solid var(--edge);border-radius:12px;background:#0e151d;overflow:hidden}
.inner{position:relative;width:100%;aspect-ratio:16/9}
#img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;user-select:none;-webkit-user-drag:none}
canvas{position:absolute;inset:0;pointer-events:none}
#mesh{filter:drop-shadow(0 0 9px #64f2e344)}
#pose{mix-blend-mode:screen}
#seg{mix-blend-mode:screen}
.legend{position:absolute;left:12px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap;z-index:10}
.hl{position:absolute;padding:2px 6px;border-radius:6px;font-size:.8rem;background:#0f2130cc;border:1px solid #2a3a46;color:#c8f6ff}
.stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0}
.step{border:1px solid var(--edge);border-radius:10px;padding:10px;background:#0f161f}
.step.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e333 inset}
.option{display:flex;gap:8px;align-items:center;margin:6px 0}
input[type="range"]{accent-color:var(--aqua)}
.cols{display:grid;grid-template-columns:1fr 380px;gap:12px}
.term{background:#070c12;border:1px solid #14202b;border-radius:10px;padding:10px;min-height:260px;color:#bfeaff;max-height:420px;overflow:auto}
.term pre{margin:0;white-space:pre-wrap;line-height:1.25}
.tabs{margin-top:14px}
.tab-head{display:flex;gap:8px;flex-wrap:wrap}
.tab-head button{cursor:pointer;border:1px solid var(--edge);background:#0e141a;color:#fff;padding:8px 12px;border-radius:9px}
.tab-head button.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e333 inset}
.tab{display:none;margin-top:10px;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#0e141a}
.tab.active{display:block}
textarea.out{width:100%;min-height:140px;background:#0b1117;color:#d8faff;border:1px solid #1b242e;border-radius:8px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ImageIntel Pro Visor — Face • Pose • Segments • NSFW • Cloud</h1>

  <div class="row">
    <span class="badge">Status: <b id="status">booting…</b></span>
    <span class="badge">Bundle: <b id="bundle">—</b></span>
    <span class="badge">Models: <b id="models">—</b></span>
  </div>

  <div class="stage">
    <div class="inner" id="stage">
      <img id="img" alt=""/>
      <canvas id="mesh"></canvas> <!-- face -->
      <canvas id="pose"></canvas> <!-- pose -->
      <canvas id="seg"></canvas>  <!-- segmentation -->
      <div class="legend">
        <span class="badge">faces: <span id="faceCount">0</span></span>
        <span class="badge">pose: <span id="poseState">off</span></span>
      </div>
    </div>
  </div>

  <div class="stepper">
    <div class="step active" id="st1">
      <h3>Step 1 — Load</h3>
      <div class="option">
        <input id="file" type="file" accept="image/*"/>
        <button class="btn" id="demo">Load Demo</button>
      </div>
      <div class="row"><button class="btn" id="to2" disabled>Next</button></div>
    </div>
    <div class="step" id="st2">
      <h3>Step 2 — Options</h3>
      <div class="option"><input type="checkbox" id="optFace" checked> <label for="optFace">Face mesh (468 tessellation)</label></div>
      <div class="option"><input type="checkbox" id="optPose" checked> <label for="optPose">Body pose (33 joints)</label></div>
      <div class="option"><input type="checkbox" id="optSeg" checked> <label for="optSeg">People-part segmentation</label></div>
      <div class="row">
        <button class="btn" id="preview" disabled>Preview Overlay</button>
      </div>
    </div>
    <div class="step" id="st3">
      <h3>Step 3 — Cloud Assist (optional)</h3>
      <div class="option"><input type="checkbox" id="useCloud"> <label for="useCloud">Hugging Face (caption/objects)</label></div>
      <div class="option"><input id="hfToken" type="text" placeholder="hf_... token"/></div>
      <div class="row"><button class="btn" id="run" disabled>Run Analysis</button></div>
    </div>
  </div>

  <div class="cols">
    <div>
      <div class="tabs">
        <div class="tab-head">
          <button class="active" data-tab="sfw">SFW Prompt</button>
          <button data-tab="nsfw">NSFW Prompt</button>
          <button data-tab="json">JSON</button>
        </div>
        <div class="tab active" id="tab_sfw"><textarea id="outSFW" class="out" readonly></textarea></div>
        <div class="tab" id="tab_nsfw"><textarea id="outNSFW" class="out" readonly></textarea></div>
        <div class="tab" id="tab_json"><textarea id="outJSON" class="out" readonly></textarea></div>
      </div>
    </div>
    <div class="term"><pre id="termOut"><span class="dim">[boot]</span> ImageIntel visor starting…</pre></div>
  </div>
</div>

<script type="module">
/* -------- Imports (pinned) -------- */
import { FilesetResolver, FaceLandmarker, PoseLandmarker, ImageSegmenter, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs";

/* -------- DOM -------- */
const $=(q,p=document)=>p.querySelector(q), $$=(qa,p=document)=>Array.from(p.querySelectorAll(qa));
const statusEl=$("#status"), bundleEl=$("#bundle"), modelsEl=$("#models");
const stage=$("#stage"), img=$("#img");
const mesh=$("#mesh"), poseC=$("#pose"), segC=$("#seg");
let mctx=mesh.getContext('2d'), pctx=poseC.getContext('2d'), sctx=segC.getContext('2d');
const file=$("#file"), demo=$("#demo"), to2=$("#to2"), preview=$("#preview"), run=$("#run");
const optFace=$("#optFace"), optPose=$("#optPose"), optSeg=$("#optSeg");
const faceCountEl=$("#faceCount"), poseStateEl=$("#poseState");
const outSFW=$("#outSFW"), outNSFW=$("#outNSFW"), outJSON=$("#outJSON");
const print=(s,c='')=>{ const pre=$("#termOut"); pre.innerHTML += "\\n" + (c?`<span class="${c}">${s}</span>`:s); pre.parentElement.scrollTop=pre.parentElement.scrollHeight; };

/* -------- DPR-safe canvas sizing locked to <img> box -------- */
let imgBox={x:0,y:0,w:0,h:0}, DU=null;
function sizeCanvasToImg(){
  const ri=img.getBoundingClientRect(), rs=stage.getBoundingClientRect();
  imgBox={ x:Math.round(ri.left-rs.left), y:Math.round(ri.top-rs.top), w:Math.round(ri.width), h:Math.round(ri.height) };
  const dpr=Math.min(devicePixelRatio||1,2);
  [mesh,poseC,segC].forEach((c)=>{
    c.style.left=imgBox.x+"px"; c.style.top=imgBox.y+"px";
    c.style.width=imgBox.w+"px"; c.style.height=imgBox.h+"px";
    c.width=Math.max(1,Math.round(imgBox.w*dpr));
    c.height=Math.max(1,Math.round(imgBox.h*dpr));
  });
  // reset contexts & DPR transform
  mctx=mesh.getContext('2d'); pctx=poseC.getContext('2d'); sctx=segC.getContext('2d');
  mctx.setTransform(dpr,0,0,dpr,0,0);
  pctx.setTransform(dpr,0,0,dpr,0,0);
  sctx.setTransform(dpr,0,0,dpr,0,0);
  DU=new DrawingUtils(mctx); // re-create after resize (critical)
}
new ResizeObserver(sizeCanvasToImg).observe(stage);
addEventListener("scroll",()=>{ if(img.src){ sizeCanvasToImg(); drawNow(); } },{passive:true});

/* -------- Init models -------- */
let face=null, pose=null, seg=null;
let faceRes=null, poseRes=null, segRes=null;

(async()=>{
  try{
    statusEl.textContent="loading…"; print("$ init","prompt");
    const fs=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
    bundleEl.innerHTML='<span class="ok">OK</span>';
    face=await FaceLandmarker.createFromOptions(fs,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task"},runningMode:"IMAGE",numFaces:5});
    pose=await PoseLandmarker.createFromOptions(fs,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"},runningMode:"IMAGE"});
    seg=await ImageSegmenter.createFromOptions(fs,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_multiclass_256x256/float32/latest/selfie_multiclass_256x256.tflite"},runningMode:"IMAGE",outputCategoryMask:true});
    modelsEl.innerHTML='<span class="ok">OK</span>'; statusEl.textContent="ready"; print("models ready","ok");
  }catch(e){ modelsEl.innerHTML='<span class="bad">error</span>'; statusEl.textContent="init failed"; print(String(e),"err"); }
})();

/* -------- Load image -------- */
function enable(){ preview.disabled=false; run.disabled=false; to2.disabled=false; }
file.addEventListener("change",()=>{
  const f=file.files?.[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  img.onload=()=>{ sizeCanvasToImg(); enable(); print(`loaded: ${f.name}  ${img.naturalWidth}x${img.naturalHeight}`,"ok"); URL.revokeObjectURL(url); };
  img.src=url; img.alt=f.name||"image";
});
demo.addEventListener("click",()=>{
  img.onload=()=>{ sizeCanvasToImg(); enable(); print("demo portrait loaded","ok"); };
  img.crossOrigin="anonymous"; img.src="https://storage.googleapis.com/mediapipe-assets/portrait.jpg";
});
to2.addEventListener("click",()=>{ /* nothing extra; just unlock preview */ });

/* -------- Draw helpers -------- */
function clearAll(){ mctx.clearRect(0,0,mesh.width,mesh.height); pctx.clearRect(0,0,poseC.width,poseC.height); sctx.clearRect(0,0,segC.width,segC.height); $$(".hl",stage).forEach(n=>n.remove()); }
function label(x,y,t){ const el=document.createElement('div'); el.className='hl'; el.textContent=t; el.style.left=(imgBox.x+x)+"px"; el.style.top=(imgBox.y+y)+"px"; stage.appendChild(el); }

/* -------- Face mesh (authentic MP style) -------- */
function drawFace(){
  if(!optFace.checked || !faceRes?.faceLandmarks?.length) return;
  for(const lm of faceRes.faceLandmarks){
    DU.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_TESSELLATION, {color:"rgba(100,242,227,.42)", lineWidth:1});
    DU.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_FACE_OVAL,   {color:"rgba(140,255,220,.98)", lineWidth:2});
    DU.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE,   {color:"#ffffff", lineWidth:2});
    DU.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE,    {color:"#ffffff", lineWidth:2});
    DU.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_LIPS,        {color:"rgba(255,120,160,.98)", lineWidth:2});
    DU.drawLandmarks(lm, {radius:2, color:"#be9cff"}); // dotted keypoints
    const R=k=>({x:lm[k].x*mesh.width/Math.min(devicePixelRatio||1,2), y:lm[k].y*mesh.height/Math.min(devicePixelRatio||1,2)});
    label(R(10).x+6,R(10).y-10,"brow"); label(R(13).x+6,R(13).y-10,"lips"); label(R(152).x+6,R(152).y+4,"jaw");
  }
}

/* -------- Pose skeleton -------- */
const CHAINS=[[11,13,15],[12,14,16],[11,12],[23,24],[11,23],[12,24],[23,25,27],[24,26,28]];
function drawPose(){
  if(!optPose.checked || !poseRes?.landmarks?.length) return;
  const lm=poseRes.landmarks[0];
  pctx.save(); pctx.strokeStyle="rgba(190,156,255,.95)"; pctx.lineWidth=2.2; pctx.beginPath();
  const P=i=>[lm[i].x*poseC.width/Math.min(devicePixelRatio||1,2), lm[i].y*poseC.height/Math.min(devicePixelRatio||1,2)];
  for(const chain of CHAINS){ for(let i=0;i<chain.length-1;i++){ const [x1,y1]=P(chain[i]), [x2,y2]=P(chain[i+1]); pctx.moveTo(x1,y1); pctx.lineTo(x2,y2); } }
  pctx.stroke(); pctx.restore();
  const S=P(11), R=P(12), H1=P(23), H2=P(24);
  label((S[0]+R[0])/2-28,(S[1]+R[1])/2-8,"shoulders");
  label((H1[0]+H2[0])/2-14,(H1[1]+H2[1])/2-6,"hips");
}

/* -------- Segmentation (hair / face-skin / body-skin / clothes) -------- */
function drawSeg(){
  if(!optSeg.checked || !segRes?.categoryMask) return;
  const W=Math.round(segC.width/Math.min(devicePixelRatio||1,2)), H=Math.round(segC.height/Math.min(devicePixelRatio||1,2));
  const mask=segRes.categoryMask.getAsUint8Array();
  const tile=40; sctx.globalAlpha=1; sctx.clearRect(0,0,segC.width,segC.height);
  let yi=0; (function pass(){
    const row=Math.min(H, yi+tile);
    for(let y=yi; y<row; y+=4){
      for(let x=0; x<W; x+=4){
        const cls=mask[y*W+x];
        if(cls===1){ sctx.fillStyle="rgba(190,156,255,.18)"; sctx.fillRect(x,y,4,4); }      // hair
        else if(cls===2||cls===3){ sctx.fillStyle="rgba(255,120,160,.14)"; sctx.fillRect(x,y,4,4); } // body/face skin
        else if(cls===4){ sctx.fillStyle="rgba(100,242,227,.10)"; sctx.fillRect(x,y,4,4); }         // clothes
      }
    }
    yi+=tile; if(yi<H) setTimeout(pass, 700/Math.ceil(H/tile));
  })();
}

/* -------- Preview: run local tasks and draw -------- */
$("#preview").addEventListener("click", ()=>{
  if(!img.src){ alert("Load an image first."); return; }
  clearAll(); sizeCanvasToImg();
  try{ faceRes = optFace.checked ? face.detect(img) : null; }catch{}
  faceCountEl.textContent = faceRes?.faceLandmarks?.length || 0;
  try{ poseRes = optPose.checked ? pose.detect(img) : null; }catch{}
  poseStateEl.textContent = poseRes?.landmarks?.length ? "on" : "off";
  try{ segRes  = optSeg.checked  ? seg.segment(img) : null; }catch{}
  drawNow();
});
function drawNow(){ mctx.clearRect(0,0,mesh.width,mesh.height); pctx.clearRect(0,0,poseC.width,poseC.height); sctx.clearRect(0,0,segC.width,segC.height); drawFace(); drawPose(); drawSeg(); }

/* -------- (Optional) Run Analysis → prompts/JSON -------- */
$("#run").addEventListener("click", ()=>{
  const analysis = {
    version:"pf_imageintel_v4",
    faces: (faceRes?.faceLandmarks?.length||0),
    pose: !!(poseRes?.landmarks?.length),
    seg: !!segRes?.categoryMask
  };
  outSFW.value="portrait, photorealistic, natural light"; // (keep simple here; your earlier prompt composer can slot back in)
  outNSFW.value="";
  outJSON.value=JSON.stringify(analysis,null,2);
});
</script>
</body>
</html>
