<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PromptForge — Face Mapper (Landmarks • Ratios • Palette • Prompt Pack)</title>
  <meta name="description" content="On‑device face mapping with MediaPipe: 468‑pt mesh, reproducible ratios, hair/skin palette, non‑identifying descriptors, and prompt‑ready text/JSON export for image models. Big live overlay shows what the AI is analyzing. Everything runs in your browser." />
  <link rel="canonical" href="https://promptforge.online/facemapper.html" />
  <meta name="theme-color" content="#08131b" />

  <!-- OG/Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="PromptForge — Face Mapper" />
  <meta property="og:description" content="Landmarks, ratios, palette, and prompt‑ready descriptors. Client‑side, privacy‑friendly." />
  <meta property="og:image" content="/assets/og/facemapper.png" />
  <meta property="og:url" content="https://promptforge.online/facemapper.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- JSON‑LD (Org + WebSite + Breadcrumbs) -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"PromptForge","url":"https://promptforge.online/","logo":"https://promptforge.online/assets/og/home.png","sameAs":["https://x.com/GoreandGiggles","https://bsky.app/profile/goreandgiggles.bsky.social","https://promptforge.online/support.html"]}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"PromptForge","url":"https://promptforge.online/","potentialAction":{"@type":"SearchAction","target":"https://promptforge.online/?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://promptforge.online/"},{"@type":"ListItem","position":2,"name":"Tools","item":"https://promptforge.online/#tools"},{"@type":"ListItem","position":3,"name":"Face Mapper"}]}</script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#08131b; --ink:#e8f8ff; --muted:#9cc3d6; --aqua:#64f2e3; --aqua2:#23d7ba; --edge:#1b2a36; --card:#0c1922; --ok:#7ef1a6; --warn:#ffd166; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 700px at 10% -10%,rgba(100,242,227,.07),transparent 55%),radial-gradient(1000px 600px at 120% -10%,rgba(35,215,186,.06),transparent 55%),var(--bg);color:var(--ink);font:14px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:var(--aqua)}
    .wrap{max-width:1240px;margin:0 auto;padding:18px}

    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:900;font-size:22px;letter-spacing:.4px;color:var(--aqua)}
    .crumbs{color:var(--muted);font-size:12px}
    .tool-links{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--edge);border-radius:999px;padding:.25rem .6rem;color:var(--muted);font-size:12px}

    .hero{margin-top:12px;display:grid;gap:12px;grid-template-columns:1.2fr .8fr}
    @media(max-width:980px){.hero{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:14px;box-shadow:0 14px 40px rgba(0,0,0,.55)}
    .hero h1{margin:.2rem 0 .4rem}
    .sub{color:var(--muted);font-size:12px}

    main.grid{display:grid;gap:16px;margin-top:14px}
    @media(min-width:1120px){main.grid{grid-template-columns:370px 1fr}}

    .steps{position:sticky;top:14px;display:flex;flex-direction:column;gap:10px}
    .step{border-left:3px solid #0f2630;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(10,26,34,.6),rgba(10,26,34,.3))}
    .step.active{border-left-color:var(--aqua)}
    .step .num{display:inline-block;width:22px;height:22px;border-radius:50%;background:#0f2a33;border:1px solid var(--edge);text-align:center;line-height:22px;margin-right:8px;color:var(--aqua)}

    .choose{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border:1.5px solid var(--aqua);border-radius:12px;background:linear-gradient(90deg,#0a2831,#0a2e2b);color:#eafffb;font-weight:800;cursor:pointer;box-shadow:0 0 0 0 rgba(100,242,227,.45);transition:box-shadow .25s}
    .choose:hover{box-shadow:0 0 0 4px rgba(100,242,227,.15),0 0 24px rgba(100,242,227,.25)}
    #file{display:none}

    .btn{background:#0e1f27;border:1px solid var(--edge);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:var(--aqua);box-shadow:0 0 0 2px rgba(100,242,227,.12) inset}

    /* Big preview + overlay */
    #stage{position:relative}
    #preview{width:100%;height:auto;border-radius:12px;background:#061219;display:block}
    #overlay{position:absolute;left:0;top:0;width:100%;height:100%;border-radius:12px;pointer-events:none}
    .legend{position:absolute;right:10px;top:10px;background:#08141caa;border:1px solid #10313b;border-radius:10px;padding:8px 10px;font:12px/1.3 ui-monospace,monospace}

    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
    .outbox{width:100%;min-height:90px;background:#07141c;border:1px solid #0f2833;border-radius:12px;color:var(--ink);padding:10px;box-shadow:0 0 22px rgba(100,242,227,.08);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px}

    /* Blended ad card */
    .ad-wrap{display:block;min-height:90px;border:1px solid var(--edge);border-radius:12px;margin:8px 0;padding:8px;text-align:center;color:var(--muted);background:linear-gradient(180deg,rgba(10,26,34,.45),rgba(10,26,34,.2));box-shadow:inset 0 0 0 1px rgba(100,242,227,.04)}
    .ad-note{font-size:11px;color:var(--muted);opacity:.85;margin-top:6px}

    /* J1NX float (compact) */
    .j1nx-float-true{position:fixed;z-index:4000;right:2vw;bottom:calc(2.8vh + 125px);display:flex;flex-direction:column;align-items:center;pointer-events:all;user-select:none;min-width:0;max-width:360px}
    .j1nx-true-cutout-img{width:180px;height:180px;object-fit:contain;border-radius:20px;background:transparent!important;margin-bottom:-16px;position:relative;z-index:9;pointer-events:auto;transition:box-shadow .2s}
    .j1nx-bubble-true-main{background:rgba(22,23,31,0.97);border-radius:17px;box-shadow:0 4px 22px #be9cff66,0 0 0 3px #23231f;border:2px solid var(--aqua);padding:1.1em 1.3em 1em 1.3em;margin-top:0;margin-bottom:.3em;display:flex;flex-direction:column;align-items:center;min-width:260px;max-width:320px}
    .j1nx-bubble-text-true{font-size:1.02em;color:#fff;margin:.42em 0 .20em 0;text-align:center;font-weight:600;text-shadow:0 1px 11px #1e1111cc;line-height:1.22;z-index:1;max-height:160px;overflow:auto}

    /* Footer (ANSI) */
    footer{margin:18px auto;padding:0 12px 16px;text-align:center;max-width:860px;color:#eaf7ff}
    .footer-art{font-family:"Fira Mono",monospace;font-size:.96em;color:#a1ffe3;line-height:1.1;letter-spacing:.2px;text-align:center;white-space:pre;user-select:text;margin:0 0 10px}
    .footer-camo{font-family:"Fira Mono",monospace;font-size:.85em;letter-spacing:2px;color:#64f2e3;min-height:.8em;white-space:pre}
    .footer-bar{color:#88fffd;margin:10px auto 6px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .footer-bar a{color:var(--aqua);text-decoration:none}
    .footer-bar a:hover{text-decoration:underline;color:#fff}

    /* Consent modal */
    .modal{position:fixed;inset:0;background:rgba(4,10,14,.72);display:none;align-items:center;justify-content:center;z-index:5000}
    .modal.open{display:flex}
    .sheet{width:min(640px,92vw);background:#0c1620;border:1px solid #12323d;border-radius:14px;padding:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">PromptForge — Face Mapper</div>
        <div class="crumbs">Home › Tools › Face Mapping (non‑identifying)</div>
      </div>
      <div class="tool-links">
        <a class="pill" href="/">Home</a>
        <a class="pill" href="/picture.html">Picture Builder</a>
        <a class="pill" href="/movie.html">Movie Builder</a>
        <a class="pill" href="/ansiart.html">ANSI/ASCII Studio</a>
        <a class="pill" href="/watermark.html">Watermark</a>
        <a class="pill" href="/playground.html">Prompt Patterns</a>
        <a class="pill" href="/support.html">Support</a>
        <a class="pill" href="/legal.html">Legal</a>
      </div>
    </div>

    <section class="hero">
      <div class="card">
        <h1>Map a Face → Get Clean Descriptors</h1>
        <p class="sub">Drop a portrait. Watch a **large live overlay** trace the mesh and measurements: facial ratios, angles, hair/skin palette. Then export a <b>Face Descriptor Pack</b> (prompt‑ready text + JSON). <u>Not for identification</u> — creative descriptors only; use with consent and never for minors.</p>
      </div>
      <div class="card" style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <h3>Quick links</h3>
          <div class="tool-links" style="margin-top:6px">
            <a class="pill" href="/picture.html">Image Prompt Builder</a>
            <a class="pill" href="/compare.html">Model Compare</a>
            <a class="pill" href="/watermark.html">Watermark & EXIF</a>
          </div>
        </div>
        <div style="width:180px;min-width:160px;text-align:center">
          <script type="text/javascript" data-cfasync="false" async src="https://poweredby.jads.co/js/jads.js"></script>
          <ins id="1101940" data-width="160" data-height="160"></ins>
          <script type="text/javascript" data-cfasync="false" async>(adsbyjuicy = window.adsbyjuicy || []).push({"adzone":1101940});</script>
          <div class="ad-note">sponsored</div>
        </div>
      </div>
    </section>

    <main class="grid">
      <aside class="steps">
        <div class="card step active">
          <div><span class="num">1</span><strong>Choose Image</strong></div>
          <div class="sub">Portrait, well‑lit. On‑device only.</div>
          <label for="file" class="choose" id="chooseBtn">➕ Choose Image</label>
          <input id="file" type="file" accept="image/*" />
          <div class="ad-wrap">
            <ins id="1101674" data-width="auto" data-height="90"></ins>
            <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101674});}catch(e){}</script>
            <div class="ad-note">sponsored</div>
          </div>
        </div>
        <div class="card step">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div><span class="num">2</span><strong>Map & Measure</strong></div>
            <label class="sub" style="display:flex;gap:8px;align-items:center"><input id="gridToggle" type="checkbox" checked> Overlay Grid</label>
          </div>
          <div class="sub">Mesh, box, key ratios (jaw/face, cheekbones, eye angle, lip ratio), hair/skin palette.</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button id="run" class="btn primary" disabled>Run Mapping</button>
            <button id="exportJSON" class="btn">Export JSON</button>
            <button id="copyPrompt" class="btn">Copy Prompt Chunk</button>
          </div>
          <div class="sub" id="progress" style="margin-top:6px">—</div>
        </div>
        <div class="card step">
          <div><span class="num">?</span><strong>Help & Policy</strong></div>
          <a href="#faq" class="btn">Open FAQ</a>
          <button id="toggleJ1NX" class="btn">Open J1NX</button>
        </div>
      </aside>

      <section class="card">
        <h3>Live Face Overlay</h3>
        <div id="stage">
          <canvas id="preview" width="1080" height="680"></canvas>
          <canvas id="overlay" width="1080" height="680"></canvas>
          <div class="legend" id="legend">Live: grid • scan • face box • landmarks • angles</div>
        </div>

        <div class="card" style="margin-top:10px;padding:10px;display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="run2" class="btn primary" disabled>Run Mapping</button>
            <label class="sub" style="display:flex;gap:8px;align-items:center"><input id="showVectors" type="checkbox" checked> Show Guides</label>
          </div>
          <div class="sub" id="note">Ready</div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Face Prompt (non‑identifying)</h3>
            <div class="outbox" id="promptOut">—</div>
            <p class="sub" style="margin:.4rem 0 0">Format targets SDXL/Flux/MJ: high‑level shape, features, color hints, ratios. Not for person identification.</p>
          </div>
          <div>
            <h3>Key Measurements</h3>
            <div class="outbox" id="measures">—</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Palette</h3>
            <div class="outbox" id="palette" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center"></div>
          </div>
          <div>
            <h3>Attributes</h3>
            <div class="outbox" id="attrs">—</div>
          </div>
        </div>

        <div class="ad-wrap" style="margin-top:12px">
          <ins id="1101622" data-width="auto" data-height="250"></ins>
          <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101622});}catch(e){}</script>
          <div class="ad-note">sponsored</div>
        </div>

        <div class="card" id="faq" style="margin-top:12px">
          <h3>FAQ / Safety</h3>
          <details open>
            <summary><strong>Is this facial recognition?</strong></summary>
            <p class="sub">No. It does not identify or verify people. It produces **non‑identifying descriptors** (shapes, ratios, colors) for creative image generation. Use only with consent; never analyze minors.</p>
          </details>
          <details>
            <summary><strong>Will it recreate a specific person exactly?</strong></summary>
            <p class="sub">No. Prompt text cannot force a model to copy a real identity. Exact likeness typically requires training a LoRA/embedding **with consent**, which is out of scope here. The output aims for <em>consistent vibe/structure</em>, not identity.</p>
          </details>
          <details>
            <summary><strong>What’s in the JSON export?</strong></summary>
            <p class="sub">Filename, image size; 468‑pt landmarks (normalized); computed ratios/angles; attributes (hair hue, guessed face shape, brow/eye/lip style); palette (hair/skin triad); and the prompt chunk.</p>
          </details>
        </div>
      </section>
    </main>
  </div>

  <!-- Consent Modal -->
  <div id="consent" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <h3>Face Mapping — Consent</h3>
      <p class="sub">Use with consent only. Analysis runs on‑device. This is not an ID matcher.</p>
      <label style="display:flex;align-items:center;gap:8px"><input id="agree" type="checkbox"> <span>I own/have permission to analyze this image.</span></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="deny" class="btn">Cancel</button><button id="accept" class="btn primary" disabled>Accept</button></div>
    </div>
  </div>

  <!-- J1NX (compact) -->
  <div class="j1nx-float-true" id="j1nxFloatTrue" style="display:none">
    <img src="/j1nx/j1nx_cutout.png" alt="J1NX" class="j1nx-true-cutout-img" id="j1nxCutoutTrue"/>
    <div class="j1nx-bubble-true-main" id="j1nxBubbleTrueMain">
      <div class="j1nx-bubble-text-true" id="j1nxBubbleTextTrue">
        <b>J1NX:</b> Drop a portrait and hit <b>Run Mapping</b>. I’ll explain the mesh and ratios.
      </div>
      <div class="j1nx-bubble-row-true">
        <input class="j1nx-input-true" id="j1nxInputTrue" placeholder="Ask J1NX…" maxlength="140" autocomplete="off"/>
        <button class="j1nx-btn-true" id="j1nxSendTrue">Send</button>
      </div>
      <div class="j1nx-bubble-row-true">
        <button class="j1nx-btn-true" id="j1nxClearTrue">Clear</button>
        <button class="j1nx-btn-true" id="j1nxSaveTrue">Save Chat</button>
      </div>
      <div class="j1nx-easteregg-true" id="j1nxEasterEggTrue">Double‑tap the bubble or type <b>unlock</b> …</div>
    </div>
  </div>

  <!-- ANSI FOOTER -->
  <footer>
    <pre class="footer-art">
  ____      ____    U  ___ u  __  __    ____    _____    _____   U  ___ u   ____      ____  U _____ u   
 U|  _"\ uU |  _"\ u  \"/_ \/U|' \/ '|uU|  _"\ u|_ " _|  |" ___|   \"/_ \/U |  _"\ uU /"___|u\| ___"|/   
 \| |_) |/ \| |_) |/  | | | |\| |\/| |/\| |_) |/  | |   U| |_  u   | | | | \| |_) |/\| |  _ / |  _|"     
  |  __/    |  _ <.-,_| |_| | | |  | |  |  __/   /| |\  \|  _|/.-,_| |_| |  |  _ <   | |_| |  | |___     
  |_|       |_| \_\\_)-\___/  |_|  |_|  |_|     u |_|U   |_|    \_)-\___/   |_| \_\   \____|  |_____|    
  ||>>_     //   \\_    \\   <<,-,,-.   ||>>_   _// \\_  )(\\,-      \\     //   \\_  _)(|_   <<   >>    
 (__)__)   (__)  (__)  (__)   (./  \.) (__)__) (__) (__)(__)(_/     (__)   (__)  (__)(__)__) (__) (__)   
    </pre>
    <pre class="footer-camo" id="footerCamo"></pre>
    <div class="footer-bar">
      Made underground in BC, Canada • #PromptForge •
      <a href="https://bsky.app/profile/goreandgiggles.bsky.social" target="_blank" rel="noopener">Bluesky</a> •
      <a href="https://x.com/GoreandGiggles" target="_blank" rel="noopener">Twitter/X</a> •
      <a href="/legal.html">Legal</a>
    </div>
  </footer>

  <script>
  // ===== Config & helpers =====
  const CFG = { consentRequired:true };
  const els = { file:$('#file'), choose:$('#chooseBtn'), preview:$('#preview'), overlay:$('#overlay'), legend:$('#legend'), grid:$('#gridToggle'), run:$('#run'), run2:$('#run2'), showVectors:$('#showVectors'), progress:$('#progress'), note:$('#note'), promptOut:$('#promptOut'), measures:$('#measures'), palette:$('#palette'), attrs:$('#attrs'), exportJSON:$('#exportJSON'), copyPrompt:$('#copyPrompt'), consent:$('#consent'), agree:$('#agree'), accept:$('#accept'), deny:$('#deny'), jOpen:$('#toggleJ1NX'), jWrap:$('#j1nxFloatTrue'), jBubble:$('#j1nxBubbleTextTrue'), jInput:$('#j1nxInputTrue'), jSend:$('#j1nxSendTrue'), jClear:$('#j1nxClearTrue'), jSave:$('#j1nxSaveTrue'), jEgg:$('#j1nxEasterEggTrue') };
  const ctx = els.preview.getContext('2d');
  const octx = els.overlay.getContext('2d');
  function $(q){return document.querySelector(q)}
  function note(m){ els.progress.textContent=m; els.note.textContent=m; }

  const Loader = { loaded:new Set(), js(src){return new Promise((res,rej)=>{ if(Loader.loaded.has(src)) return res(); const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>{Loader.loaded.add(src);res();}; s.onerror=()=>rej(new Error('load '+src)); document.head.appendChild(s); });} };

  const state = { imgEl:null, imgName:'', imgW:0, imgH:0, draw:{dx:0,dy:0,dw:0,dh:0}, gridOn:true, vectors:true,
    face:{landmarks:[], ratios:{}, angles:{}, attrs:{}, shape:''}, palette:[] };

  function fitDraw(img){ const C=els.preview, W=C.width, H=C.height; ctx.clearRect(0,0,W,H); octx.clearRect(0,0,W,H); const ar=img.width/img.height, car=W/H; let dw,dh,dx,dy; if(ar>car){dw=W;dh=W/ar;dx=0;dy=(H-dh)/2}else{dh=H;dw=H*ar;dy=0;dx=(W-dw)/2} ctx.drawImage(img,dx,dy,dw,dh); state.draw={dx,dy,dw,dh}; state.imgW=img.width; state.imgH=img.height; }
  function drawGrid(){ if(!state.gridOn) return; const {dx,dy,dw,dh}=state.draw; const step=dw/18; octx.save(); octx.strokeStyle='rgba(100,242,227,0.18)'; octx.lineWidth=1; for(let x=dx;x<=dx+dw;x+=step){ octx.beginPath(); octx.moveTo(x,dy); octx.lineTo(x,dy+dh); octx.stroke(); } for(let y=dy;y<=dy+dh;y+=step){ octx.beginPath(); octx.moveTo(dx,y); octx.lineTo(dx+dw,y); octx.stroke(); } octx.restore(); }
  function startScan(){ stopScan(); let y=0,t=0; state._scan=setInterval(()=>{ octx.clearRect(0,0,els.overlay.width,els.overlay.height); drawGrid(); octx.fillStyle='rgba(35,215,186,0.14)'; octx.fillRect(0,y,els.overlay.width,8); const px=state.draw.dx+(Math.sin(t/18)*.5+.5)*state.draw.dw; const py=y+4; octx.beginPath(); octx.arc(px,py,6,0,Math.PI*2); octx.fillStyle='rgba(100,242,227,0.75)'; octx.fill(); y=(y+3)%els.overlay.height; t++; },16); }
  function stopScan(){ if(state._scan){ clearInterval(state._scan); state._scan=null; octx.clearRect(0,0,els.overlay.width,els.overlay.height); if(state.gridOn) drawGrid(); } }

  // ===== File load =====
  els.choose.addEventListener('click',()=>els.file.click());
  els.file.addEventListener('change',(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; state.imgName=f.name||'image'; const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ state.imgEl=img; fitDraw(img); els.run.disabled=false; els.run2.disabled=false; note('Ready. Click Run Mapping.'); URL.revokeObjectURL(url); }; img.src=url; });

  // ===== MediaPipe Face Landmarker =====
  async function ensureFace(){ if(window._pfFace) return true; note('Loading face landmarker…'); await Loader.js('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14'); const vision=await window.tasksVision.FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'); window._pfFace = await window.tasksVision.FaceLandmarker.createFromOptions(vision,{ baseOptions:{modelAssetPath:'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/face_landmarker.task'}, numFaces:1, runningMode:'IMAGE', outputFaceBlendshapes:false, outputFacialTransformationMatrixes:false }); return true; }
  function mpDist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function P(p){ const {dx,dy,dw,dh}=state.draw; return { x: dx + p.x*dw, y: dy + p.y*dh } }
  function boxFrom(lm){ const xs=lm.map(p=>P(p).x), ys=lm.map(p=>P(p).y); return {minX:Math.min(...xs), maxX:Math.max(...xs), minY:Math.min(...ys), maxY:Math.max(...ys)} }
  function drawFace(lm){ if(!lm) return; const bbox=boxFrom(lm); octx.save(); octx.strokeStyle='rgba(100,242,227,.6)'; octx.lineWidth=1.4; octx.strokeRect(bbox.minX,bbox.minY,bbox.maxX-bbox.minX,bbox.maxY-bbox.minY); octx.restore(); if(state.vectors){ octx.save(); octx.strokeStyle='rgba(100,242,227,.9)'; octx.lineWidth=1; lm.forEach(p=>{ const q=P(p); octx.beginPath(); octx.arc(q.x,q.y,0.9,0,Math.PI*2); octx.stroke();}); octx.restore(); }
    // corner brackets
    const pad=10; const L=bbox.minX, T=bbox.minY, R=bbox.maxX, B=bbox.maxY; const Lw=24, Lh=18; octx.strokeStyle='rgba(35,215,186,.85)'; octx.lineWidth=2; [[L,T],[R,T],[L,B],[R,B]].forEach(([x,y])=>{ octx.beginPath(); octx.moveTo(x,y+Lh); octx.lineTo(x,y); octx.lineTo(x+Lw,y); octx.stroke(); });
    return bbox; }

  function hex(r,g,b){return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('')}
  function avgRect(rect){ const {minX,maxX,minY,maxY}=rect; const w=maxX-minX,h=maxY-minY; const sx=Math.max(0,minX|0), sy=Math.max(0,minY|0), sw=Math.max(1,w|0), sh=Math.max(1,h|0); const tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh; const t=tmp.getContext('2d'); t.drawImage(els.preview,sx,sy,sw,sh,0,0,sw,sh); const d=t.getImageData(0,0,sw,sh).data; let R=0,G=0,B=0,n=0; for(let i=0;i<d.length;i+=4){R+=d[i];G+=d[i+1];B+=d[i+2];n++;} return hex((R/n)|0,(G/n)|0,(B/n)|0); }

  function classifyShape(r){ // coarse guess from ratios
    const {jaw_face, cheek_face, forehead_face}=r; if(!jaw_face||!cheek_face) return 'undetermined'; const jf=jaw_face, cf=cheek_face; if(cf>0.7&&jf>0.6) return 'square'; if(cf>0.72&&jf<0.55) return 'heart'; if(jf<0.52&&cf<0.62) return 'oval'; if(jf>0.62&&cf<0.6) return 'triangle'; return 'round'; }

  function buildPrompt(state){ const r=state.face.ratios, a=state.face.attrs, shape=state.face.shape; const hair=a.hairHex?`hair-color: ${a.hairHex}`:''; const skin=a.skinHex?`skin-tone: ${a.skinHex}`:''; const eyes=a.eyeHue?`eye-hue: ${a.eyeHue}`:''; const ratios=['jaw/face '+(r.jaw_face||'-'),'cheekbone/face '+(r.cheek_face||'-'),'forehead/face '+(r.forehead_face||'-'),'eye-angle '+(state.face.angles.eye||'-'),'lip-thickness '+(r.lip_ratio||'-')].join(' • '); const lines=[ `face-shape: ${shape}`, hair, skin, eyes, `ratios: ${ratios}` ].filter(Boolean); return lines.join('\n'); }

  async function run(){ if(!state.imgEl) return; if(CFG.consentRequired && !state._ok){ els.consent.classList.add('open'); return; } await ensureFace(); startScan(); const res=await window._pfFace.detect(state.imgEl); stopScan(); octx.clearRect(0,0,els.overlay.width,els.overlay.height); if(state.gridOn) drawGrid(); if(!res || !res.faceLandmarks || !res.faceLandmarks.length){ note('No face found.'); return; } const lm=res.faceLandmarks[0]; const IDX={ chin:152, top:10, leftJaw:234, rightJaw:454, leftEyeIn:133, rightEyeIn:362, leftEyeOut:33, rightEyeOut:263, leftBrowMid:105, rightBrowMid:334, upperLip:13, lowerLip:14 };
    drawFace(lm);
    // Ratios
    const faceH=mpDist(lm[IDX.top],lm[IDX.chin]);
    const jawW=mpDist(lm[IDX.leftJaw],lm[IDX.rightJaw]);
    const cheekW=mpDist(lm[234],lm[454]); // same as jaw anchors for approx cheek width
    const foreheadH=mpDist(lm[8],lm[10]);
    const lipT=mpDist(lm[IDX.upperLip],lm[IDX.lowerLip]);
    const eyeAngle=Math.atan2(lm[IDX.rightEyeIn].y - lm[IDX.leftEyeIn].y, lm[IDX.rightEyeIn].x - lm[IDX.leftEyeIn].x) * 57.2958; // deg

    const ratios={ jaw_face:+(jawW/faceH).toFixed(3), cheek_face:+(cheekW/faceH).toFixed(3), forehead_face:+(foreheadH/faceH).toFixed(3), lip_ratio:+(lipT/faceH).toFixed(3) };
    state.face.ratios=ratios; state.face.angles={ eye:+eyeAngle.toFixed(2) };

    // Hair & skin average
    const bbox=boxFrom(lm); const hairRect={minX:bbox.minX, maxX:bbox.maxX, minY:Math.max(0,bbox.minY-0.18*(bbox.maxY-bbox.minY)), maxY:bbox.minY}; const skinRect={minX:bbox.minX+(bbox.maxX-bbox.minX)*0.3, maxX:bbox.maxX-(bbox.maxX-bbox.minX)*0.3, minY:bbox.minY+(bbox.maxY-bbox.minY)*0.45, maxY:bbox.minY+(bbox.maxY-bbox.minY)*0.7};
    const hairHex=avgRect(hairRect), skinHex=avgRect(skinRect);

    // Eye hue rough estimate = average of small patch around inner eye points
    function smallPatch(idx){ const q=P(lm[idx]); const r=8; const rect={minX:q.x-r,maxX:q.x+r,minY:q.y-r,maxY:q.y+r}; return avgRect(rect); }
    const eyeHue=smallPatch(IDX.leftEyeIn);

    state.face.attrs={ hairHex, skinHex, eyeHue };
    state.face.shape=classifyShape(ratios);
    state.face.landmarks = lm.map(p=>[+p.x.toFixed(5), +p.y.toFixed(5), +(p.z||0).toFixed(5)]);

    // Palette chips
    els.palette.innerHTML = [hairHex, skinHex, eyeHue].map(hex=>`<span style="display:inline-flex;align-items:center;gap:6px;border:1px solid #123;padding:6px 8px;border-radius:8px"><i style=\"width:18px;height:18px;border-radius:4px;background:${hex};display:inline-block\"></i><code>${hex}</code></span>`).join(' ');

    // Measures & prompt
    const mtxt = Object.entries(ratios).map(([k,v])=>`${k}: ${v}`).join('\n') + `\nEye angle (deg): ${state.face.angles.eye}`;
    els.measures.textContent = mtxt;
    const prompt = buildPrompt(state);
    els.promptOut.textContent = prompt;
    note('Mapped. Export or copy.');
  }

  // Wire UI
  els.grid.addEventListener('change',()=>{ state.gridOn=els.grid.checked; octx.clearRect(0,0,els.overlay.width,els.overlay.height); if(state.gridOn) drawGrid(); });
  els.showVectors.addEventListener('change',()=>{ state.vectors=els.showVectors.checked; run(); });
  els.run.addEventListener('click',run); els.run2.addEventListener('click',run);
  els.copyPrompt.addEventListener('click',()=>{ navigator.clipboard.writeText(els.promptOut.textContent||''); note('Prompt chunk copied.'); });
  els.exportJSON.addEventListener('click',()=>{ const data={ version:'pf_facemapper_1', filename:state.imgName, image:{width:state.imgW,height:state.imgH}, landmarks:state.face.landmarks, ratios:state.face.ratios, angles:state.face.angles, attrs:state.face.attrs, shape:state.face.shape, prompt_chunk:els.promptOut.textContent }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(state.imgName||'image')+'.pf_facemapper.json'; a.click(); URL.revokeObjectURL(a.href); });

  // Consent
  els.agree.addEventListener('change',()=>els.accept.disabled=!els.agree.checked);
  els.accept.addEventListener('click',()=>{ state._ok=true; els.consent.classList.remove('open'); run(); });
  els.deny.addEventListener('click',()=>{ els.consent.classList.remove('open'); });

  // J1NX (toggle only)
  els.jOpen.addEventListener('click',()=>{ els.jWrap.style.display = (els.jWrap.style.display==='none'?'flex':'none'); });
  const say=(t)=>{ els.jBubble.innerHTML += '<br/>'+(t||'').replace(/</g,'&lt;'); els.jBubble.scrollTop=els.jBubble.scrollHeight; };
  els.jSend?.addEventListener('click',()=>{ const v=els.jInput.value.trim(); if(!v) return; say('<b>You:</b> '+v); els.jInput.value=''; });
  els.jClear?.addEventListener('click',()=>{ els.jBubble.innerHTML='<b>J1NX:</b> Reset. Ready.'; });
  els.jSave?.addEventListener('click',()=>{ const blob=new Blob([els.jBubble.textContent||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='j1nx_chat.txt'; a.click(); URL.revokeObjectURL(a.href); });
  (function(){ let taps=0,tid; els.jWrap?.addEventListener('click',()=>{ clearTimeout(tid); taps++; tid=setTimeout(()=>{ if(taps>=2){ els.jEgg.textContent='NSFW hint unlocked (demo): try labs when available.'; els.jEgg.style.opacity=1; } taps=0; },240); },{passive:true}); })();

  // Footer camo shimmer
  (function(){ const camo=document.getElementById('footerCamo'); if(!camo) return; const colors=["#64f2e3","#23d7ba","#be9cff","#ffd166"]; let i=0; setInterval(()=>{ camo.textContent=['█▄▀','▞▚','▓▒░','◢◣◥◤'][i%4].repeat(28); camo.style.color=colors[i%colors.length]; i++; },380); })();
  </script>
</body>
  </html>
