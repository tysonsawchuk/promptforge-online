<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PromptForge — Image Intelligence (Live Scan • Face Mapping • Objects • OCR)</title>
  <meta name="description" content="On‑device image analysis with live scan drawing: face landmarks + reproducible ratios, object boxes, OCR word boxes, palette & EXIF, poetic/technical caption & prompt builder with length/style controls, JSON export. J1NX, footer, and ad placements preserved." />
  <link rel="canonical" href="https://promptforge.online/imageintel.html" />
  <meta name="theme-color" content="#08131b" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="PromptForge — Image Intelligence" />
  <meta property="og:description" content="Face mapping + ratios, objects, OCR, palette, EXIF — client‑side. Build prompts and export JSON." />
  <meta property="og:image" content="/assets/og/imagetoprompt.png" />
  <meta property="og:url" content="https://promptforge.online/imageintel.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- JSON‑LD (Org + WebSite + Breadcrumbs) -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"PromptForge","url":"https://promptforge.online/","logo":"https://promptforge.online/assets/og/home.png","sameAs":["https://x.com/GoreandGiggles","https://bsky.app/profile/goreandgiggles.bsky.social","https://promptforge.online/support.html"]}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"PromptForge","url":"https://promptforge.online/","potentialAction":{"@type":"SearchAction","target":"https://promptforge.online/?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://promptforge.online/"},{"@type":"ListItem","position":2,"name":"Tools","item":"https://promptforge.online/#tools"},{"@type":"ListItem","position":3,"name":"Image Intelligence"}]}</script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#08131b; --ink:#e8f8ff; --muted:#9cc3d6; --aqua:#64f2e3; --aqua2:#23d7ba; --edge:#1b2a36; --card:#0c1922; --ok:#7ef1a6; --warn:#ffd166; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 10% -10%,rgba(100,242,227,.07),transparent 55%),radial-gradient(1000px 600px at 120% -10%,rgba(35,215,186,.06),transparent 55%),var(--bg);color:var(--ink);font:14px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:var(--aqua)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}

    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:900;font-size:22px;letter-spacing:.4px;color:var(--aqua)}
    .crumbs{color:var(--muted);font-size:12px}
    .tool-links{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--edge);border-radius:999px;padding:.25rem .6rem;color:var(--muted);font-size:12px}

    .hero{margin-top:12px;display:grid;gap:12px;grid-template-columns:1.1fr .9fr}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:14px;box-shadow:0 14px 40px rgba(0,0,0,.55)}
    .hero h1{margin:.2rem 0 .4rem}
    .sub{color:var(--muted);font-size:12px}

    .grid{display:grid;gap:16px}
    @media(min-width:1024px){.grid{grid-template-columns:330px 1fr}}
    h3{margin:.2rem 0 .8rem;color:var(--muted);font-size:15px}

    .steps{position:sticky;top:14px;display:flex;flex-direction:column;gap:10px}
    .step{border-left:3px solid #0f2630;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(10,26,34,.6),rgba(10,26,34,.3))}
    .step.active{border-left-color:var(--aqua)}
    .step .num{display:inline-block;width:22px;height:22px;border-radius:50%;background:#0f2a33;border:1px solid var(--edge);text-align:center;line-height:22px;margin-right:8px;color:var(--aqua)}

    .choose{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border:1.5px solid var(--aqua);border-radius:12px;background:linear-gradient(90deg,#0a2831,#0a2e2b);color:#eafffb;font-weight:800;cursor:pointer;box-shadow:0 0 0 0 rgba(100,242,227,.45);transition:box-shadow .25s}
    .choose:hover{box-shadow:0 0 0 4px rgba(100,242,227,.15),0 0 24px rgba(100,242,227,.25)}
    #file{display:none}

    .btn{background:#0e1f27;border:1px solid var(--edge);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:var(--aqua);box-shadow:0 0 0 2px rgba(100,242,227,.12) inset}
    .btn.warn{border-color:var(--warn);color:var(--warn)}

    textarea,.outbox{width:100%;min-height:120px;background:#07141c;border:1px solid #0f2833;border-radius:12px;color:var(--ink);padding:10px;box-shadow:0 0 22px rgba(100,242,227,.08)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    #previewWrap{position:relative}
    #preview{width:100%;border-radius:10px;background:#061219}
    #overlay{position:absolute;left:0;top:0;width:100%;border-radius:10px;pointer-events:none}
    .legend{position:absolute;right:10px;top:10px;background:#08141caa;border:1px solid #10313b;border-radius:10px;padding:8px 10px;font:12px/1.3 ui-monospace,monospace}

    .switch{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .switch input{accent-color:var(--aqua)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60}
    .modal.open{display:flex}
    .sheet{background:var(--card);border:1px solid var(--edge);border-radius:14px;max-width:740px;width:92%;padding:16px}

    .ad-wrap{display:block;min-height:90px;border:1px dashed var(--edge);border-radius:12px;margin:8px 0;padding:8px;text-align:center;color:var(--muted)}
    .ad-right{display:flex;gap:8px;align-items:center}

    /* J1NX float — visual parity */
    .j1nx-float-true{position:fixed;z-index:4000;right:2vw;bottom:calc(2.8vh + 125px);display:flex;flex-direction:column;align-items:center;pointer-events:all;user-select:none;min-width:0;max-width:360px}
    .j1nx-true-cutout-img{width:220px;height:220px;object-fit:contain;border-radius:24px;background:transparent!important;margin-bottom:-20px;position:relative;z-index:9;pointer-events:auto;transition:box-shadow .2s;box-shadow:none!important}
    .j1nx-bubble-true-main{background:rgba(22,23,31,0.97);border-radius:17px;box-shadow:0 4px 22px #be9cff66,0 0 0 3px #23231f;border:2px solid var(--aqua);padding:1.1em 1.3em 1em 1.3em;margin-top:0;margin-bottom:.3em;display:flex;flex-direction:column;align-items:center;min-width:280px;max-width:330px;position:relative;z-index:1}
    .j1nx-bubble-text-true{font-size:1.02em;color:#fff;margin:.42em 0 .20em 0;text-align:center;font-weight:600;text-shadow:0 1px 11px #1e1111cc;line-height:1.22;z-index:1;max-height:180px;overflow:auto}
    .j1nx-bubble-row-true{width:100%;display:flex;justify-content:center;gap:7px;margin:.13em 0 .10em 0}
    .j1nx-input-true{flex:1;font-size:1em;border-radius:8px;padding:7px 12px;border:1px solid var(--aqua);background:#171b22;color:var(--aqua);min-width:0}
    .j1nx-btn-true{font-size:.98em;padding:6.5px 14px;border-radius:8px;background:#22252b;border:1.3px solid var(--aqua);color:var(--aqua);font-family:inherit;font-weight:600;cursor:pointer;transition:background .13s,color .13s,border .13s;box-shadow:0 1.5px 9px #be9cff33}
    .j1nx-btn-true:hover{background:var(--aqua);color:#171b22;border-color:#fff}
    .j1nx-easteregg-true{font-size:.91em;color:#be9cff;background:#171b22e6;border-radius:7px 13px 12px 17px;margin-top:7px;padding:7px 17px 6px 13px;opacity:.85;pointer-events:none;text-align:center;width:94%;user-select:none;box-shadow:0 3px 13px #be9cff28;font-weight:600}
    @media(max-width:900px){.j1nx-float-true{min-width:99vw;max-width:99vw;right:1vw}.j1nx-bubble-true-main{min-width:97vw;max-width:99vw}.j1nx-true-cutout-img{width:96px;height:96px}}

    /* Footer styles (ANSI + nav) */
    footer{margin:18px auto;padding:0 12px 16px;text-align:center;max-width:860px;color:#eaf7ff}
    .footer-art{font-family:"Fira Mono",monospace;font-size:.96em;color:#a1ffe3;line-height:1.1;letter-spacing:.2px;text-align:center;white-space:pre;user-select:text;margin:0 0 10px}
    .footer-camo{font-family:"Fira Mono",monospace;font-size:.85em;letter-spacing:2px;color:#64f2e3;min-height:.8em;white-space:pre}
    .footer-bar{color:#88fffd;margin:10px auto 6px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .footer-bar a{color:var(--aqua);text-decoration:none}
    .footer-bar a:hover{text-decoration:underline;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">PromptForge — Image Intelligence</div>
        <div class="crumbs">Home › Tools › Image → Prompt (with Face Mapping)</div>
      </div>
      <div class="tool-links">
        <a class="pill" href="/">Home</a>
        <a class="pill" href="/picture.html">Picture Builder</a>
        <a class="pill" href="/movie.html">Movie Builder</a>
        <a class="pill" href="/ansiart.html">ANSI/ASCII Studio</a>
        <a class="pill" href="/watermark.html">Watermark</a>
        <a class="pill" href="/playground.html">Prompt Patterns</a>
        <a class="pill" href="/support.html">Support</a>
        <a class="pill" href="/legal.html">Legal</a>
      </div>
    </div>

    <section class="hero">
      <div class="card">
        <h1>Analyze → Measure → Explain → Export</h1>
        <p class="sub">Drop a photo. Watch a <b>live scan</b> paint what the model sees: a face mesh with reproducible ratios, object boxes, OCR word boxes, palette, and EXIF. Then auto‑build a professional caption and a clean prompt chunk for SDXL/Flux/MJ, or export a JSON bundle. Everything runs <b>client‑side by default</b>.</p>
      </div>
      <div class="card ad-right">
        <div style="flex:1">
          <h3>Quick links</h3>
          <p class="sub">PromptForge tools & docs.</p>
          <div class="tool-links" style="margin-top:6px">
            <a class="pill" href="/picture.html">Image Prompt Builder</a>
            <a class="pill" href="/movie.html">Video Prompt Builder</a>
            <a class="pill" href="/ansiart.html">ANSI/ASCII Studio</a>
            <a class="pill" href="/watermark.html">Watermark & Privacy</a>
            <a class="pill" href="/compare.html">Model Compare</a>
          </div>
        </div>
        <div style="width:108px;min-width:108px;text-align:center">
          <script type="text/javascript" data-cfasync="false" async src="https://poweredby.jads.co/js/jads.js"></script>
          <ins id="1101940" data-width="108" data-height="140"></ins>
          <script type="text/javascript" data-cfasync="false" async>(adsbyjuicy = window.adsbyjuicy || []).push({"adzone":1101940});</script>
        </div>
      </div>
    </section>

    <main class="grid" style="margin-top:14px">
      <aside class="steps">
        <div class="card step active">
          <div><span class="num">1</span><strong>Choose Image</strong></div>
          <div class="sub">Portrait or scene. Private: runs in your browser.</div>
          <label for="file" class="choose" id="chooseBtn" title="Select a local photo (nothing is uploaded by default)">➕ Choose Image</label>
          <input id="file" type="file" accept="image/*" />
          <div class="ad-wrap">
            <script async src="https://poweredby.jads.co/js/jads.js"></script>
            <ins id="1101674" data-width="auto" data-height="90"></ins>
            <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101674});}catch(e){}</script>
          </div>
        </div>
        <div class="card step">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div><span class="num">2</span><strong>Analyze</strong></div>
            <label class="switch" title="Show overlay grid while scanning"><input id="gridToggle" type="checkbox" checked> Face Grid</label>
          </div>
          <div class="sub">Face Mode = landmarks + ratios • Full‑AI = objects + OCR • Remote = optional Qwen caption (configurable).</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button id="analyze" class="btn primary" disabled>Run (Fast)</button>
            <button id="enable-face" class="btn">Face Mode</button>
            <button id="enable-ai" class="btn">Enable Full‑AI</button>
            <button id="remoteCap" class="btn" title="Uses your server if configured">Remote Caption (Qwen*)</button>
          </div>
          <div class="sub" id="progress" style="margin-top:6px">—</div>
        </div>
        <div class="card step">
          <div><span class="num">3</span><strong>Build & Export</strong></div>
          <div class="sub">Assemble prompt and export JSON for advanced workflows.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="build" class="btn">Build Prompt</button>
            <button id="exportJSON" class="btn">Export JSON</button>
          </div>
        </div>
        <div class="card step">
          <div><span class="num">?</span><strong>Help & FAQ</strong></div>
          <div class="sub">Use prompt directly or fine‑tune locally. Privacy inside.</div>
          <a href="#faq" class="btn">Open FAQ</a>
          <button id="toggleJ1NX" class="btn">Open J1NX</button>
        </div>
      </aside>

      <section class="card">
        <h3>Preview</h3>
        <div id="previewWrap">
          <canvas id="preview" width="900" height="560"></canvas>
          <canvas id="overlay" width="900" height="560"></canvas>
          <div class="legend" id="legend">Live: grid • scan • boxes • mesh • words</div>
        </div>

        <!-- Always-visible action bar under the canvas -->
        <div class="card" style="margin-top:10px;padding:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr;align-items:center">
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <button id="analyze2" class="btn primary" disabled>Run (Fast)</button>
            <button id="enable-face2" class="btn">Face Mode</button>
            <button id="enable-ai2" class="btn">Enable Full‑AI</button>
          </div>
          <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
            <label class="switch" title="Adjust caption/prompt target length">
              <span>Length:</span>
              <input id="lenSlider" type="range" min="120" max="600" step="20" value="240" style="width:180px">
              <span id="lenVal" class="sub">≈240 chars</span>
            </label>
            <label class="switch" title="Writing style for description and prompt">
              <span>Style:</span>
              <select id="styleSel" class="btn" style="padding:6px 10px">
                <option value="poetic" selected>Poetic</option>
                <option value="neutral">Neutral</option>
                <option value="technical">Technical</option>
              </select>
            </label>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Professional Description</h3>
            <textarea id="caption" class="mono" placeholder="—" title="Short caption derived from colors, objects, composition."></textarea>
          </div>
          <div>
            <h3>Prompt</h3>
            <textarea id="promptOut" class="mono" placeholder="—" title="Copy into SDXL/Flux/MJ/etc. Includes face ratios + palette if available."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px"><button id="copyPrompt" class="btn">Copy Prompt</button><button id="copyAlt" class="btn">Copy Alt‑text</button></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Objects & OCR</h3>
            <div id="objects" class="outbox mono">—</div>
            <div id="ocr" class="outbox mono" style="margin-top:8px">—</div>
          </div>
          <div>
            <h3>Palette & EXIF</h3>
            <div id="palette" class="outbox mono" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center"></div>
            <div id="exif" class="outbox mono" style="margin-top:8px">—</div>
          </div>
        </div>

        <div class="ad-wrap">
          <ins id="1101622" data-width="auto" data-height="250"></ins>
          <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101622});}catch(e){}</script>
        </div>

        <div class="card" id="faq" style="margin-top:12px">
          <h3>Help & FAQ — hidden in plain sight</h3>
          <details open>
            <summary><strong>What happens to my image?</strong></summary>
            <p class="sub">Analysis is on‑device by default. Export JSON only if you choose. Don’t analyze images without permission; don’t process minors. This tool does <em>not</em> identify people; it provides descriptors for creative generation only.</p>
          </details>
          <details>
            <summary><strong>How accurate are face measurements?</strong></summary>
            <p class="sub">We estimate 468+ landmarks (MediaPipe Face Landmarker) and compute stable ratios (jaw width vs. face height, eye separation vs. eye width, nose height vs. face height). Use them as consistent descriptors rather than biometrics.</p>
          </details>
          <details>
            <summary><strong>What’s in the JSON export?</strong></summary>
            <p class="sub"><code>version</code>, filename, image size; <code>prompt_chunk</code>; <code>caption</code>; <code>palette</code>; <code>landmarks</code> (normalized); <code>measurements</code> ratios; objects & OCR; trimmed EXIF; and an <code>embedding</code> stub.</p>
          </details>
          <details>
            <summary><strong>Can this describe explicit anatomy?</strong></summary>
            <p class="sub">Not on this page. For policy and ad‑safety, we generate <b>non‑explicit</b> descriptions. If you want an age‑gated, no‑ads lab for <b>synthetic</b> (AI‑generated) images only, we can spin a separate <code>/labs</code> tool.</p>
          </details>
        </div>

        <div class="ad-wrap">
          <ins id="1101675" data-width="auto" data-height="90"></ins>
          <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101675});}catch(e){}</script>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Consent Modal ===== -->
  <div id="consent" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <h3>Face Mapping — Consent</h3>
      <p class="sub">Use with consent only. Analysis runs on‑device. This is not an ID matcher.</p>
      <label style="display:flex;align-items:center;gap:8px"><input id="agree" type="checkbox"> <span>I own/have permission to analyze this image.</span></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="deny" class="btn">Cancel</button><button id="accept" class="btn primary" disabled>Accept</button></div>
    </div>
  </div>

  <!-- ===== J1NX FLOAT (canonical look) ===== -->
  <div class="j1nx-float-true" id="j1nxFloatTrue" style="display:none">
    <img src="/j1nx/j1nx_cutout.png" alt="J1NX" class="j1nx-true-cutout-img" id="j1nxCutoutTrue"/>
    <div class="j1nx-bubble-true-main" id="j1nxBubbleTrueMain">
      <div class="j1nx-bubble-text-true" id="j1nxBubbleTextTrue">
        <b>J1NX:</b> Drop a photo, then hit <b>Face Mode</b> or <b>Full‑AI</b>. I’ll narrate and help build your prompt.
      </div>
      <div class="j1nx-bubble-row-true">
        <input class="j1nx-input-true" id="j1nxInputTrue" placeholder="Ask J1NX…" maxlength="140" autocomplete="off"/>
        <button class="j1nx-btn-true" id="j1nxSendTrue">Send</button>
      </div>
      <div class="j1nx-bubble-row-true">
        <button class="j1nx-btn-true" id="j1nxClearTrue">Clear</button>
        <button class="j1nx-btn-true" id="j1nxSaveTrue">Save Chat</button>
      </div>
      <div class="j1nx-easteregg-true" id="j1nxEasterEggTrue">Double‑tap the bubble or type <b>unlock</b> …</div>
    </div>
  </div>

  <!-- ===== ANSI FOOTER (exact vibe) ===== -->
  <footer>
    <pre class="footer-art">
  ____      ____    U  ___ u  __  __    ____    _____    _____   U  ___ u   ____      ____  U _____ u   
 U|  _"\ uU |  _"\ u  \"/_ \/U|' \/ '|uU|  _"\ u|_ " _|  |" ___|   \"/_ \/U |  _"\ uU /"___|u\| ___"|/   
 \| |_) |/ \| |_) |/  | | | |\| |\/| |/\| |_) |/  | |   U| |_  u   | | | | \| |_) |/\| |  _ / |  _|"     
  |  __/    |  _ <.-,_| |_| | | |  | |  |  __/   /| |\  \|  _|/.-,_| |_| |  |  _ <   | |_| |  | |___     
  |_|       |_| \_\\_)-\___/  |_|  |_|  |_|     u |_|U   |_|    \_)-\___/   |_| \_\   \____|  |_____|    
  ||>>_     //   \\_    \\   <<,-,,-.   ||>>_   _// \\_  )(\\,-      \\     //   \\_  _)(|_   <<   >>    
 (__)__)   (__)  (__)  (__)   (./  \.) (__)__) (__) (__)(__)(_/     (__)   (__)  (__)(__)__) (__) (__)   
    </pre>
    <pre class="footer-camo" id="footerCamo"></pre>
    <div class="footer-bar">
      Made underground in BC, Canada • #PromptForge •
      <a href="https://bsky.app/profile/goreandgiggles.bsky.social" target="_blank" rel="noopener">Bluesky</a> •
      <a href="https://x.com/GoreandGiggles" target="_blank" rel="noopener">Twitter/X</a> •
      <a href="/legal.html">Legal</a>
    </div>
  </footer>

  <!-- ===== App Code ===== -->
  <script>
  // ---------- Config (optional remote caption endpoint using Qwen/Qwen3‑Omni etc.)
  const CFG = { qwenEndpoint: "" /* e.g. '/api/qwen-caption' (multipart form: image -> caption) */ };

  // ---------- Lazy loader for JS files
  const Loader = { loaded:new Set(), js(src){return new Promise((res,rej)=>{ if(Loader.loaded.has(src)) return res(); const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>{Loader.loaded.add(src);res();}; s.onerror=()=>rej(new Error('Failed '+src)); document.head.appendChild(s); });} };

  // ---------- Elements & State
  const els = {
    file:$('#file'), chooseBtn:$('#chooseBtn'),
    preview:$('#preview'), overlay:$('#overlay'), legend:$('#legend'),
    analyze:$('#analyze'), enableFace:$('#enable-face'), enableAI:$('#enable-ai'), gridToggle:$('#gridToggle'),
    analyze2:$('#analyze2'), enableFace2:$('#enable-face2'), enableAI2:$('#enable-ai2'),
    remoteCap:$('#remoteCap'),
    progress:$('#progress'),
    caption:$('#caption'), promptOut:$('#promptOut'),
    objects:$('#objects'), ocr:$('#ocr'),
    palette:$('#palette'), exif:$('#exif'),
    build:$('#build'), exportJSON:$('#exportJSON'),
    copyPrompt:$('#copyPrompt'), copyAlt:$('#copyAlt'),
    consent:$('#consent'), agree:$('#agree'), accept:$('#accept'), deny:$('#deny'),
    lenSlider:$('#lenSlider'), lenVal:$('#lenVal'), styleSel:$('#styleSel'),
    jOpen:$('#toggleJ1NX'), jWrap:$('#j1nxFloatTrue'), jBubble:$('#j1nxBubbleTextTrue'), jInput:$('#j1nxInputTrue'), jSend:$('#j1nxSendTrue'), jClear:$('#j1nxClearTrue'), jSave:$('#j1nxSaveTrue'), jEgg:$('#j1nxEasterEggTrue')
  };
  const ctx = els.preview.getContext('2d');
  const octx = els.overlay.getContext('2d');
  const state = { imgEl:null, imgName:'', imgW:0, imgH:0, draw:{dx:0,dy:0,dw:0,dh:0}, faceEnabled:false, fullAIEnabled:false, consentOK:false, gridOn:true,
                  face:{landmarks:[], ratios:{}, attrs:{}}, det:{objects:[], ocr:'', exif:{}, palette:[]}, timers:{scan:null, pulse:null},
                  targetLen:240, style:'poetic' };
  function $(id){ return document.getElementById(id.replace('#','')) || document.querySelector(id); }
  function note(m){ els.progress.textContent = m; }

  // ---------- Draw fitted image + remember draw rect
  function fitDrawImage(img){
    const cw=els.preview.width, ch=els.preview.height; ctx.clearRect(0,0,cw,ch); octx.clearRect(0,0,cw,ch);
    const ar=img.width/img.height, car=cw/ch; let dw,dh,dx,dy; if(ar>car){ dw=cw; dh=cw/ar; dx=0; dy=(ch-dh)/2; } else { dh=ch; dw=ch*ar; dy=0; dx=(cw-dw)/2; }
    ctx.drawImage(img,dx,dy,dw,dh); state.draw={dx,dy,dw,dh}; state.imgW=img.width; state.imgH=img.height;
  }

  // ---------- Grid + scan line + attention pulse
  function drawGrid(){ if(!state.gridOn) return; const {dx,dy,dw,dh}=state.draw; const step=dw/18; octx.save(); octx.strokeStyle='rgba(100,242,227,0.18)'; octx.lineWidth=1; for(let x=dx; x<=dx+dw; x+=step){ octx.beginPath(); octx.moveTo(x,dy); octx.lineTo(x,dy+dh); octx.stroke(); } for(let y=dy; y<=dy+dh; y+=step){ octx.beginPath(); octx.moveTo(dx,y); octx.lineTo(dx+dw,y); octx.stroke(); } octx.restore(); }
  function startScan(){ stopScan(); let y=0, t=0; state.timers.scan=setInterval(()=>{ octx.clearRect(0,0,els.overlay.width,els.overlay.height); drawGrid(); octx.fillStyle='rgba(35,215,186,0.14)'; octx.fillRect(0,y,els.overlay.width,8); // pulse dot following the bar
    const px = state.draw.dx + (Math.sin(t/18)*.5+.5)*state.draw.dw; const py=y+4; octx.beginPath(); octx.arc(px,py,6,0,Math.PI*2); octx.fillStyle='rgba(100,242,227,0.75)'; octx.fill(); y=(y+3)%els.overlay.height; t++; },16); }
  function stopScan(){ if(state.timers.scan){ clearInterval(state.timers.scan); state.timers.scan=null; octx.clearRect(0,0,els.overlay.width,els.overlay.height);} }

  // ---------- Utils
  const toHex=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  const ratio=(a,b)=> b? +(a/b).toFixed(4):0;
  const clampToChars=(txt,n)=>{ if(!txt) return ''; if(txt.length<=n) return txt; const p1 = txt.slice(0,n); const cut = Math.max(p1.lastIndexOf('. '), p1.lastIndexOf(', '), p1.lastIndexOf(' ')); return (cut>80?txt.slice(0,cut):p1).replace(/[\s\.,;:-]+$/,'')+'…'; };
  const stylize=(base)=>{ switch(state.style){ case 'neutral': return base.replace(/—|–/g,'-'); case 'technical': return base+" Lighting: even; Focus: sharp; Composition: center-weighted."; default: return base; } };

  // ---------- File load + EXIF
  els.chooseBtn.addEventListener('click',()=>els.file.click());
  els.file.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f) return; state.imgName=f.name||'image';
    const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ state.imgEl=img; fitDrawImage(img); [els.analyze,els.analyze2].forEach(b=>b.disabled=false); note('Ready. Pick modes, then Run.'); URL.revokeObjectURL(url); }; img.src=url;
    try{ await Loader.js('https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.min.js'); const ab=await f.arrayBuffer(); const tags=window.ExifReader?ExifReader.load(ab):{}; state.det.exif=tags||{}; const out=[]; ['Make','Model','LensModel','FNumber','ExposureTime','ISOSpeedRatings','DateTimeOriginal'].forEach(k=>{ if(tags[k]) out.push(`${k}: ${tags[k].description||tags[k].value}`); }); els.exif.textContent=out.join('\n')||'—'; }catch(err){ els.exif.textContent='—'; }
  });

  // ---------- Face Mode (MediaPipe)
  async function ensureFace(){ if(!state.consentOK){ els.consent.classList.add('open'); return false; } if(window._pfFace) return true; note('Loading face landmarker…'); await Loader.js('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14'); const vision = await window.tasksVision.FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'); window._pfFace = await window.tasksVision.FaceLandmarker.createFromOptions(vision, { baseOptions:{modelAssetPath:'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/face_landmarker.task'}, numFaces:1, runningMode:'IMAGE', outputFaceBlendshapes:false, outputFacialTransformationMatrixes:false }); return true; }
  function mpDist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function canvasPt(p){ const {dx,dy,dw,dh}=state.draw; return { x: dx + p.x*dw, y: dy + p.y*dh } }
  function drawFaceDots(lm){ octx.save(); octx.strokeStyle='rgba(100,242,227,.9)'; octx.lineWidth=1.2; octx.beginPath(); lm.forEach(p=>{ const {x,y}=canvasPt(p); octx.moveTo(x,y); octx.arc(x,y,0.9,0,Math.PI*2); }); octx.stroke(); octx.restore(); }
  function drawFaceBox(lm){ const xs=lm.map(p=>canvasPt(p).x), ys=lm.map(p=>canvasPt(p).y); const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys); octx.save(); octx.strokeStyle='rgba(100,242,227,.55)'; octx.strokeRect(minX,minY,maxX-minX,maxY-minY); octx.restore(); return {minX,maxX,minY,maxY}; }
  function sampleAvgRect(imgRect){ const {minX,maxX,minY,maxY}=imgRect; const w=maxX-minX,h=maxY-minY; const sx=Math.max(0,minX|0), sy=Math.max(0,minY|0), sw=Math.max(1,w|0), sh=Math.max(1,h|0); const tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh; const tctx=tmp.getContext('2d'); tctx.drawImage(els.preview, sx, sy, sw, sh, 0, 0, sw, sh); const d=tctx.getImageData(0,0,sw,sh).data; let r=0,g=0,b=0,n=0; for(let i=0;i<d.length;i+=4){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; } return toHex((r/n)|0,(g/n)|0,(b/n)|0); }
  async function runFace(){ if(!state.imgEl) return; if(!(await ensureFace())) return; startScan(); const res = await window._pfFace.detect(state.imgEl); stopScan(); octx.clearRect(0,0,els.overlay.width,els.overlay.height); if(state.gridOn) drawGrid(); if(!res || !res.faceLandmarks || !res.faceLandmarks.length){ note('No face found.'); state.face.landmarks=[]; state.face.ratios={}; return; } const lm=res.faceLandmarks[0]; drawFaceDots(lm); const bbox=drawFaceBox(lm);
    // ratios
    const IDX={ chin:152, top:10, leftJaw:234, rightJaw:454, leftEyeIn:133, rightEyeIn:362, leftEyeOut:33, rightEyeOut:263, noseTip:1 };
    const faceH=mpDist(lm[IDX.top],lm[IDX.chin]); const jawW=mpDist(lm[IDX.leftJaw],lm[IDX.rightJaw]); const eyeSep=mpDist(lm[IDX.leftEyeIn],lm[IDX.rightEyeIn]); const eyeW=(mpDist(lm[IDX.leftEyeIn],lm[IDX.leftEyeOut])+mpDist(lm[IDX.rightEyeIn],lm[IDX.rightEyeOut]))/2; const noseH=mpDist(lm[IDX.top],lm[IDX.noseTip]);
    state.face.landmarks = lm.map(p=>[+p.x.toFixed(5), +p.y.toFixed(5), +(p.z||0).toFixed(5)]);
    state.face.ratios = { jaw_to_face:ratio(jawW,faceH), eyeSep_to_eyeW:ratio(eyeSep,eyeW), nose_to_face:ratio(noseH,faceH) };
    els.legend.textContent = `Ratios • jaw/face ${state.face.ratios.jaw_to_face} • eye‑sep/eye‑width ${state.face.ratios.eyeSep_to_eyeW} • nose/face ${state.face.ratios.nose_to_face}`;
    // simple attributes (non‑explicit): hair hue via top strip of bbox
    const hairRect={minX:bbox.minX, maxX:bbox.maxX, minY:Math.max(0,bbox.minY-0.18*(bbox.maxY-bbox.minY)), maxY:bbox.minY};
    state.face.attrs.hairColor = sampleAvgRect(hairRect);
    note('Face mesh complete.'); }

  // ---------- Full‑AI (objects + OCR) with live boxes
  async function ensureFullAI(){ if(window._pfDetLoaded) return true; note('Loading detectors…'); await Loader.js('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js'); await Loader.js('https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2'); await Loader.js('https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js'); window._pfDetLoaded=true; return true; }
  function drawBox(x,y,w,h, label, score){ octx.save(); octx.strokeStyle='rgba(100,242,227,.9)'; octx.lineWidth=1.4; octx.strokeRect(x,y,w,h); if(label){ octx.fillStyle='rgba(8,20,28,.9)'; octx.fillRect(x,y-16, Math.max(44, label.length*7+30), 16); octx.fillStyle='#64f2e3'; octx.font='12px ui-monospace,monospace'; octx.fillText(`${label}${score!==undefined?` ${score}`:''}`, x+6, y-4); } octx.restore(); }
  async function runObjects(){ if(!state.imgEl) return []; await ensureFullAI(); const model = await cocoSsd.load({base:'lite_mobilenet_v2'}); startScan(); const preds = await model.detect(els.preview); stopScan(); if(state.gridOn) drawGrid(); preds.forEach(p=>{ const [bx,by,bw,bh]=p.bbox; drawBox(bx,by,bw,bh,p.class, +p.score.toFixed(2)); }); return preds.map(p=>({label:p.class, score:+p.score.toFixed(3), box:p.bbox})); }
  async function runOCR(){ if(!state.imgEl) return ''; await ensureFullAI(); startScan(); const r = await Tesseract.recognize(els.preview,'eng',{logger:()=>{}}); stopScan(); if(state.gridOn) drawGrid(); try{ const words=r.data.words||[]; words.forEach(w=>{ if(w.bbox){ drawBox(w.bbox.x0,w.bbox.y0,w.bbox.x1-w.bbox.x0,w.bbox.y1-w.bbox.y0, w.text); } }); }catch(e){} return (r && r.data && r.data.text ? r.data.text.trim() : '') || ''; }

  // ---------- Palette
  async function buildPalette(){ if(!window.ColorThief) await Loader.js('https://cdn.jsdelivr.net/npm/color-thief-browser@2.0.2/dist/color-thief.umd.js'); try{ const tmp=document.createElement('canvas'); tmp.width=state.imgEl.width; tmp.height=state.imgEl.height; tmp.getContext('2d').drawImage(state.imgEl,0,0); const img2=new Image(); img2.src=tmp.toDataURL('image/jpeg'); await img2.decode(); const thief=new ColorThief(); const pal=thief.getPalette(img2,6); state.det.palette=pal.map(([r,g,b])=>toHex(r,g,b)); els.palette.innerHTML=state.det.palette.map(hex=>`<span style="display:inline-flex;align-items:center;gap:6px;border:1px solid #123;padding:6px 8px;border-radius:8px"><i style=\"width:18px;height:18px;border-radius:4px;background:${hex};display:inline-block\"></i><code>${hex}</code></span>`).join(' ');}catch(e){ els.palette.textContent='—'; } }

  // ---------- Caption & Prompt
  function heuristicCaption(){ const colors=(state.det.palette||[]).slice(0,3).join(', '); const objects=(state.det.objects||[]).filter(o=>o.score>0.4).slice(0,4).map(o=>o.label).join(', '); let base = objects?`A well‑composed photograph featuring ${objects}${colors?` in tones of ${colors}`:''}.`:`A quiet, well‑composed photograph${colors?` in tones of ${colors}`:''}.`; base = stylize(base); return clampToChars(base, state.targetLen); }
  function buildPrompt(){ const tags=(state.det.objects||[]).filter(o=>o.score>0.4).map(o=>o.label); const r=state.face.ratios||{}; const palette=(state.det.palette||[]).slice(0,3).join(', '); const hair=state.face.attrs?.hairColor; let cap=els.caption.value.trim(); if(!cap) cap=heuristicCaption(); else cap=clampToChars(stylize(cap), state.targetLen); els.caption.value=cap; const parts=[cap]; if(tags.length) parts.push(`objects: ${tags.join(', ')}`); if(palette) parts.push(`palette: ${palette}`); if(hair) parts.push(`hair-hint: ${hair}`); const chunk=[]; if(r.jaw_to_face) chunk.push(`jaw/face ${r.jaw_to_face}`); if(r.eyeSep_to_eyeW) chunk.push(`eye‑sep/eye‑width ${r.eyeSep_to_eyeW}`); if(r.nose_to_face) chunk.push(`nose/face ${r.nose_to_face}`); if(chunk.length) parts.push(`face‑ratios: ${chunk.join(' • ')}`); const prompt = clampToChars(parts.filter(Boolean).join(' \n '), Math.max(160, state.targetLen+80)); els.promptOut.value=prompt; return prompt; }

  // ---------- Export JSON
  function exportJSON(){ const data={ version:'pf_imageintel_3', filename:state.imgName, image:{width:state.imgW,height:state.imgH}, prompt_chunk:els.promptOut.value, caption:els.caption.value, palette:state.det.palette, landmarks:state.face.landmarks, measurements:state.face.ratios, attrs:state.face.attrs, objects:state.det.objects, ocr:state.det.ocr, exif: state.det.exif? Object.fromEntries(Object.entries(state.det.exif).slice(0,40).map(([k,v])=>[k, v && (v.description||v.value||'')])) : {}, embedding:{type:'stub',dims:0} }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(state.imgName||'image')+'.pf_imageintel.json'; a.click(); URL.revokeObjectURL(a.href); }

  // ---------- Remote Caption (optional server using Qwen/Qwen3‑Omni)
  async function remoteCaption(){ if(!CFG.qwenEndpoint){ note('Remote caption not configured. Set CFG.qwenEndpoint.'); return; } if(!state.imgEl){ note('Load an image first.'); return; } try{ note('Sending to remote caption…'); const blob = await new Promise(r=>els.preview.toBlob(r,'image/jpeg',0.92)); const fd=new FormData(); fd.append('image', blob, state.imgName||'image.jpg'); const res=await fetch(CFG.qwenEndpoint,{method:'POST',body:fd}); const j=await res.json(); if(j && j.caption){ els.caption.value = clampToChars(stylize(j.caption), state.targetLen); buildPrompt(); note('Remote caption received.'); } else { note('Remote caption failed: bad response.'); } }catch(e){ note('Remote caption error.'); } }

  // ---------- Wire UI
  function mirror(srcBtn, dstBtn){ dstBtn.addEventListener('click', ()=>srcBtn.click()); }
  mirror(els.analyze, els.analyze2); mirror(els.enableFace, els.enableFace2); mirror(els.enableAI, els.enableAI2);
  els.gridToggle.addEventListener('change',()=>{ state.gridOn = !!els.gridToggle.checked; if(!state.timers.scan){ octx.clearRect(0,0,els.overlay.width,els.overlay.height); if(state.gridOn) drawGrid(); } });
  els.enableFace.addEventListener('click',async()=>{ state.faceEnabled=!state.faceEnabled; els.enableFace.classList.toggle('primary',state.faceEnabled); els.enableFace2.classList.toggle('primary',state.faceEnabled); if(state.faceEnabled && state.imgEl){ if(!state.consentOK){ els.consent.classList.add('open'); } else { await runFace(); } } note(state.faceEnabled?'Face Mode enabled.':'Face Mode disabled.'); });
  els.enableAI.addEventListener('click',async()=>{ state.fullAIEnabled=!state.fullAIEnabled; els.enableAI.classList.toggle('primary',state.fullAIEnabled); els.enableAI2.classList.toggle('primary',state.fullAIEnabled); if(state.fullAIEnabled){ await ensureFullAI(); note('Full‑AI ready. Click Run.'); } else { note('Full‑AI disabled.'); } });
  [els.analyze, els.analyze2].forEach(btn=>btn.addEventListener('click', async()=>{ if(!state.imgEl){ note('Choose an image first.'); return; } startScan(); try{ await buildPalette(); }catch(e){} if(state.faceEnabled){ await runFace(); } if(state.fullAIEnabled){ try{ state.det.objects=await runObjects(); }catch(e){ state.det.objects=[]; } try{ state.det.ocr=await runOCR(); }catch(e){ state.det.ocr=''; } els.objects.textContent=(state.det.objects||[]).map(o=>`${o.label} (${o.score})`).join(', ')||'—'; els.ocr.textContent=state.det.ocr||'—'; } if(!els.caption.value) els.caption.value=heuristicCaption(); buildPrompt(); stopScan(); note('Done. Build or Export next.'); }));
  els.remoteCap.addEventListener('click', remoteCaption);
  els.build.addEventListener('click',()=>{ buildPrompt(); note('Prompt refreshed.'); });
  els.exportJSON.addEventListener('click',()=>exportJSON());
  els.copyPrompt.addEventListener('click',()=>{ navigator.clipboard.writeText(els.promptOut.value||''); note('Prompt copied.'); });
  els.copyAlt.addEventListener('click',()=>{ navigator.clipboard.writeText(els.caption.value||''); note('Alt‑text copied.'); });
  els.lenSlider.addEventListener('input',(e)=>{ state.targetLen=+e.target.value; els.lenVal.textContent = `≈${state.targetLen} chars`; if(els.caption.value) els.caption.value = clampToChars(stylize(els.caption.value), state.targetLen); });
  els.styleSel.addEventListener('change',(e)=>{ state.style=e.target.value; if(els.caption.value) els.caption.value = clampToChars(stylize(els.caption.value), state.targetLen); });

  // ---------- Consent
  els.agree.addEventListener('change',()=>{ els.accept.disabled=!els.agree.checked; });
  els.accept.addEventListener('click',()=>{ state.consentOK=true; els.consent.classList.remove('open'); if(state.faceEnabled) runFace(); });
  els.deny.addEventListener('click',()=>{ els.consent.classList.remove('open'); state.faceEnabled=false; els.enableFace.classList.remove('primary'); els.enableFace2.classList.remove('primary'); });

  // ---------- J1NX helper
  els.jOpen.addEventListener('click',()=>{ els.jWrap.style.display = (els.jWrap.style.display==='none'?'flex':'none'); });
  const say=(t)=>{ els.jBubble.innerHTML += '<br/>'+(t||'').replace(/</g,'&lt;'); els.jBubble.scrollTop=els.jBubble.scrollHeight; };
  els.jSend?.addEventListener('click',()=>{ const v=els.jInput.value.trim(); if(!v) return; say('<b>You:</b> '+v); els.jInput.value=''; });
  els.jClear?.addEventListener('click',()=>{ els.jBubble.innerHTML='<b>J1NX:</b> Reset. What\'s next?'; });
  els.jSave?.addEventListener('click',()=>{ const blob=new Blob([els.jBubble.textContent||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='j1nx_chat.txt'; a.click(); URL.revokeObjectURL(a.href); });
  (function(){ let taps=0,tid; els.jWrap?.addEventListener('click',()=>{ clearTimeout(tid); taps++; tid=setTimeout(()=>{ if(taps>=2){ els.jEgg.textContent='NSFW hint unlocked (demo): try the labs when available.'; els.jEgg.style.opacity=1; } taps=0; },240); },{passive:true}); })();

  // ---------- Footer camo animation
  (function(){ const camoEl=document.getElementById('footerCamo'); if(!camoEl) return; const colors=["#64f2e3","#23d7ba","#be9cff","#ffd166"]; let i=0; setInterval(()=>{ camoEl.textContent = ['█▄▀','▞▚','▓▒░','◢◣◥◤'][i%4].repeat(28); camoEl.style.color=colors[i%colors.length]; i++; }, 380); })();
  </script>
</body>
</html>
