<!-- /imageintel.html — ImageIntel Pro Lab (r7)
  * Critical: **classic script** (no module) so UI always boots. Dynamic `import()` runs later.
  * If import fails, you still get: upload/drag/paste, self-test, overlay test, edge overlay, fallback prompt.
  * When import & models init, Run Analysis draws Objects + Pose + Face and generates full prompt.
  * Added Matrix Test + Copy Bug Bundle for easy debugging.
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ImageIntel Pro Lab — BlackSite HUD</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{--bg:#070a0f;--grid:rgba(255,255,255,.04);--panel:#0d121a;--muted:#94a3b8;--text:#e6f1ff;--chip:#101826}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 1200px at 10% -10%,#0c1420,var(--bg)) fixed;color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:28px 28px;mask-image:radial-gradient(1000px 700px at 10% 0%,#000 80%,transparent)}
.app{position:relative;z-index:1;height:100%;display:grid;gap:12px;padding:12px;grid-template-columns:1.25fr .75fr;grid-template-rows:62% 38%;grid-template-areas:"stage side" "kpi side"}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.005));border:1px solid rgba(255,255,255,.08);border-radius:18px;backdrop-filter:blur(6px)}
.title{font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:11px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.col{display:grid;gap:8px}
.chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;font-size:12px;color:#b6cdfb}
.btn{background:linear-gradient(180deg,rgba(62,248,255,.15),rgba(62,248,255,.06));border:1px solid rgba(62,248,255,.45);color:#cfffff;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{border-color:rgba(102,255,153,.45);background:linear-gradient(180deg,rgba(102,255,153,.16),rgba(102,255,153,.06));color:#dbffe8}
.btn.warn{border-color:rgba(255,209,102,.45);background:linear-gradient(180deg,rgba(255,209,102,.16),rgba(255,209,102,.06));color:#fff3cf}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
.toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
.toggle input{appearance:none;width:30px;height:18px;border-radius:999px;background:#15202f;border:1px solid rgba(255,255,255,.2);position:relative}
.toggle input:checked{background:#0e2c2c;border-color:rgba(62,248,255,.5)}
.toggle input::after{content:"";position:absolute;top:1px;left:1px;width:14px;height:14px;background:#9aa7bd;border-radius:50%;transition:160ms}
.toggle input:checked::after{left:calc(100% - 15px);background:#72ffd5}
#stage{grid-area:stage;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
.stage-head{padding:10px;display:flex;align-items:center;justify-content:space-between}
.canvas-wrap{position:relative;overflow:hidden;background:#0b0f14;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);height:100%;min-height:340px}
#inputImage{max-width:100%;max-height:100%;display:block;object-fit:contain}
#overlay{position:absolute;left:0;top:0;image-rendering:pixelated}
.drop{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,.15);border-radius:12px;color:#9fb5d8;pointer-events:none;opacity:.18}
.loaded{border-color:rgba(102,255,153,.45)!important;color:#d7ffe8!important;opacity:.22}
#kpis{grid-area:kpi;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px;overflow:auto}
.kpi{background:#0d121a;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;min-height:120px;display:grid;grid-template-rows:auto 1fr}
.list{display:grid;gap:6px;font-size:12px}.pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between}
#side{grid-area:side;display:grid;grid-template-rows:auto 1fr auto}
#terminal{height:160px;overflow:auto;background:#05070b;border-top:1px solid rgba(255,255,255,.08);padding:8px;font:12px ui-monospace,Menlo,Consolas;color:#b0c3e6}
.log.ok{color:#5cff7a}.log.err{color:#ff4d6d}
.statusbar{display:flex;gap:6px;flex-wrap:wrap}.statusbar .chip.ok{border-color:rgba(102,255,153,.45);color:#d5ffe5}.statusbar .chip.err{border-color:rgba(255,77,109,.45);color:#ffd0da}
textarea{width:100%;resize:vertical;background:#05070b;color:#e6f1ff;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
pre#diagDump{max-height:160px;overflow:auto;background:#03050a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;color:#cfe1ff}
details{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;background:#0c1118}
details+details{margin-top:8px}
details>summary{cursor:pointer;color:#c5d7f2}
.compact .hide-when-compact{display:none}
.header-actions{display:flex;gap:8px;align-items:center}
.errbanner{position:fixed;left:12px;right:12px;bottom:12px;background:#2a0f12;border:1px solid #ff4d6d;color:#ffdbe2;padding:10px;border-radius:12px;z-index:9999;display:none}
</style>
</head>
<body>
<div class="app">
  <section id="stage" class="card">
    <div class="stage-head">
      <div class="row">
        <span class="title">BLACKSITE HUD</span>
        <span class="chip">Objects</span><span class="chip">Pose</span><span class="chip">Face</span><span class="chip">Hands</span><span class="chip">Body Mesh</span><span class="chip">Silhouette</span><span class="chip">Seg</span><span class="chip">Edges</span>
        <span class="chip" id="fpsChip">FPS — n/a</span>
      </div>
      <div class="header-actions">
        <input id="file" type="file" accept="image/*" style="display:none"/>
        <label class="btn" for="file">Upload Image</label>
        <button id="runBtn" class="btn secondary" disabled>Run Analysis</button>
        <label class="toggle"><input id="compactUI" type="checkbox" checked><span>Compact UI</span></label>
      </div>
    </div>
    <div class="canvas-wrap" id="canvasWrap">
      <img id="inputImage" alt="input"/>
      <canvas id="overlay"></canvas>
      <div class="drop" id="dropHint">Drop / Paste an image here</div>
    </div>
    <div class="panel-body" style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:10px;">
      <div class="statusbar">
        <span class="chip" id="st-wasm">WASM — …</span>
        <span class="chip" id="st-obj">Object — …</span>
        <span class="chip" id="st-pose">Pose — …</span>
        <span class="chip" id="st-face">Face — …</span>
        <span class="chip" id="st-hands">Hands — …</span>
        <span class="chip" id="st-seg">Seg — …</span>
        <span class="chip" id="st-image">Image — …</span>
        <span class="chip" id="st-run">Detectors — …</span>
      </div>
      <div class="row">
        <button id="exportPng" class="btn">PNG</button>
        <button id="exportMasked" class="btn">Masked PNG</button>
        <button id="exportJson" class="btn">Report .json</button>
      </div>
    </div>
  </section>

  <section id="kpis" class="card">
    <div class="kpi"><h4 class="title">Subject</h4><div class="list" id="subjectList"></div></div>
    <div class="kpi"><h4 class="title">Objects</h4><div class="list" id="objectList"></div></div>
    <div class="kpi"><h4 class="title">Pose</h4><div class="list" id="poseList"></div></div>
    <div class="kpi"><h4 class="title">Color / Lighting</h4><div class="list" id="colorList"></div></div>
  </section>

  <aside id="side" class="card">
    <details open>
      <summary>Overlays & Controls</summary>
      <div class="row">
        <label class="toggle"><input id="tgObjects" type="checkbox" checked><span>Objects</span></label>
        <label class="toggle"><input id="tgPose" type="checkbox" checked><span>Pose</span></label>
        <label class="toggle"><input id="tgFace" type="checkbox" checked><span>Face</span></label>
        <label class="toggle"><input id="tgHands" type="checkbox" checked><span>Hands</span></label>
        <label class="toggle"><input id="tgBody" type="checkbox" checked><span>Body Mesh</span></label>
        <label class="toggle"><input id="tgSil" type="checkbox" checked><span>Silhouette</span></label>
        <label class="toggle"><input id="tgSeg" type="checkbox" checked><span>Seg</span></label>
        <label class="toggle"><input id="tgEdges" type="checkbox" checked><span>Edges</span></label>
        <label class="toggle" title="Force CPU delegates"><input id="safeMode" type="checkbox" checked><span>Safe Mode</span></label>
      </div>
    </details>

    <details open>
      <summary>Prompt Engine</summary>
      <div class="row">
        <div class="col" style="min-width:180px;">
          <label>Prompt Mode</label>
          <select id="mode">
            <option value="sfw">SFW</option>
            <option value="nsfw_safe">NSFW-safe (redacted)</option>
            <option value="edgy">Edgy</option>
            <option value="poetic">Poetic</option>
            <option value="numeric">Numeric</option>
            <option value="json">Raw JSON</option>
          </select>
        </div>
        <div class="col" style="min-width:180px;">
          <label>Model Style</label>
          <select id="modelStyle">
            <option value="generic">Generic</option>
            <option value="sdxl">SDXL-like</option>
            <option value="jugger">JuggernautXL-like</option>
          </select>
        </div>
        <div class="col" style="min-width:180px;">
          <label>Style Pack</label>
          <select id="stylePack">
            <option value="neutral">Neutral</option>
            <option value="tealorange">Cinematic Teal/Orange</option>
            <option value="pastel">Soft Pastel</option>
            <option value="mono">High-Contrast Mono</option>
            <option value="vintage">Warm Vintage</option>
          </select>
        </div>
        <div class="col" style="min-width:200px;"><label>Detail</label><input id="detail" type="range" min="0" max="100" step="1" value="85"/></div>
      </div>
      <div class="panel-head" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;">
        <span class="title">Prompt Output</span><span class="chip" id="promptChars">0 chars</span>
      </div>
      <textarea id="promptOut" rows="6" placeholder="Run analysis to generate a prompt…"></textarea>

      <div class="panel-head" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;">
        <span class="title">Compare Prompts — A / B / C</span>
        <div class="row"><button id="genABC" class="btn">Generate A/B/C</button><button id="copyABC" class="btn">Copy All</button></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div class="col"><label class="title">A</label><textarea id="pA" rows="6"></textarea></div>
        <div class="col"><label class="title">B</label><textarea id="pB" rows="6"></textarea></div>
        <div class="col"><label class="title">C</label><textarea id="pC" rows="6"></textarea></div>
      </div>

      <div class="row hide-when-compact">
        <button id="copyPrompt" class="btn">Copy Prompt</button>
        <button id="downloadPrompt" class="btn">Download .txt</button>
      </div>
    </details>

    <details open>
      <summary>Diagnostics</summary>
      <pre id="diagDump" class="slab" aria-label="Diagnostics Output"></pre>
      <div class="row"><span class="title">NSFW Gate</span><span class="chip" id="nsfwGate">Disabled</span></div>
      <div id="terminal"></div>
      <div class="row">
        <button id="overlayTest" class="btn ghost">Overlay Test</button>
        <button id="matrixTest" class="btn">Matrix Test</button>
        <button id="reinit" class="btn warn">Re-Init Models</button>
        <button id="selfTest" class="btn">Self-Test</button>
        <button id="copyDiag" class="btn">Copy Diag</button>
        <button id="copyBundle" class="btn">Copy Bug Bundle</button>
      </div>
    </details>
  </aside>
</div>
<div id="errbanner" class="errbanner"></div>

<script>
// ===== EARLY UI (classic script) — always runs
(function(){
  var $=function(id){return document.getElementById(id)};
  var img=$('inputImage'), wrap=$('canvasWrap'), canvas=$('overlay'), ctx=canvas.getContext('2d',{willReadFrequently:true});
  var fileInput=$('file'), runBtn=$('runBtn'), diag=$('diagDump'), logEl=$('terminal'), fpsChip=$('fpsChip');
  var dropHint=$('dropHint');
  var status={wasm:$('st-wasm'),obj:$('st-obj'),pose:$('st-pose'),face:$('st-face'),hands:$('st-hands'),seg:$('st-seg'),image:$('st-image'),run:$('st-run')};
  var STATE={modelsReady:false,imageReady:false};
  window.__BUNDLE={};

  function showBanner(msg){ var b=document.getElementById('errbanner'); b.textContent=msg; b.style.display='block'; setTimeout(function(){b.style.display='none'},8000); }
  window.addEventListener('error',function(e){ (window.__BUNDLE.errors||(window.__BUNDLE.errors=[])).push('JS:'+e.message); showBanner('JS error: '+e.message); });
  window.addEventListener('unhandledrejection',function(e){ var m='Promise: '+(e.reason&&e.reason.message?e.reason.message:e.reason); (window.__BUNDLE.errors||(window.__BUNDLE.errors=[])).push(m); showBanner(m); });

  function log(m,ok){ var d=document.createElement('div'); d.textContent=m; d.className='log'+(ok===true?' ok':ok===false?' err':''); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
  function chip(el,ok,labelOK,labelERR){ el.textContent=ok?(labelOK||'OK'):(labelERR||'ERR'); el.classList.toggle('ok',!!ok); el.classList.toggle('err',!ok); }
  function resize(){ if(!img.naturalWidth) return; var r=wrap.getBoundingClientRect(); var ia=img.naturalWidth/img.naturalHeight, ra=r.width/r.height; var w,h; if(ia>ra){w=r.width;h=w/ia;} else {h=r.height;w=h*ia;} canvas.width=w|0; canvas.height=h|0; img.style.width=w+'px'; img.style.height=h+'px'; }
  function drawEdges(alpha){ var w=canvas.width,h=canvas.height; if(!w||!h) return; var oc=document.createElement('canvas'); oc.width=w; oc.height=h; var ox=oc.getContext('2d',{willReadFrequently:true}); ox.drawImage(img,0,0,w,h); var src=ox.getImageData(0,0,w,h); var out=ox.createImageData(w,h); var Gx=[-1,0,1,-2,0,2,-1,0,1], Gy=[-1,-2,-1,0,0,0,1,2,1]; for(var y=1;y<h-1;y++){ for(var x=1;x<w-1;x++){ var sx=0,sy=0,pi=0; for(var ky=-1;ky<=1;ky++){ for(var kx=-1;kx<=1;kx++){ var ix=((y+ky)*w+(x+kx))*4; var lum=0.2126*src.data[ix]+0.7152*src.data[ix+1]+0.0722*src.data[ix+2]; sx+=lum*Gx[pi]; sy+=lum*Gy[pi]; pi++; }} var m=Math.min(255,Math.hypot(sx,sy)); var o=(y*w+x)*4; out.data[o]=out.data[o+1]=out.data[o+2]=m; out.data[o+3]=m>40?255:0; }} ox.putImageData(out,0,0); ctx.save(); ctx.globalAlpha=alpha||0.4; ctx.drawImage(oc,0,0); ctx.restore(); }
  function analyzeColor(el){ var c=document.createElement('canvas'),cx=c.getContext('2d'); var w=el.naturalWidth,h=el.naturalHeight; if(!w||!h) return null; var s=Math.min(1,180/Math.max(w,h)); c.width=Math.max(1,(w*s)|0); c.height=Math.max(1,(h*s)|0); cx.drawImage(el,0,0,c.width,c.height); var d=cx.getImageData(0,0,c.width,c.height).data; var lum=0,n=0; for(var i=0;i<d.length;i+=24){ lum+=(0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2])/255; n++; } var L=lum/(n||1); return {avg_brightness:+L.toFixed(3), lighting:(L>0.7?'bright':(L<0.35?'dim':'moderate'))}; }
  function fallbackPrompt(){ var c=analyzeColor(img); var pos='photorealistic, subject centered'+(c?(', '+c.lighting+' lighting'):''); var out=pos+'
NEGATIVE: lowres, blur, watermark'; $('promptOut').value=out; $('promptChars').textContent=out.length+' chars'; }

  function onImageLoaded(){ resize(); chip(status.image,true,'Image — OK'); STATE.imageReady=true; log('Image loaded ✓',true); ctx.clearRect(0,0,canvas.width,canvas.height); drawEdges(0.45); fallbackPrompt(); runBtn.disabled=false; }
  function isImg(f){ return f && f.type && /^image\//i.test(f.type); }
  function readAsDataURL(file){ return new Promise(function(res,rej){ var fr=new FileReader(); fr.onerror=function(){rej(fr.error)}; fr.onload=function(){res(fr.result)}; fr.readAsDataURL(file); }); }
  function fileToDataUrlViaBitmap(file){ return createImageBitmap(file).then(function(bmp){ var c=document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height; var cx=c.getContext('2d'); cx.drawImage(bmp,0,0); return c.toDataURL('image/png'); }).catch(function(){ return null; }); }
  async function loadFile(file){ if(!file){ log('No file picked',false); return; } if(!isImg(file)){ log('Unsupported file: '+(file.type||'unknown'),false); chip(status.image,false,'Image — ERR'); return; } var url=null; try{ url=await fileToDataUrlViaBitmap(file); if(!url) url=await readAsDataURL(file); }catch(e){ log('Decode fallback failed: '+e.message,false); }
    if(!url){ log('Could not decode image',false); chip(status.image,false,'Image — ERR'); return; }
    img.decoding='async'; img.loading='eager'; img.onload=onImageLoaded; img.onerror=function(){ log('Image error: cannot decode/display',false); chip(status.image,false,'Image — ERR'); STATE.imageReady=false; }; img.src=url; }

  // Upload bindings (always active)
  $('canvasWrap').addEventListener('dragover',function(e){ e.preventDefault(); $('dropHint').style.opacity='.38'; });
  $('canvasWrap').addEventListener('dragleave',function(e){ e.preventDefault(); $('dropHint').style.opacity='.18'; });
  $('canvasWrap').addEventListener('drop',function(e){ e.preventDefault(); $('dropHint').style.opacity='.18'; var f=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0]; if(f) loadFile(f); });
  window.addEventListener('paste',function(e){ var items=(e.clipboardData&&e.clipboardData.items)||[]; for(var i=0;i<items.length;i++){ if(items[i].type.indexOf('image/')===0){ var f=items[i].getAsFile(); if(f){ log('Pasted image…'); loadFile(f); } break; } }
  });
  fileInput.addEventListener('change',function(e){ var f=e.target.files&&e.target.files[0]; if(f){ log('Loading local image…'); loadFile(f); } });
  window.addEventListener('resize',resize); img.addEventListener('load',resize);

  // Basic tools (always active)
  $('overlayTest').addEventListener('click',function(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='#9ad1ff'; ctx.shadowColor='#9ad1ff'; ctx.shadowBlur=8; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(canvas.width,canvas.height); ctx.moveTo(canvas.width,0); ctx.lineTo(0,canvas.height); ctx.stroke(); ctx.font='16px ui-sans-serif'; ctx.fillStyle='#9ad1ff'; ctx.fillText('OVERLAY OK',12,22); log('Overlay test drawn ✓',true); });
  $('selfTest').addEventListener('click',function(){ var t=[ 'UA: '+navigator.userAgent, 'Lang: '+navigator.language, 'Platform: '+navigator.platform, 'Cores: '+(navigator.hardwareConcurrency||'?')+' / Mem: '+(navigator.deviceMemory||'?')+'GB' ].join('
'); diag.textContent=t; log('Self-test captured environment ✓',true); });
  $('copyDiag').addEventListener('click',async function(){ try{ await navigator.clipboard.writeText(diag.textContent||''); log('Diagnostics copied ✓',true);}catch(e){ log('Copy failed',false);} });
  (function tick(){ var fpsv=(1000/16.7).toFixed(1); fpsChip.textContent='FPS — '+fpsv; requestAnimationFrame(tick); })();
  log('BOOT: UI wired ✓');

  // ===== Late loader: dynamic import + full models
  var vision=null, FilesetResolver=null, ObjectDetector=null, PoseLandmarker=null, FaceLandmarker=null;
  var detector=null, poser=null, facer=null;
  async function loadVision(){ var urls=[
    'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs',
    'https://unpkg.com/@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs',
    'https://ga.jspm.io/npm:@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs'
  ]; var lastErr=''; for(var i=0;i<urls.length;i++){ try{ vision=await import(urls[i]); break; }catch(e){ lastErr=e&&e.message?e.message:String(e); log('Import fail: '+urls[i]+' → '+lastErr,false);} }
    if(!vision){ chip(status.wasm,false,'WASM — ERR'); log('tasks-vision NOT loaded. Fallback mode only.',false); return false; }
    FilesetResolver=vision.FilesetResolver; ObjectDetector=vision.ObjectDetector; PoseLandmarker=vision.PoseLandmarker; FaceLandmarker=vision.FaceLandmarker; chip(status.wasm,true,'WASM — OK'); log('WASM/module ready',true); return true;
  }
  async function initModels(){ if(!vision){ var ok=await loadVision(); if(!ok) return; }
    try{ var fsr=await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.21/wasm');
      detector=await ObjectDetector.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite', delegate:'CPU' }, runningMode:'IMAGE', scoreThreshold:0.5, maxResults:10 }); chip(status.obj,true,'Object — OK');
      poser=await PoseLandmarker.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task', delegate:'CPU' }, runningMode:'IMAGE', numPoses:1 }); chip(status.pose,true,'Pose — OK');
      facer=await FaceLandmarker.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task', delegate:'CPU' }, runningMode:'IMAGE', numFaces:1, outputFacialTransformationMatrixes:true }); chip(status.face,true,'Face — OK');
      STATE.modelsReady=true; runBtn.disabled=false; log('All models ready ✓',true);
      if(STATE.imageReady) runAll();
    }catch(e){ log('Init error: '+(e&&e.message?e.message:e),false); }
  }
  initModels(); // fire and forget

  function drawPose(res,a){ if(!res||!res.landmarks||!res.landmarks.length) return; var l=res.landmarks[0]; ctx.save(); ctx.globalAlpha=a||0.9; ctx.lineWidth=3; ctx.strokeStyle='rgba(102,255,153,.9)'; var E=[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24]]; for(var i=0;i<E.length;i++){ var p=l[E[i][0]], q=l[E[i][1]]; if(!p||!q) continue; ctx.beginPath(); ctx.moveTo(p.x*canvas.width,p.y*canvas.height); ctx.lineTo(q.x*canvas.width,q.y*canvas.height); ctx.stroke(); } ctx.restore(); }
  function drawFace(face,a){ if(!face||!face.faceLandmarks||!face.faceLandmarks.length) return; var LMK=face.faceLandmarks; ctx.save(); ctx.globalAlpha=a||0.9; ctx.fillStyle='rgba(255,220,140,.9)'; for(var i=0;i<LMK.length;i++){ var l=LMK[i]; for(var k=0;k<l.length;k++){ var p=l[k]; ctx.beginPath(); ctx.arc(p.x*canvas.width,p.y*canvas.height,1.6,0,6.283); ctx.fill(); } } ctx.restore(); }
  function scaleBox(b){ var sx=canvas.width/img.naturalWidth, sy=canvas.height/img.naturalHeight; return {x:b.originX*sx,y:b.originY*sy,w:b.width*sx,h:b.height*sy}; }
  function drawObjects(res,a){ if(!res||!res.detections) return; ctx.save(); ctx.globalAlpha=a||0.9; ctx.lineWidth=2.2; ctx.font='12px ui-sans-serif'; ctx.fillStyle='#c7faff'; ctx.strokeStyle='rgba(62,248,255,.95)'; for(var i=0;i<res.detections.length;i++){ var d=res.detections[i]; var bb=scaleBox(d.boundingBox); ctx.strokeRect(bb.x,bb.y,bb.w,bb.h); var name=(d.categories&&d.categories[0]&&d.categories[0].categoryName)||'object'; var s=(d.categories&&d.categories[0]&&d.categories[0].score)||0; var lab=name+' '+Math.round(s*100)+'%'; var tw=ctx.measureText(lab).width+12, th=18; ctx.fillStyle='rgba(15,27,38,.92)'; ctx.fillRect(bb.x,Math.max(0,bb.y-th),tw,th); ctx.strokeStyle='rgba(62,248,255,.45)'; ctx.strokeRect(bb.x,Math.max(0,bb.y-th),tw,th); ctx.fillStyle='#c7faff'; ctx.fillText(lab,bb.x+6,Math.max(0,bb.y-th)+13); }
    ctx.restore(); }

  async function runAll(){ log('Run start ▶',true); if(!STATE.imageReady){ log('No image loaded yet.',false); return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!STATE.modelsReady){ log('Models not ready; fallback edges only.',false); drawEdges(0.45); fallbackPrompt(); return; }
    var objs=null, pose=null, face=null; try{ pose=await poser.detect(img); }catch(e){ log('Pose detect failed: '+e.message,false); }
    try{ face=await facer.detect(img); }catch(e){ log('Face detect failed: '+e.message,false); }
    try{ objs=await detector.detect(img); }catch(e){ log('Object detect failed: '+e.message,false); }
    drawPose(pose,0.9); drawFace(face,0.9); drawObjects(objs,0.9); drawEdges(0.25);
    // KPIs (brief)
    $('objectList').innerHTML = (objs&&objs.detections&&objs.detections.length)? objs.detections.map(function(d){var n=d.categories[0].categoryName; var s=Math.round(d.categories[0].score*100); return '<div class="pill"><span>'+n+'</span><span>'+s+'%</span></div>';}).join('') : '<div class="pill"><span>—</span><span>n/a</span></div>';
    $('subjectList').innerHTML='<div class="pill"><span>Framing</span><span>'+(pose?'frontal/3⁄4':'unknown')+'</span></div>';
    // Prompt (basic)
    var c=analyzeColor(img); var pos='hyperreal portrait, subject centered'+(c?(', '+c.lighting+' lighting'):''); var neg='lowres, blur, watermark'; var comb=pos+'
NEGATIVE: '+neg; $('promptOut').value=comb; $('promptChars').textContent=comb.length+' chars';
    chip(status.run,true,'Detectors — OK'); log('Analysis complete ✓',true);
  }

  $('runBtn').addEventListener('click',function(){ log('Run clicked',true); runAll(); });

  // Matrix Test (simple timings)
  $('matrixTest').addEventListener('click', async function(){ var out={}; async function t(label,fn){ var t0=performance.now(); try{ var r=await fn(); out[label]={ok:true,ms:+(performance.now()-t0).toFixed(1)}; log(label+' ✓ '+out[label].ms+'ms',true); }catch(e){ out[label]={ok:false,err:String(e&&e.message?e.message:e)}; log(label+' ERR: '+out[label].err,false); } }
    if(!STATE.modelsReady){ await initModels(); }
    await t('pose.detect', function(){ return poser?poser.detect(img):Promise.reject('poser null'); });
    await t('face.detect', function(){ return facer?facer.detect(img):Promise.reject('facer null'); });
    await t('object.detect', function(){ return detector?detector.detect(img):Promise.reject('detector null'); });
    window.__BUNDLE.matrix=out; log('Matrix Test complete ✓ (Copy Bug Bundle)',true);
  });
  $('copyBundle').addEventListener('click', async function(){ try{ var text=JSON.stringify(window.__BUNDLE||{},null,2); await navigator.clipboard.writeText(text); log('Bug bundle copied ✓',true);}catch(e){ log('Copy failed',false);} });

})();
</script>
</body>
</html>
