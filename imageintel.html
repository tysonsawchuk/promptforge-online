<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ImageIntel Pro Lab — BlackSite</title>
  <meta name="description" content="In-browser image analyzer with overlays, diagnostics, and replica prompts." />
  <style>
    :root{
      --bg:#070a0d; --panel:#0c1216; --ink:#d6ecff; --muted:#7ea0ba; --accent:#00ffd1; --alert:#ff4d4d; --ok:#49e07b;
      --grid: rgba(0,255,209,0.06); --shadow: 0 10px 30px rgba(0,0,0,0.5);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--ink);margin:0;font-family:var(--sans);}  
    .wrap{max-width:1400px;margin:0 auto;padding:18px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{letter-spacing:0.12em;text-transform:uppercase;font-weight:700}
    .ver{font-family:var(--mono);opacity:.65}
    .grid{position:fixed; inset:0; pointer-events:none; background-image:linear-gradient(to right,var(--grid) 1px,transparent 1px),linear-gradient(to bottom,var(--grid) 1px,transparent 1px); background-size:40px 40px;}
    .panel{background:var(--panel);border:1px solid #17222a;border-radius:16px;box-shadow:var(--shadow)}
    .layout{display:grid;grid-template-columns: 1.3fr 0.9fr; gap:16px}
    .stage{position:relative;border-radius:16px;overflow:hidden}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;padding:12px;border-bottom:1px solid #17222a}
    .btn{font-family:var(--mono);border:1px solid #24303a;background:#0d1419;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
    .toggle{display:flex;align-items:center;gap:8px}
    .canvas-stack{position:relative; aspect-ratio: 16/10; background:#0a1115;}
    canvas, img#input{position:absolute; inset:0; width:100%; height:100%; object-fit:contain}
    .hud{position:absolute; top:10px; left:10px; right:10px; display:flex; gap:8px; flex-wrap:wrap; font-family:var(--mono); font-size:12px; color:var(--muted)}
    .chip{background:rgba(0,0,0,.35); padding:6px 8px; border:1px solid #1f2a33; border-radius:999px}
    .side{display:grid; gap:12px}
    .section{padding:12px}
    .section h3{margin:0 0 8px 0; font-size:14px; font-family:var(--mono); opacity:.85}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row .btn, .row select, .row input[type="range"]{flex:1}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .card{background:#0a1218; border:1px solid #16232c; border-radius:12px; padding:10px; min-height:44px}
    .terminal{background:#071017;border:1px solid #0f1c25;border-radius:12px; padding:12px; font-family:var(--mono); font-size:12px; line-height:1.5; min-height:140px; max-height:200px; overflow:auto}
    .diag{background:#0a1218;border:1px solid #16232c;border-radius:12px;padding:10px;font-family:var(--mono);font-size:12px}
    .out{display:grid; gap:8px}
    .out textarea{width:100%; min-height:180px; background:#071017; color:var(--ink); border:1px solid #16232c; border-radius:12px; padding:12px; font-family:var(--mono)}
    .ok{color:var(--ok)} .warn{color:#ffb86b} .err{color:var(--alert)} .muted{color:#7ea0ba}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="grid"></div>
  <div class="wrap">
    <header>
      <div class="brand">ImageIntel Pro Lab <span class="muted">— BlackSite</span></div>
      <div class="ver">v0.1.2-alpha</div>
    </header>

    <div class="layout">
      <div class="panel stage">
        <div class="toolbar">
          <input id="file" type="file" accept="image/*" class="btn" />
          <button id="demo" class="btn">Load Demo</button>
          <label class="toggle"><input type="checkbox" id="ov-objects" checked> Objects</label>
          <label class="toggle"><input type="checkbox" id="ov-seg" checked> Seg</label>
          <label class="toggle"><input type="checkbox" id="ov-pose" checked> Pose</label>
          <label class="toggle"><input type="checkbox" id="ov-face" checked> Face</label>
        </div>
        <div class="canvas-stack">
          <img id="input" alt="" />
          <canvas id="overlay-objects"></canvas>
          <canvas id="overlay-seg"></canvas>
          <canvas id="overlay-pose"></canvas>
          <canvas id="overlay-face"></canvas>
          <div class="hud">
            <div class="chip" id="status-host">host: —</div>
            <div class="chip" id="status-models">models: —</div>
            <div class="chip" id="status-fps">fps: —</div>
            <div class="chip" id="status-size">– × –</div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="panel section">
          <h3>Output Modes</h3>
          <div class="row">
            <select id="mode" class="btn">
              <option value="sfw">SFW</option>
              <option value="nsfw">NSFW-Safe</option>
              <option value="edgy">Edgy</option>
              <option value="poetic">Poetic</option>
              <option value="numeric">Numeric</option>
              <option value="raw">Raw JSON</option>
            </select>
            <input id="detail" type="range" min="0" max="3" step="1" value="2" />
          </div>
        </div>

        <div class="panel section">
          <h3>Quick KPIs</h3>
          <div class="kpi">
            <div class="card" id="kpi-subject">Subject: —</div>
            <div class="card" id="kpi-pose">Pose: —</div>
            <div class="card" id="kpi-objects">Objects: —</div>
            <div class="card" id="kpi-light">Lighting: —</div>
            <div class="card" id="kpi-color">Palette: —</div>
            <div class="card small" id="kpi-nsfw">NSFW: —</div>
          </div>
        </div>

        <div class="panel section">
          <h3>Diagnostics</h3>
          <div id="diag" class="diag"></div>
          <div id="terminal" class="terminal" style="margin-top:8px"></div>
        </div>

        <div class="panel section out">
          <h3>Replica Prompt</h3>
          <textarea id="prompt" placeholder="Replica prompt will appear here…"></textarea>
          <div class="row"><button id="copy" class="btn">Copy Prompt</button><button id="rerun" class="btn">Re-Analyze</button></div>
        </div>
      </div>
    </div>

    <footer class="small muted" style="margin-top:12px">Drop-in static build. No backend. <span id="ads">[ads hook]</span></footer>
  </div>

  <!-- Pose module -->
  <script type="module" src="./public/imageintel/js/pose.js"></script>

  <!-- Core app -->
  <script type="module">
    import { poseOnImage } from './public/imageintel/js/pose.js';

    const term = document.getElementById('terminal');
    const diag = document.getElementById('diag');
    const img = document.getElementById('input');
    const file = document.getElementById('file');
    const demo = document.getElementById('demo');
    const mode = document.getElementById('mode');
    const detail = document.getElementById('detail');
    const promptEl = document.getElementById('prompt');
    const copyBtn = document.getElementById('copy');
    const rerun = document.getElementById('rerun');
    const ovPose = document.getElementById('ov-pose');
    const ovObjects = document.getElementById('ov-objects');
    const ovSeg = document.getElementById('ov-seg');
    const ovFace = document.getElementById('ov-face');

    function log(level, tag, msg){
      const line = document.createElement('div');
      const ts = new Date().toISOString().split('T')[1].replace('Z','');
      line.className = level==='error'?'err':level==='warn'?'warn':'muted';
      line.textContent = `[${ts}] ${tag.padEnd(5,' ')} | ${msg}`;
      term.appendChild(line); term.scrollTop = term.scrollHeight;
    }
    function chip(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
    function diagRow(stage, ok, message, warn=false){
      const row = document.createElement('div');
      row.innerHTML = `<span class="${ok?'ok':warn?'warn':'err'}">${ok?'✔':warn?'!':'✖'}</span> <b>${stage}</b> — <span class="muted">${message||''}</span>`;
      diag.appendChild(row);
    }

    // diagnostics
    (function bootstrap(){
      const served = location.protocol.startsWith('http');
      chip('status-host', served?location.host:'file://');
      diagRow('Hosting', served, served?location.origin:'Open via https://');
      diagRow('WASM', typeof WebAssembly!=='undefined', typeof WebAssembly!=='undefined'?'available':'unsupported');
      const gl = !!document.createElement('canvas').getContext('webgl');
      diagRow('WebGL', gl, gl?'available':'missing');
    })();

    // helpers
    function rgbToHex(r,g,b){ return '#' + [r,g,b].map(x=> x.toString(16).padStart(2,'0')).join(''); }
    function analyzeColors(imgEl){
      const w = imgEl.naturalWidth || imgEl.width, h = imgEl.naturalHeight || imgEl.height;
      const samples = 16000, scale = Math.sqrt(samples/(w*h));
      const tw = Math.max(1, Math.floor(w*scale)), th = Math.max(1, Math.floor(h*scale));
      const c = document.createElement('canvas'); c.width=tw; c.height=th;
      const ctx = c.getContext('2d', {willReadFrequently:true}); ctx.drawImage(imgEl,0,0,tw,th);
      const data = ctx.getImageData(0,0,tw,th).data;
      const buckets = new Map(); let sumL=0,minL=255,maxL=0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const l=Math.round(0.2126*r + 0.7152*g + 0.0722*b);
        sumL+=l; minL=Math.min(minL,l); maxL=Math.max(maxL,l);
        const key=((r>>4)<<8)|((g>>4)<<4)|(b>>4);
        buckets.set(key,(buckets.get(key)||0)+1);
      }
      const top=[...buckets.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
      const palette=top.map(([key])=>{ const r=((key>>8)&0xf)<<4, g=((key>>4)&0xf)<<4, b=(key&0xf)<<4; return rgbToHex(r,g,b); });
      const avgL=sumL/(data.length/4); const contrast=maxL-minL;
      let sumR=0,sumB=0; const sampleN=Math.min(2000,data.length/4);
      for(let i=0;i<sampleN;i++){ const idx=(i*4)|0; sumR+=data[idx]; sumB+=data[idx+2]; }
      const tempBias=(sumB-sumR)/sampleN; const temp=tempBias>10?'cool':tempBias<-10?'warm':'neutral';
      return { palette, brightness:Math.round(avgL), contrast, temperature:temp, temperatureBias:Math.round(tempBias) };
    }
    function sizeOverlaysTo(el){
      const w = el.naturalWidth||el.clientWidth, h = el.naturalHeight||el.clientHeight;
      ['overlay-objects','overlay-seg','overlay-pose','overlay-face'].forEach(id=>{
        const c=document.getElementById(id); if(!c) return;
        c.width=w; c.height=h; c.style.width='100%'; c.style.height='100%';
      });
      chip('status-size', `${w} × ${h}`); log('info','canvas',`resized ${w}x${h}`);
    }
    function drawBoxes(ctx, boxes, labels){
      ctx.lineWidth=2; ctx.strokeStyle='rgba(0,255,209,0.85)';
      ctx.font='12px ui-monospace, monospace'; ctx.fillStyle='rgba(0,0,0,0.6)';
      boxes.forEach((b,i)=>{ const [x,y,w,h]=b; ctx.strokeRect(x,y,w,h); const lab=labels?.[i]; if(lab){ const pad=4; const tw=ctx.measureText(lab).width+pad*2; const th=16; ctx.fillRect(x,y-th,tw,th); ctx.fillStyle='#00ffd1'; ctx.fillText(lab,x+pad,y-4); ctx.fillStyle='rgba(0,0,0,0.6)'; }});
    }

    // Object detection (inline)
    const MP_VERSION = '0.10.15';
    let objectDetector=null;
    async function ensureObjectDetector(){
      if(objectDetector) return objectDetector;
      const mod = await import(`https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@${MP_VERSION}/vision_bundle.mjs`);
      diagRow('Tasks Vision', true, `v${MP_VERSION}`);
      const fsr = await mod.FilesetResolver.forVisionTasks({ baseUrl: `https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@${MP_VERSION}/wasm` });
      diagRow('Fileset', true, 'CDN wasm');
      objectDetector = await mod.ObjectDetector.createFromOptions(fsr, {
        baseOptions: { modelAssetPath: 'https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite' },
        runningMode: 'IMAGE', scoreThreshold: 0.35, maxResults: 12
      });
      const chipM=document.getElementById('status-models'); chipM.textContent = chipM.textContent.includes('pose')?'models: pose, object':'models: object';
      diagRow('ObjectDetector', true, 'ready');
      return objectDetector;
    }
    async function detectObjectsOn(imgEl){
      if(!ovObjects.checked) { const ctx = document.getElementById('overlay-objects').getContext('2d'); ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); return {boxes:[],labels:[]}; }
      sizeOverlaysTo(imgEl);
      const det = await ensureObjectDetector();
      const res = det.detect(imgEl);
      const boxes=[], labels=[];
      (res.detections||[]).forEach(d=>{ const b=d.boundingBox; boxes.push([b.originX,b.originY,b.width,b.height]); const c=d.categories?.[0]; labels.push(`${c?.categoryName||'obj'} ${Math.round((c?.score||0)*100)}%`); });
      const ctx = document.getElementById('overlay-objects').getContext('2d');
      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); drawBoxes(ctx, boxes, labels);
      document.getElementById('kpi-objects').textContent = `Objects: ${labels.length?labels.join(', '):'—'}`;
      log('info','detect', `objects: ${labels.join(', ')||'none'}`);
      return {boxes,labels};
    }

    // replica prompt (minimal)
    function genPrompt({mode, detail, readings}){
      const { subject='subject', pose='pose', objects='none', lighting='neutral', colors=['#999'], stats={} } = readings||{};
      let base = `((masterpiece)), ${subject}, ${pose}, ${objects}, ${lighting}, color scheme: ${colors.join(' / ')}, ${detail>=2?'8k, ultra-detailed, film grain':'high detail'}`;
      if(mode==='poetic') base += ', whispers of silicon, hush of photons';
      if(mode==='edgy') base += ', gritty, noir, cybernetic HUD, moody shadows, chromatic aberration';
      if(mode==='numeric') return `SUBJECT=${subject}\nPOSE=${pose}\nOBJECTS=${objects}\nLIGHTING=${lighting}\nPALETTE=${colors.join(',')}\nSTATS=${JSON.stringify(stats)}`;
      if(mode==='raw') return JSON.stringify({subject,pose,objects,lighting,colors,stats,detail}, null, 2);
      return base;
    }

    // main analysis
    async function analyzeAll(){
      if(!img.naturalWidth) return;
      const colors = analyzeColors(img);
      document.getElementById('kpi-light').textContent = `Lighting: ${colors.temperature} • ${colors.brightness}`;
      document.getElementById('kpi-color').textContent = `Palette: ${colors.palette.join(', ')}`;
      const {labels} = await detectObjectsOn(img);
      if(ovPose.checked){ await poseOnImage(img); } else { const c=document.getElementById('overlay-pose').getContext('2d'); c.clearRect(0,0,c.canvas.width,c.canvas.height); document.getElementById('kpi-pose').textContent='Pose: —'; }
      const objects = labels.length ? labels.join(', ') : 'none';
      const out = genPrompt({ mode: mode.value, detail: +detail.value, readings: { subject:'photo subject', pose: document.getElementById('kpi-pose').textContent.replace('Pose: ','')||'neutral', objects, lighting:`${colors.temperature} / ${colors.brightness}`, colors: colors.palette, stats:{contrast:colors.contrast} } });
      promptEl.value = out;
    }

    function onImageReady(){
      chip('status-size', `${img.naturalWidth} × ${img.naturalHeight}`);
      log('info','io','image ready');
      analyzeAll();
    }

    // events
    file.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); img.onload=onImageReady; img.src=url; });
    demo.addEventListener('click', ()=>{ img.onload=onImageReady; img.src='https://images.unsplash.com/photo-1531123897727-8f129e1688ce?q=80&w=1280&auto=format'; log('info','io','demo loaded'); });
    rerun.addEventListener('click', ()=> analyzeAll());
    mode.addEventListener('change', ()=> analyzeAll()); detail.addEventListener('input', ()=> analyzeAll());
    ovPose.addEventListener('change', ()=> analyzeAll());
    ovObjects.addEventListener('change', ()=> analyzeAll());
    ovSeg.addEventListener('change', ()=> analyzeAll());  // segmentation coming next
    ovFace.addEventListener('change', ()=> analyzeAll()); // face mesh coming next
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(promptEl.value||''); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy Prompt',900); });
  </script>
</body>
</html>
