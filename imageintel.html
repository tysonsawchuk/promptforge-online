<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>PF FaceMapper ‚Äî Real-Time Face Mesh ‚Ä¢ Detect ‚Üí Measure ‚Üí Mesh ‚Üí Highlight (On-Device)</title>
<meta name="description" content="PromptForge FaceMapper: movie-scanner style, on-device face mapping. Live overlays, measurements & ratios, palette sampling, JSON export. SFW front; NSFW labs isolated."/>
<link rel="canonical" href="https://promptforge.online/facemapper.html"/>

<!-- Open Graph -->
<meta property="og:title" content="PF FaceMapper ‚Äî Real-Time Face Mesh"/>
<meta property="og:description" content="Visible scan ‚Üí detect ‚Üí measure ‚Üí mesh ‚Üí highlight. Client-only. Copy prompts, export JSON. SFW front; NSFW labs isolated."/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://promptforge.online/facemapper.html"/>
<meta property="og:image" content="/assets/og/facemapper.png"/>

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="PF FaceMapper ‚Äî Real-Time Face Mesh"/>
<meta name="twitter:description" content="Visible scan ‚Üí detect ‚Üí measure ‚Üí mesh ‚Üí highlight. Client-only. Copy prompts, export JSON."/>
<meta name="twitter:image" content="/assets/og/facemapper.png"/>

<!-- CSP: allow Tasks-Vision ESM/WASM + GCS model (and inline styles for PF vibe) -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://cdn.jsdelivr.net;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: blob: https://storage.googleapis.com;
  connect-src 'self' https://cdn.jsdelivr.net https://storage.googleapis.com;
  worker-src 'self' blob:;
  font-src 'self' data:;
  media-src 'self' blob:;
  frame-ancestors 'self';
  base-uri 'self';
">

<style>
:root{
  --bg:#0b0f14; --panel:#10161d; --edge:#232a33; --ink:#d6f5ff; --dim:#9db1bd;
  --aqua:#64f2e3; --vio:#be9cff; --gold:#ffd166; --ok:#55d69a; --bad:#ff6b6b;
}
html,body{background:var(--bg);color:var(--ink);margin:0;padding:0;font-family:"Share Tech Mono",monospace}
a{color:var(--aqua);text-decoration:none} a:hover{text-decoration:underline}
.wrap{max-width:1100px;margin:0 auto;padding:20px;position:relative;z-index:2}

/* Header */
header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin:10px 0 8px}
.brand{font-weight:800;letter-spacing:.6px}
.brand .sub{font-size:.92rem;color:var(--dim)}
.lang{display:flex;gap:6px}
.lang button{cursor:pointer;border:1px solid var(--edge);background:#0f141a;color:var(--ink);
  padding:6px 10px;border-radius:8px;font-family:inherit}
.lang button.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e344 inset}

/* CTAs */
.cta-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 14px}
.btn{cursor:pointer;border:1.5px solid var(--aqua);background:#131922;color:var(--aqua);padding:9px 14px;
  border-radius:10px;font-weight:700;box-shadow:0 2px 10px #64f2e344;transition:all .15s}
.btn:hover{background:var(--aqua);color:#0e131a;border-color:#fff}
.btn.sec{border-color:var(--vio);color:var(--vio)} .btn.sec:hover{background:var(--vio);color:#111319}
.btn.ghost{border-color:var(--edge);color:var(--ink);box-shadow:none}
.btn:disabled{opacity:.45;cursor:not-allowed}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);padding:6px 10px;border-radius:999px;
  color:var(--dim);background:#0e141a}

/* Stage */
.stage{position:relative;border:1px solid var(--edge);border-radius:14px;overflow:hidden;background:#0d131a}
.stage-inner{position:relative;aspect-ratio:16/9;background:#0a0f14}
video#cam{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
canvas.layer{position:absolute;inset:0;display:block}
.legend{position:absolute;left:12px;bottom:12px;display:flex;flex-wrap:wrap;gap:8px;z-index:3}
.legend .chip{background:#0b1117d9}
.mower{position:absolute;inset:0;background:linear-gradient(0deg, transparent 0%, rgba(255,255,255,0.08) 50%, transparent 100%);
  background-size:100% 32%; animation:mow 1.6s linear infinite;mix-blend-mode:screen;opacity:.36;pointer-events:none}
@media (prefers-reduced-motion: reduce){ .mower{animation:none;opacity:.12} }
@keyframes mow{0%{background-position-y:100%}100%{background-position-y:0%}}

/* Tabs */
.tabs{margin-top:14px}
.tab-head{display:flex;flex-wrap:wrap;gap:8px}
.tab-head button{cursor:pointer;border:1px solid var(--edge);background:#0e141a;color:var(--ink);
  padding:8px 12px;border-radius:9px}
.tab-head button.active{border-color:var(--aqua);box-shadow:0 0 0 2px #64f2e333 inset}
.tab{display:none;margin-top:10px;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#0e141a}
.tab.active{display:block}
textarea.out{width:100%;min-height:120px;background:#0b1117;color:#d8faff;border:1px solid #1b242e;border-radius:8px;
  padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
.row{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0}
.row .btn{padding:7px 12px;font-weight:600}

/* Help */
.help{margin-top:18px;border:1px solid var(--edge);border-radius:12px;background:#0d131a;padding:12px}
.help h3{margin:6px 0 8px 0;font-size:1.05rem}
.help .micro{color:var(--dim);line-height:1.45}

/* Diagnostics */
.diag{margin-top:16px;border:1px dashed var(--edge);padding:10px;border-radius:12px;background:#0c1117}
.diag .ok{color:var(--ok)} .diag .bad{color:var(--bad)} .diag .warn{color:var(--gold)}

/* Toasts */
.toasts{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px; z-index:5000}
.toast{background:#121823ee;border:1px solid var(--edge);color:#defaff;padding:10px 12px;border-radius:10px;min-width:220px;box-shadow:0 4px 18px #0006}
.toast.ok{border-color:var(--ok)} .toast.bad{border-color:var(--bad)} .toast.warn{border-color:var(--gold)}

/* J1NX + ANSI footer (classes preserved) */
.j1nx-float-true{position:fixed;z-index:4000;right:2vw;bottom:calc(2.8vh + 125px);display:flex;flex-direction:column;align-items:center;pointer-events:all;user-select:none;min-width:0;max-width:360px}
.j1nx-true-cutout-img{width:320px;height:320px;object-fit:contain;border-radius:32px;background:transparent!important;margin-bottom:-30px;position:relative;z-index:9;pointer-events:auto;transition:box-shadow .2s;box-shadow:none!important}
.j1nx-bubble-true-main{background:rgba(22,23,31,0.97);border-radius:17px;box-shadow:0 4px 22px #be9cff66,0 0 0 3px #23231f;border:2px solid var(--aqua);padding:1.1em 1.3em 1em 1.3em;margin-top:0;margin-bottom:.3em;display:flex;flex-direction:column;align-items:center;min-width:290px;max-width:330px;position:relative;z-index:1}
.j1nx-bubble-text-true{font-size:1.05em;color:#fff;margin:.42em 0 .20em 0;text-align:center;font-weight:600;text-shadow:0 1px 11px #1e1111cc;line-height:1.22;z-index:1}
.j1nx-bubble-row-true{width:100%;display:flex;justify-content:center;gap:7px;margin:.13em 0 .10em 0}
.j1nx-input-true{flex:1;font-size:1em;border-radius:8px;padding:7px 12px;border:1px solid var(--aqua);background:#171b22;color:var(--aqua);min-width:0}
.j1nx-btn-true{font-size:.98em;padding:6.5px 14px;border-radius:8px;background:#22252b;border:1.3px solid var(--aqua);color:var(--aqua);font-family:inherit;font-weight:600;cursor:pointer;transition:background .13s,color .13s,border .13s;box-shadow:0 1.5px 9px #be9cff33}
.j1nx-btn-true:hover{background:var(--aqua);color:#171b22;border-color:#fff}
.j1nx-easteregg-true{font-size:.91em;color:#be9cff;background:#171b22e6;border-radius:7px 13px 12px 17px;margin-top:7px;padding:7px 17px 6px 13px;opacity:.85;pointer-events:none;text-align:center;width:94%;user-select:none;box-shadow:0 3px 13px #be9cff28;font-weight:600}
@media (max-width:900px){.j1nx-float-true{min-width:99vw;max-width:99vw;right:1vw}.j1nx-bubble-true-main{min-width:97vw;max-width:99vw}.j1nx-true-cutout-img{width:112px;height:112px}}
@media (max-width:700px){.j1nx-float-true{min-width:99vw;max-width:99vw;right:1vw}.j1nx-bubble-true-main{min-width:98vw;max-width:99vw}.j1nx-true-cutout-img{width:66px;height:66px}}

footer{margin:0 auto;padding:0 0 22px 0;text-align:center;max-width:920px;width:100%;display:flex;flex-direction:column;align-items:center;background:none;position:relative;z-index:100;color:var(--ink)}
.footer-art{margin:22px 0 8px 0;font-family:"Fira Mono", monospace;font-size:.96em;color:#a1ffe3;line-height:1.1;letter-spacing:.2px;text-align:center;white-space:pre;user-select:text}
.footer-camo{font-family:inherit;font-size:15px;line-height:1.11;letter-spacing:1.7px;margin:5px 0 12px 0;text-align:center;opacity:.93;white-space:pre}
.footer-bar{color:#88fffd;margin:12px auto 8px auto;font-size:1.04em;text-align:center;display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
.footer-bar a{color:var(--aqua)} .footer-bar a:hover{color:#fff}

.hidden{display:none!important}
</style>
</head>
<body>

<div class="wrap" id="app">
  <header>
    <div class="brand">
      <div style="font-size:1.25rem">PromptForge</div>
      <div class="sub" data-i18n="subtitle">FaceMapper ‚Äî on-device, real-time face mapping</div>
    </div>
    <div class="lang" aria-label="Language">
      <button class="lbtn active" data-lang="en">EN</button>
      <button class="lbtn" data-lang="es">ES</button>
      <button class="lbtn" data-lang="fr">FR</button>
    </div>
  </header>

  <!-- Primary Controls -->
  <section class="cta-row" aria-label="Primary actions">
    <button class="btn" id="btnCam" role="button" data-i18n="enable_camera">Enable Camera</button>
    <button class="btn sec" id="btnImgBtn" role="button" data-i18n="load_image">Load Image</button>
    <input id="fileImg" class="hidden" type="file" accept="image/*" />
    <button class="btn ghost" id="btnShot" role="button" data-i18n="snapshot" disabled>Snapshot</button>
    <button class="btn ghost" id="btnGuides" role="button" data-i18n="show_guides">Show Guides</button>
    <span class="chip" id="shapeChip">shape: ‚Äî</span>
    <span class="chip" id="liveNums">eye: ‚Äî¬∞, jaw/face: ‚Äî, cheek/face: ‚Äî</span>
  </section>

  <!-- Stage -->
  <section class="stage" aria-label="Mapping stage">
    <div class="stage-inner" id="stage">
      <video id="cam" muted playsinline></video>
      <canvas id="preview" class="layer"></canvas>
      <canvas id="overlay" class="layer"></canvas>
      <div class="mower" id="mower" aria-hidden="true"></div>
      <div class="legend" aria-live="polite">
        <span class="chip" id="statusChip">status: idle</span>
        <span class="chip">HTTPS: <span id="httpsBadge">?</span></span>
        <span class="chip">ESM: <span id="esmBadge">?</span></span>
        <span class="chip">Model: <span id="modelBadge">?</span></span>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <section class="tabs">
    <div class="tab-head" role="tablist">
      <button class="active" data-tab="prompt" role="tab" aria-selected="true" data-i18n="tab_prompt">Prompt</button>
      <button data-tab="desc" role="tab" data-i18n="tab_descriptor">Descriptor</button>
      <button data-tab="meas" role="tab" data-i18n="tab_measurements">Measurements</button>
      <button data-tab="json" role="tab">JSON</button>
      <button data-tab="pal" role="tab" data-i18n="tab_palette">Palette</button>
    </div>

    <div id="tab_prompt" class="tab active" role="tabpanel">
      <textarea id="outPrompt" class="out" readonly></textarea>
      <div class="row">
        <button class="btn" id="copyPrompt" disabled data-i18n="copy_prompt">Copy Prompt</button>
        <button class="btn ghost" id="copyAlt" disabled data-i18n="copy_alt">Copy Alt</button>
      </div>
    </div>

    <div id="tab_desc" class="tab" role="tabpanel">
      <textarea id="outDesc" class="out" readonly></textarea>
    </div>

    <div id="tab_meas" class="tab" role="tabpanel">
      <textarea id="outMeas" class="out" readonly></textarea>
    </div>

    <div id="tab_json" class="tab" role="tabpanel">
      <textarea id="outJson" class="out" readonly></textarea>
      <div class="row">
        <button class="btn" id="btnExport" disabled data-i18n="export_json">Export JSON</button>
      </div>
    </div>

    <div id="tab_pal" class="tab" role="tabpanel">
      <div class="row" id="palRow">
        <div class="chip">hair <span id="palHair" style="display:inline-block;width:22px;height:22px;border-radius:6px;border:1px solid #223;vertical-align:middle;margin-left:6px"></span></div>
        <div class="chip">skin <span id="palSkin" style="display:inline-block;width:22px;height:22px;border-radius:6px;border:1px solid #223;vertical-align:middle;margin-left:6px"></span></div>
        <div class="chip">eyes <span id="palEyes" style="display:inline-block;width:22px;height:22px;border-radius:6px;border:1px solid #223;vertical-align:middle;margin-left:6px"></span></div>
      </div>
      <textarea id="outPal" class="out" readonly></textarea>
    </div>
  </section>

  <!-- Help / Micro-help -->
  <section class="help" id="help">
    <h3>How to use</h3>
    <div class="micro">
      1) Click <b>Enable Camera</b> (selfie) or <b>Load Image</b> (file).<br/>
      2) Watch the ‚Äúmovie scanner‚Äù overlay; toggle <b>Show Guides</b> for feature vectors.<br/>
      3) Switch tabs to get <b>Prompt</b>, <b>Descriptor</b>, <b>Measurements</b>, <b>JSON</b>, or <b>Palette</b>.<br/>
      4) Use <b>Copy</b> / <b>Export JSON</b> / <b>Snapshot</b> to save your output.
    </div>
    <h3>Notes</h3>
    <div class="micro">
      ‚Ä¢ Everything runs <b>on-device</b>. No uploads. Best in good light ~0.5‚Äì1.0 m from camera.<br/>
      ‚Ä¢ Measurements are per-frame (px) and normalized ratios; shapes are deterministic thresholds.<br/>
      ‚Ä¢ SFW on this page. 18+ tools live in <i>/labs</i> (noindex, no ads).
    </div>
  </section>

  <!-- Diagnostics -->
  <section class="diag" aria-live="polite">
    <div><b>Diagnostics</b> ‚Äî <span data-i18n="diag_note">everything runs on-device.</span></div>
    <div>Origin: <span id="origin"></span> ‚Ä¢ HTTPS: <span id="httpsState"></span></div>
    <div>HEAD model: <span id="headModel" class="warn">‚Ä¶</span></div>
    <div>ESM presence: <span id="esmState">‚Ä¶</span></div>
    <div>Perf: DPR=<span id="dpr">?</span> ‚Ä¢ canvas=<span id="cw">?</span>√ó<span id="ch">?</span></div>
  </section>
</div>

<!-- ====== J1NX FLOAT (verbatim) ====== -->
<div class="j1nx-float-true" id="j1nxFloatTrue">
  <img src="j1nx/j1nx_cutout.png" alt="J1nx" class="j1nx-true-cutout-img" id="j1nxCutoutTrue"/>
  <div class="j1nx-bubble-true-main" id="j1nxBubbleTrueMain">
    <div class="j1nx-bubble-text-true" id="j1nxBubbleTextTrue">
      <b>J1nx:</b> Hey you üëÄ‚ÄîI‚Äôm J1nx. Ready to stir up a little trouble, or keep it PG today?
    </div>
    <div class="j1nx-bubble-row-true">
      <input class="j1nx-input-true" id="j1nxInputTrue" placeholder="Say something to J1nx..." maxlength="120" autocomplete="off"/>
      <button class="j1nx-btn-true" id="j1nxSendTrue">Send</button>
    </div>
    <div class="j1nx-bubble-row-true">
      <button class="j1nx-btn-true" id="j1nxClearTrue">Clear Chat</button>
      <button class="j1nx-btn-true" id="j1nxSaveTrue">Save Chat</button>
    </div>
    <div class="j1nx-easteregg-true" id="j1nxEasterEggTrue">
      Double-tap the bubble or type <b>unlock</b> to reveal NSFW mode‚Ä¶
    </div>
  </div>
</div>

<!-- ====== ANSI FOOTER (with camo bar & socials) ====== -->
<footer>
  <pre class="footer-art">
  ____      ____    U  ___ u  __  __    ____    _____    _____   U  ___ u   ____      ____  U _____ u   
U|  _"\ uU |  _"\ u  \/"_ \/U|' \/ '|uU|  _"\ u|_ " _|  |" ___|   \/"_ \/U |  _"\ uU /"___|u\| ___"|/   
\| |_) |/ \| |_) |/  | | | |\| |\/| |/\| |_) |/  | |   U| |_  u   | | | | \| |_) |/\| |  _ / |  _|"     
 |  __/    |  _ <.-,_| |_| | | |  | |  |  __/   /| |\  \|  _|/.-,_| |_| |  |  _ <   | |_| |  | |___     
 |_|       |_| \_\\_)-\___/  |_|  |_|  |_|     u |_|U   |_|    \_)-\___/   |_| \_\   \____|  |_____|    
 ||>>_     //   \\_    \\   <<,-,,-.   ||>>_   _// \\_  )(\\,-      \\     //   \\_  _)(|_   <<   >>    
(__)__)   (__)  (__)  (__)   (./  \.) (__)__) (__) (__)(__)(_/     (__)   (__)  (__)(__)__) (__) (__)   
  </pre>
  <pre class="footer-camo" id="footerCamo"></pre>
  <div class="footer-bar">
    <span>Made underground in BC, Canada ‚Ä¢ #PromptForge</span>
    <a href="https://promptforge.online/" rel="noopener">Home</a> ‚Ä¢
    <a href="/picture.html" rel="noopener">Picture</a> ‚Ä¢
    <a href="/movie.html" rel="noopener">Movie</a> ‚Ä¢
    <a href="/ansiart.html" rel="noopener">ANSI Studio</a> ‚Ä¢
    <a href="/compare.html" rel="noopener">Compare Models</a> ‚Ä¢
    <a href="/support.html" rel="noopener">Support</a> ‚Ä¢
    <a href="https://x.com/GoreandGiggles" rel="noopener">Twitter/X</a> ‚Ä¢
    <a href="https://bsky.app/profile/goreandgiggles.bsky.social" rel="noopener">Bluesky</a> ‚Ä¢
    <a href="/legal.html" rel="noopener">Legal</a>
  </div>
</footer>

<!-- Toasts -->
<div class="toasts" aria-live="polite" aria-atomic="true" id="toasts"></div>

<!-- ====== J1NX behavior (kept consistent) ====== -->
<script>
(function(){
  const j1nxFloat = document.getElementById('j1nxFloatTrue');
  const cutout = document.getElementById('j1nxCutoutTrue');
  const bubble = document.getElementById('j1nxBubbleTrueMain');
  function isMobile(){return innerWidth<700}
  function setState(){ if(isMobile()){bubble.style.display="none";} else {bubble.style.display="flex";} }
  addEventListener('resize', setState, {passive:true}); setState();
  cutout.addEventListener('click', ()=>{ if(isMobile()){ bubble.style.display = (bubble.style.display==="none"?"flex":"none"); }});
})();
(function(){
  let chatHistory=[], nsfw=false;
  const out = ()=>{ document.getElementById('j1nxBubbleTextTrue').innerHTML =
    chatHistory.length? chatHistory.map(x=>`<div>${x}</div>`).join('') :
    "<b>J1nx:</b> Hey you üëÄ‚ÄîI‚Äôm J1nx. Ready to stir up a little trouble, or keep it PG today?"; };
  const push=(m,u=false)=>{ if(!m)return; chatHistory.push((u?"<b>You:</b> ":"<b>J1nx:</b> ")+m); if(chatHistory.length>8) chatHistory=chatHistory.slice(-8); out(); };
  document.getElementById('j1nxBubbleTrueMain').addEventListener('dblclick',()=>{nsfw=true; document.getElementById('j1nxEasterEggTrue').innerHTML="<b>NSFW unlocked!</b>"; push("NSFW unlocked!",false);});
  document.getElementById('j1nxSendTrue').onclick=()=>{
    const i=document.getElementById('j1nxInputTrue'); const v=(i.value||"").trim(); if(!v)return;
    push(v,true);
    if(/^unlock$/i.test(v)){nsfw=true; document.getElementById('j1nxEasterEggTrue').innerHTML="<b>NSFW unlocked!</b>"; push("NSFW unlocked!",false); i.value=""; return;}
    try{ let r=window.j1nxBrain(v, chatHistory.length, nsfw); push((typeof r==='object'?(r.text||r.reply||JSON.stringify(r)):r)||"‚Ä¶",false); }
    catch(e){ push("My brain is offline (assets/j1nx_brain.js).",false); }
    i.value="";
  };
  document.getElementById('j1nxInputTrue').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('j1nxSendTrue').click();});
  document.getElementById('j1nxSaveTrue').onclick=()=>{
    const t=chatHistory.map(s=>s.replace(/<[^>]+>/g,'')).join('\n'); const b=new Blob([t],{type:'text/plain'});
    const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='j1nx_chat.txt'; document.body.appendChild(a); a.click();
    setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(u);},200);
  };
  document.getElementById('j1nxClearTrue').onclick=()=>{chatHistory=[]; out();};
  out();
})();
</script>
<script src="assets/j1nx_brain.js"></script>

<!-- Footer camo animation -->
<script>
(function(){
  const el=document.getElementById("footerCamo"); if(!el) return;
  const colors=["#64f2e3","#23d7ba","#4df6a0","#bdf6c3","#abffe6","#abb8b8"];
  const chars="‚ñë‚ñí‚ñì‚ñö‚ñû‚ñê‚ñâ‚ñà‚ñõ";
  function tick(t){
    let out=""; for(let i=0;i<72;i++){ out += `<span style="color:${colors[(i+t)%colors.length]}">${chars[Math.random()*chars.length|0]}</span>`; }
    el.innerHTML=out;
  }
  let t=0; tick(0); setInterval(()=>tick(++t), 900);
})();
</script>

<!-- ====== FACEMAPPER CORE (using correct ESM bundle URL) ====== -->
<script type="module">
/* Correct ESM import: use the actual bundle URL, not a bare specifier */
import visionModule from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs";
const { FilesetResolver, FaceLandmarker, DrawingUtils } = visionModule;

const WASM_ROOT = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm";
const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task";

/* UI refs */
const video = document.getElementById('cam');
const cPrev = document.getElementById('preview');
const cOver = document.getElementById('overlay');
const mower = document.getElementById('mower');

const btnCam = document.getElementById('btnCam');
const btnImgBtn = document.getElementById('btnImgBtn');
const fileImg = document.getElementById('fileImg');
const btnShot = document.getElementById('btnShot');
const btnGuides = document.getElementById('btnGuides');

const statusChip = document.getElementById('statusChip');
const httpsBadge = document.getElementById('httpsBadge');
const esmBadge = document.getElementById('esmBadge');
const modelBadge = document.getElementById('modelBadge');

const originEl = document.getElementById('origin');
const httpsState = document.getElementById('httpsState');
const headModel = document.getElementById('headModel');
const esmState = document.getElementById('esmState');
const dprEl = document.getElementById('dpr');
const cwEl = document.getElementById('cw');
const chEl = document.getElementById('ch');

const shapeChip = document.getElementById('shapeChip');
const liveNums = document.getElementById('liveNums');

const outPrompt = document.getElementById('outPrompt');
const outDesc   = document.getElementById('outDesc');
const outMeas   = document.getElementById('outMeas');
const outJson   = document.getElementById('outJson');
const outPal    = document.getElementById('outPal');
const palHair = document.getElementById('palHair');
const palSkin = document.getElementById('palSkin');
const palEyes = document.getElementById('palEyes');

const copyPrompt= document.getElementById('copyPrompt');
const copyAlt   = document.getElementById('copyAlt');
const btnExport = document.getElementById('btnExport');

/* i18n */
const dict = {
  en:{subtitle:"FaceMapper ‚Äî on-device, real-time face mapping",enable_camera:"Enable Camera",load_image:"Load Image",snapshot:"Snapshot",show_guides:"Show Guides",tab_prompt:"Prompt",tab_descriptor:"Descriptor",tab_measurements:"Measurements",tab_palette:"Palette",copy_prompt:"Copy Prompt",copy_alt:"Copy Alt",export_json:"Export JSON",diag_note:"everything runs on-device."},
  es:{subtitle:"FaceMapper ‚Äî mapeo facial en tiempo real (local)",enable_camera:"Activar c√°mara",load_image:"Cargar imagen",snapshot:"Instant√°nea",show_guides:"Mostrar gu√≠as",tab_prompt:"Prompt",tab_descriptor:"Descriptor",tab_measurements:"Mediciones",tab_palette:"Paleta",copy_prompt:"Copiar prompt",copy_alt:"Copiar alt",export_json:"Exportar JSON",diag_note:"todo se ejecuta en el dispositivo."},
  fr:{subtitle:"FaceMapper ‚Äî cartographie faciale temps r√©el (local)",enable_camera:"Activer cam√©ra",load_image:"Charger image",snapshot:"Capture",show_guides:"Afficher guides",tab_prompt:"Prompt",tab_descriptor:"Descripteur",tab_measurements:"Mesures",tab_palette:"Palette",copy_prompt:"Copier prompt",copy_alt:"Copier alt",export_json:"Exporter JSON",diag_note:"tout s‚Äôex√©cute en local."}
};
let lang='en';
const i18nApply=()=>{document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n'); el.textContent=(dict[lang]&&dict[lang][k])||dict.en[k]||el.textContent;});};
document.querySelectorAll('.lbtn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.lbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); lang=b.dataset.lang; i18nApply();}));
i18nApply();

/* Toasts */
const toasts = document.getElementById('toasts');
const toast = (msg, cls='')=>{const d=document.createElement('div'); d.className=`toast ${cls}`; d.textContent=msg; toasts.appendChild(d); setTimeout(()=>d.remove(), 3200);};

/* Diagnostics */
originEl.textContent = location.origin;
const isHttps = location.protocol==='https:' || location.hostname==='localhost';
httpsState.textContent = isHttps?'true':'false';
httpsBadge.textContent = isHttps?'‚úì':'!';
esmBadge.textContent = '‚úì';
esmState.textContent = 'module: true';

/* HEAD model check */
(async()=>{ try{ const r=await fetch(MODEL_URL,{method:'HEAD',mode:'cors'}); headModel.textContent=`${r.status} ${r.ok?'OK':''}`; headModel.className=r.ok?'ok':'bad'; modelBadge.textContent=r.ok?'200':String(r.status); }catch(e){ headModel.textContent='blocked'; headModel.className='bad'; modelBadge.textContent='ERR'; } })();

/* Canvas sizing */
const ctxPrev = cPrev.getContext('2d',{willReadFrequently:true});
const ctxOver = cOver.getContext('2d');
function fit(){ const r=document.getElementById('stage').getBoundingClientRect(); const d=Math.min(devicePixelRatio||1,2);
  cPrev.width=cOver.width=Math.round(r.width*d); cPrev.height=cOver.height=Math.round(r.height*d);
  cPrev.style.width=cOver.style.width=r.width+'px'; cPrev.style.height=cOver.style.height=r.height+'px';
  ctxPrev.setTransform(d,0,0,d,0,0); ctxOver.setTransform(d,0,0,d,0,0);
  dprEl.textContent=d.toFixed(2); cwEl.textContent=cPrev.width; chEl.textContent=cPrev.height;
}
addEventListener('resize',fit,{passive:true}); fit();

/* MediaPipe init */
let face=null; let lastSchema=null; let showGuides=false;
statusChip.textContent='status: loading model‚Ä¶'; toast('Loading model‚Ä¶');
const fs = await FilesetResolver.forVisionTasks(WASM_ROOT);
face = await FaceLandmarker.createFromOptions(fs,{ baseOptions:{modelAssetPath:MODEL_URL}, runningMode:'VIDEO', numFaces:1 });
statusChip.textContent='status: ready'; toast('Model loaded','ok');

/* Tabs */
document.querySelectorAll('.tab-head button').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tab-head button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.getElementById('tab_'+b.dataset.tab).classList.add('active');
}));

/* Guides */
btnGuides.addEventListener('click',()=>{showGuides=!showGuides; toast(showGuides?'Guides ON':'Guides OFF','ok');});

/* Copy / Export */
function copyArea(el){ navigator.clipboard.writeText(el.value||'').then(()=>toast('Copied','ok')).catch(()=>toast('Clipboard blocked','bad')); }
copyPrompt.addEventListener('click',()=>copyArea(outPrompt));
copyAlt.addEventListener('click',()=>copyArea(outDesc));
btnExport.addEventListener('click',()=>{
  try{ const blob=new Blob([outJson.value],{type:'application/json'}); const url=URL.createObjectURL(blob);
       const a=document.createElement('a'); a.href=url; a.download='face.pf_facemapper.json'; document.body.appendChild(a); a.click();
       setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},200); }catch(e){ toast('Export failed','bad'); }
});

/* Indices + helpers */
const indices={ faceH:[10,152], jawW:[234,454], cheekW:[234,454], foreheadH:[8,10], lipT:[13,14], eyeAngle:[133,362] };
const draw = new DrawingUtils(ctxOver);
function dist(a,b,lm){ const dx=lm[a].x-lm[b].x, dy=lm[a].y-lm[b].y; return Math.hypot(dx,dy); }
const toDeg = r=>r*180/Math.PI;
const eyeAngleDeg = lm => toDeg(Math.atan2(lm[indices.eyeAngle[1]].y-lm[indices.eyeAngle[0]].y, lm[indices.eyeAngle[1]].x-lm[indices.eyeAngle[0]].x));
function bbox(lm){ let minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9; for(const p of lm){ if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y; } return {minX,minY,maxX,maxY}; }
function classify(jaw_face, cheek_face){ if(jaw_face<0.45 && cheek_face<0.55) return 'oval'; if(Math.abs(jaw_face-cheek_face)<0.03 && jaw_face>0.5) return 'round'; if(jaw_face>=0.55 && cheek_face>=0.6) return 'square'; if(cheek_face>jaw_face+0.07) return 'heart'; return 'triangle'; }
function guides(lm,W,H){
  const b=bbox(lm), x0=b.minX*W, y0=b.minY*H, x1=b.maxX*W, y1=b.maxY*H, t=14;
  ctxOver.save(); ctxOver.strokeStyle='rgba(255,255,255,.9)'; ctxOver.lineWidth=1.2;
  ctxOver.beginPath();
  ctxOver.moveTo(x0,y0+t); ctxOver.lineTo(x0,y0); ctxOver.lineTo(x0+t,y0);
  ctxOver.moveTo(x1-t,y0); ctxOver.lineTo(x1,y0); ctxOver.lineTo(x1,y0+t);
  ctxOver.moveTo(x0,y1-t); ctxOver.lineTo(x0,y1); ctxOver.lineTo(x0+t,y1);
  ctxOver.moveTo(x1-t,y1); ctxOver.lineTo(x1,y1); ctxOver.lineTo(x1,y1-t);
  ctxOver.stroke(); ctxOver.restore();
  const tick=(a,b,col)=>{ ctxOver.save(); ctxOver.strokeStyle=col; ctxOver.lineWidth=2;
    ctxOver.beginPath(); ctxOver.moveTo(lm[a].x*W,lm[a].y*H); ctxOver.lineTo(lm[b].x*W,lm[b].y*H); ctxOver.stroke(); ctxOver.restore(); };
  tick(133,362,'rgba(255,255,255,.95)'); tick(13,14,'rgba(255,120,160,.95)'); tick(234,454,'rgba(100,242,227,.95)');
  tick(10,152,'rgba(140,255,220,.95)'); tick(8,10,'rgba(255,220,120,.95)');
}
function palette(W,H,lm){
  const b=bbox(lm);
  const data=ctxPrev.getImageData(0,0,W,H).data;
  function avgRect(x,y,w,h){
    const x0=Math.max(0,Math.floor(x)), y0=Math.max(0,Math.floor(y));
    const x1=Math.min(W,Math.floor(x+w)), y1=Math.min(H,Math.floor(y+h));
    let r=0,g=0,b=0,c=0;
    for(let yy=y0;yy<y1;yy+=2){ for(let xx=x0;xx<x1;xx+=2){ const i=(yy*W+xx)*4; r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; } }
    if(!c) return '#000000'; r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
    return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  }
  const Wc=cPrev.width/(devicePixelRatio||1), Hc=cPrev.height/(devicePixelRatio||1);
  const hair=avgRect(b.minX*Wc, Math.max(0,b.minY*Hc-12), (b.maxX-b.minX)*Wc, 10);
  const skin=avgRect(b.minX*Wc + 0.35*(b.maxX-b.minX)*Wc, b.minY*Hc + 0.45*(b.maxY-b.minY)*Hc, 18, 18);
  const e=lm[133]; const eyes=avgRect(e.x*Wc-8, e.y*Hc-8, 16, 16);
  return {hair,skin,eyes};
}
function buildSchema(frameType, ms, imgW, imgH, lm){
  const Wc=cPrev.width/(devicePixelRatio||1), Hc=cPrev.height/(devicePixelRatio||1);
  const faceH=dist(10,152,lm)*Wc, jawW=dist(234,454,lm)*Wc, cheekW=dist(234,454,lm)*Wc, foreH=dist(8,10,lm)*Wc, lipT=dist(13,14,lm)*Wc, eyeDeg=eyeAngleDeg(lm);
  const ratios={ jaw_face:+(jawW/faceH).toFixed(3), cheek_face:+(cheekW/faceH).toFixed(3), forehead_face:+(foreH/faceH).toFixed(3), lip_face:+(lipT/faceH).toFixed(3) };
  const shape=classify(ratios.jaw_face, ratios.cheek_face);
  const pal=palette(Wc,Hc,lm);
  const landmarks_norm = lm.map(p=>[+p.x.toFixed(6),+p.y.toFixed(6),+(p.z??0).toFixed(6)]);

  const schema={
    version:"pf_facemapper_3",
    indices,
    frame:{type:frameType, ...(typeof ms==='number'?{ms}:{})},
    image:{width:imgW,height:imgH},
    measures_px:{ face_height:+faceH.toFixed(3), jaw_width:+jawW.toFixed(3), cheek_width:+cheekW.toFixed(3), forehead_height:+foreH.toFixed(3), lip_thickness:+lipT.toFixed(3), eye_angle_deg:+eyeDeg.toFixed(2) },
    ratios, shape, palette_hex:pal, landmarks_norm
  };

  // Outputs
  shapeChip.textContent=`shape: ${shape}`;
  liveNums.textContent=`eye: ${schema.measures_px.eye_angle_deg}¬∞, jaw/face: ${ratios.jaw_face}, cheek/face: ${ratios.cheek_face}`;
  outMeas.value=[
    `faceH: ${schema.measures_px.face_height}px`,
    `jawW: ${schema.measures_px.jaw_width}px`,
    `foreheadH: ${schema.measures_px.forehead_height}px`,
    `lipT: ${schema.measures_px.lip_thickness}px`,
    `eyeDeg: ${schema.measures_px.eye_angle_deg}¬∞`,
    `ratios (jaw/face, cheek/face, forehead/face, lip/face): ${ratios.jaw_face}, ${ratios.cheek_face}, ${ratios.forehead_face}, ${ratios.lip_face}`
  ].join('\n');
  palHair.style.background=pal.hair; palSkin.style.background=pal.skin; palEyes.style.background=pal.eyes;
  outPal.value=JSON.stringify(pal,null,2);
  outPrompt.value=`Front-facing portrait, ${shape} face, jaw/face ${ratios.jaw_face}, cheek/face ${ratios.cheek_face}, eye angle ${schema.measures_px.eye_angle_deg}¬∞, hair ${pal.hair}, skin ${pal.skin}, eyes ${pal.eyes}, neutral light, minimal distortion`;
  outDesc.value=`Detected a ${shape} face. Measures (px): face ${schema.measures_px.face_height}, jaw ${schema.measures_px.jaw_width}, forehead ${schema.measures_px.forehead_height}, lips ${schema.measures_px.lip_thickness}. Ratios ‚Äî jaw/face ${ratios.jaw_face}, cheek/face ${ratios.cheek_face}, forehead/face ${ratios.forehead_face}, lip/face ${ratios.lip_face}. Eye angle ${schema.measures_px.eye_angle_deg}¬∞. Palette: hair ${pal.hair}, skin ${pal.skin}, eyes ${pal.eyes}.`;
  outJson.value=JSON.stringify(schema,null,2);
  copyPrompt.disabled=copyAlt.disabled=btnExport.disabled=false; btnShot.disabled=false;

  return schema;
}

/* Render */
function render(res, kind, dim){
  const W=cPrev.width/(devicePixelRatio||1), H=cPrev.height/(devicePixelRatio||1);
  ctxOver.clearRect(0,0,W,H);
  const lm = res?.faceLandmarks && res.faceLandmarks[0];
  if(!lm){ mower.style.opacity=.36; statusChip.textContent='status: no face'; return; }
  mower.style.opacity=.08; statusChip.textContent='status: mapping‚Ä¶';

  // Tessellation + regions
  try{ (new DrawingUtils(ctxOver)).drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_TESSELLATION, {color:'rgba(100,242,227,.95)',lineWidth:.9}); }catch{}
  const d = new DrawingUtils(ctxOver);
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE,     {color:'rgba(255,255,255,.95)',lineWidth:2});
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE,      {color:'rgba(255,255,255,.95)',lineWidth:2});
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYEBROW, {color:'rgba(255,220,120,.95)',lineWidth:2});
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_LEFT_EYEBROW,  {color:'rgba(255,220,120,.95)',lineWidth:2});
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_LIPS,          {color:'rgba(255,120,160,.95)',lineWidth:2});
  d.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_FACE_OVAL,     {color:'rgba(140,255,220,.95)',lineWidth:2});

  if(showGuides){
    guides(lm,W,H);
  }

  lastSchema = buildSchema(kind, (kind==='video')?(performance.now()|0):undefined, dim.w, dim.h, lm);
}

/* Camera */
let stream=null;
async function startCam(){
  if(!('mediaDevices' in navigator)){ toast('Camera API unavailable','bad'); return; }
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user', width:{ideal:1280}, height:{ideal:720}}, audio:false });
    video.srcObject=stream; await video.play(); toast('Camera enabled','ok'); statusChip.textContent='status: camera';
    loopVideo();
  }catch(e){ toast(`Camera blocked: ${e?.name||'error'}`,'bad'); }
}
btnCam.addEventListener('click', startCam);

/* Image load */
btnImgBtn.addEventListener('click', ()=> fileImg.click());
fileImg.addEventListener('change', async ()=>{
  const f=fileImg.files && fileImg.files[0]; if(!f){ toast('No file selected','warn'); return; }
  const url=URL.createObjectURL(f); const img=new Image(); img.onload=async ()=>{
    try{
      await face.setOptions({runningMode:'IMAGE'});
      const W=cPrev.width/(devicePixelRatio||1), H=cPrev.height/(devicePixelRatio||1);
      // center-fit
      ctxPrev.clearRect(0,0,W,H);
      const r=Math.min(W/img.width, H/img.height), w=img.width*r, h=img.height*r, x=(W-w)/2, y=(H-h)/2;
      ctxPrev.drawImage(img, x, y, w, h);
      const res = await face.detect(img);
      render(res,'image',{w:img.width,h:img.height,drawW:W,drawH:H});
      btnShot.disabled=false; toast('Image mapped','ok'); statusChip.textContent='status: image';
    }catch(err){ console.error(err); toast('Image detect failed','bad'); }
    URL.revokeObjectURL(url);
  }; img.onerror=()=>{ toast('Image load failed','bad'); URL.revokeObjectURL(url); };
  img.src=url;
});

/* VIDEO loop */
const useRVFC = "requestVideoFrameCallback" in HTMLVideoElement.prototype;
function loopVideo(){
  if(!face || !video.srcObject) return;
  face.setOptions({runningMode:'VIDEO'});
  const drawFrame = async (tsMs)=>{
    const W=cPrev.width/(devicePixelRatio||1), H=cPrev.height/(devicePixelRatio||1);
    ctxPrev.drawImage(video,0,0,W,H);
    const res = await face.detectForVideo(video, tsMs);
    render(res,'video',{w:video.videoWidth,h:video.videoHeight,drawW:W,drawH:H});
  };
  if(useRVFC){
    const cb=async(_,meta)=>{ await drawFrame(Math.round(meta.mediaTime*1000)); video.requestVideoFrameCallback(cb); };
    video.requestVideoFrameCallback(cb);
  }else{
    const tick=async()=>{ if(video.readyState>=2){ await drawFrame(performance.now()); } requestAnimationFrame(tick); };
    requestAnimationFrame(tick);
  }
}

/* Snapshot */
btnShot.addEventListener('click', ()=>{
  if(!lastSchema){ toast('Nothing to snapshot','warn'); return; }
  const blob=new Blob([JSON.stringify(lastSchema,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='snapshot.pf_facemapper.json';
  document.body.appendChild(a); a.click(); setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},200);
  toast('Snapshot exported','ok');
});
</script>
</body>
</html>
