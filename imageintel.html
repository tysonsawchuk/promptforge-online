<!-- /imageintel.html — ImageIntel Pro Lab (r6)
  * Critical: UI boots BEFORE model import; even if CDN import fails, upload/self-test work.
  * Adds: Non-blocking vision loader, clearer banners, copyable bug bundle, matrix test.
  * Keeps: Objects/Pose/Face/Hands/Seg overlays, prompts, exports.
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ImageIntel Pro Lab — BlackSite HUD</title>
<meta name="color-scheme" content="dark"/>
<style>
:root{--bg:#070a0f;--grid:rgba(255,255,255,.04);--panel:#0d121a;--muted:#94a3b8;--text:#e6f1ff;--chip:#101826}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 1200px at 10% -10%,#0c1420,var(--bg)) fixed;color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:28px 28px;mask-image:radial-gradient(1000px 700px at 10% 0%,#000 80%,transparent)}
.app{position:relative;z-index:1;height:100%;display:grid;gap:12px;padding:12px;grid-template-columns:1.25fr .75fr;grid-template-rows:62% 38%;grid-template-areas:"stage side" "kpi side"}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.005));border:1px solid rgba(255,255,255,.08);border-radius:18px;backdrop-filter:blur(6px)}
.title{font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:11px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.col{display:grid;gap:8px}
.chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;font-size:12px;color:#b6cdfb}
.btn{background:linear-gradient(180deg,rgba(62,248,255,.15),rgba(62,248,255,.06));border:1px solid rgba(62,248,255,.45);color:#cfffff;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.secondary{border-color:rgba(102,255,153,.45);background:linear-gradient(180deg,rgba(102,255,153,.16),rgba(102,255,153,.06));color:#dbffe8}
.btn.warn{border-color:rgba(255,209,102,.45);background:linear-gradient(180deg,rgba(255,209,102,.16),rgba(255,209,102,.06));color:#fff3cf}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
.toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
.toggle input{appearance:none;width:30px;height:18px;border-radius:999px;background:#15202f;border:1px solid rgba(255,255,255,.2);position:relative}
.toggle input:checked{background:#0e2c2c;border-color:rgba(62,248,255,.5)}
.toggle input::after{content:"";position:absolute;top:1px;left:1px;width:14px;height:14px;background:#9aa7bd;border-radius:50%;transition:160ms}
.toggle input:checked::after{left:calc(100% - 15px);background:#72ffd5}
#stage{grid-area:stage;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
.stage-head{padding:10px;display:flex;align-items:center;justify-content:space-between}
.canvas-wrap{position:relative;overflow:hidden;background:#0b0f14;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);height:100%;min-height:340px}
#inputImage{max-width:100%;max-height:100%;display:block;object-fit:contain}
#overlay{position:absolute;left:0;top:0;image-rendering:pixelated}
.drop{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,.15);border-radius:12px;color:#9fb5d8;pointer-events:none;opacity:.18}
.loaded{border-color:rgba(102,255,153,.45)!important;color:#d7ffe8!important;opacity:.22}
#kpis{grid-area:kpi;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px;overflow:auto}
.kpi{background:#0d121a;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;min-height:120px;display:grid;grid-template-rows:auto 1fr}
.list{display:grid;gap:6px;font-size:12px}.pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between}
#side{grid-area:side;display:grid;grid-template-rows:auto 1fr auto}
#terminal{height:160px;overflow:auto;background:#05070b;border-top:1px solid rgba(255,255,255,.08);padding:8px;font:12px ui-monospace,Menlo,Consolas;color:#b0c3e6}
.log.ok{color:#5cff7a}.log.err{color:#ff4d6d}
.statusbar{display:flex;gap:6px;flex-wrap:wrap}.statusbar .chip.ok{border-color:rgba(102,255,153,.45);color:#d5ffe5}.statusbar .chip.err{border-color:rgba(255,77,109,.45);color:#ffd0da}
textarea{width:100%;resize:vertical;background:#05070b;color:#e6f1ff;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
pre#diagDump{max-height:160px;overflow:auto;background:#03050a;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;color:#cfe1ff}
details{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;background:#0c1118}
details+details{margin-top:8px}
details>summary{cursor:pointer;color:#c5d7f2}
.compact .hide-when-compact{display:none}
.header-actions{display:flex;gap:8px;align-items:center}
.errbanner{position:fixed;left:12px;right:12px;bottom:12px;background:#2a0f12;border:1px solid #ff4d6d;color:#ffdbe2;padding:10px;border-radius:12px;z-index:9999;display:none}
</style>
</head>
<body>
<div class="app">
  <section id="stage" class="card">
    <div class="stage-head">
      <div class="row">
        <span class="title">BLACKSITE HUD</span>
        <span class="chip">Objects</span><span class="chip">Pose</span><span class="chip">Face</span><span class="chip">Hands</span><span class="chip">Body Mesh</span><span class="chip">Silhouette</span><span class="chip">Seg</span><span class="chip">Edges</span>
        <span class="chip" id="fpsChip">FPS — n/a</span>
      </div>
      <div class="header-actions">
        <input id="file" type="file" accept="image/*" style="display:none"/>
        <label class="btn" for="file">Upload Image</label>
        <button id="runBtn" class="btn secondary" disabled>Run Analysis</button>
        <label class="toggle"><input id="compactUI" type="checkbox" checked><span>Compact UI</span></label>
      </div>
    </div>
    <div class="canvas-wrap" id="canvasWrap">
      <img id="inputImage" alt="input"/>
      <canvas id="overlay"></canvas>
      <div class="drop" id="dropHint">Drop / Paste an image here</div>
    </div>
    <div class="panel-body" style="display:grid;grid-template-columns:1fr auto;align-items:center;padding:10px;">
      <div class="statusbar">
        <span class="chip" id="st-wasm">WASM — …</span>
        <span class="chip" id="st-obj">Object — …</span>
        <span class="chip" id="st-pose">Pose — …</span>
        <span class="chip" id="st-face">Face — …</span>
        <span class="chip" id="st-hands">Hands — …</span>
        <span class="chip" id="st-seg">Seg — …</span>
        <span class="chip" id="st-image">Image — …</span>
        <span class="chip" id="st-run">Detectors — …</span>
      </div>
      <div class="row">
        <button id="exportPng" class="btn">PNG</button>
        <button id="exportMasked" class="btn">Masked PNG</button>
        <button id="exportJson" class="btn">Report .json</button>
      </div>
    </div>
  </section>

  <section id="kpis" class="card">
    <div class="kpi"><h4 class="title">Subject</h4><div class="list" id="subjectList"></div></div>
    <div class="kpi"><h4 class="title">Objects</h4><div class="list" id="objectList"></div></div>
    <div class="kpi"><h4 class="title">Pose</h4><div class="list" id="poseList"></div></div>
    <div class="kpi"><h4 class="title">Color / Lighting</h4><div class="list" id="colorList"></div></div>
  </section>

  <aside id="side" class="card">
    <details open>
      <summary>Overlays & Controls</summary>
      <div class="row">
        <label class="toggle"><input id="tgObjects" type="checkbox" checked><span>Objects</span></label>
        <label class="toggle"><input id="tgPose" type="checkbox" checked><span>Pose</span></label>
        <label class="toggle"><input id="tgFace" type="checkbox" checked><span>Face</span></label>
        <label class="toggle"><input id="tgHands" type="checkbox" checked><span>Hands</span></label>
        <label class="toggle"><input id="tgBody" type="checkbox" checked><span>Body Mesh</span></label>
        <label class="toggle"><input id="tgSil" type="checkbox" checked><span>Silhouette</span></label>
        <label class="toggle"><input id="tgSeg" type="checkbox" checked><span>Seg</span></label>
        <label class="toggle"><input id="tgEdges" type="checkbox" checked><span>Edges</span></label>
        <label class="toggle" title="Force CPU delegates"><input id="safeMode" type="checkbox" checked><span>Safe Mode</span></label>
      </div>
      <div class="row hide-when-compact">
        <div class="col" style="min-width:130px"><label>Objects</label><input id="opObjects" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        <div class="col" style="min-width:130px"><label>Pose</label><input id="opPose" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        <div class="col" style="min-width:130px"><label>Face</label><input id="opFace" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        <div class="col" style="min-width:130px"><label>Hands</label><input id="opHands" type="range" min="0" max="1" step="0.05" value="0.9"/></div>
        <div class="col" style="min-width:130px"><label>Body</label><input id="opBody" type="range" min="0" max="1" step="0.05" value="0.8"/></div>
        <div class="col" style="min-width:130px"><label>Silhouette</label><input id="opSil" type="range" min="0" max="1" step="0.05" value="0.35"/></div>
        <div class="col" style="min-width:130px"><label>Seg</label><input id="opSeg" type="range" min="0" max="1" step="0.05" value="0.35"/></div>
        <div class="col" style="min-width:130px"><label>Edges</label><input id="opEdges" type="range" min="0" max="1" step="0.05" value="0.4"/></div>
        <div class="col" style="min-width:150px"><label>&nbsp;</label><label class="toggle"><input id="segHeat" type="checkbox" checked><span>Heatmap</span></label></div>
      </div>
    </details>

    <details open>
      <summary>Prompt Engine</summary>
      <div class="row">
        <div class="col" style="min-width:180px;">
          <label>Prompt Mode</label>
          <select id="mode">
            <option value="sfw">SFW</option>
            <option value="nsfw_safe">NSFW-safe (redacted)</option>
            <option value="edgy">Edgy</option>
            <option value="poetic">Poetic</option>
            <option value="numeric">Numeric</option>
            <option value="json">Raw JSON</option>
          </select>
        </div>
        <div class="col" style="min-width:180px;">
          <label>Model Style</label>
          <select id="modelStyle">
            <option value="generic">Generic</option>
            <option value="sdxl">SDXL-like</option>
            <option value="jugger">JuggernautXL-like</option>
          </select>
        </div>
        <div class="col" style="min-width:180px;">
          <label>Style Pack</label>
          <select id="stylePack">
            <option value="neutral">Neutral</option>
            <option value="tealorange">Cinematic Teal/Orange</option>
            <option value="pastel">Soft Pastel</option>
            <option value="mono">High-Contrast Mono</option>
            <option value="vintage">Warm Vintage</option>
          </select>
        </div>
        <div class="col" style="min-width:200px;"><label>Detail</label><input id="detail" type="range" min="0" max="100" step="1" value="85"/></div>
      </div>
      <div class="panel-head" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;">
        <span class="title">Prompt Output</span><span class="chip" id="promptChars">0 chars</span>
      </div>
      <textarea id="promptOut" rows="6" placeholder="Run analysis to generate a prompt…"></textarea>

      <div class="panel-head" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;">
        <span class="title">Compare Prompts — A / B / C</span>
        <div class="row"><button id="genABC" class="btn">Generate A/B/C</button><button id="copyABC" class="btn">Copy All</button></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div class="col"><label class="title">A</label><textarea id="pA" rows="6"></textarea></div>
        <div class="col"><label class="title">B</label><textarea id="pB" rows="6"></textarea></div>
        <div class="col"><label class="title">C</label><textarea id="pC" rows="6"></textarea></div>
      </div>

      <div class="row hide-when-compact">
        <button id="copyPrompt" class="btn">Copy Prompt</button>
        <button id="downloadPrompt" class="btn">Download .txt</button>
      </div>
    </details>

    <details open>
      <summary>Diagnostics</summary>
      <pre id="diagDump" class="slab" aria-label="Diagnostics Output"></pre>
      <div class="row"><span class="title">NSFW Gate</span><span class="chip" id="nsfwGate">Disabled</span></div>
      <div id="terminal"></div>
      <div class="row">
        <button id="overlayTest" class="btn ghost">Overlay Test</button>
        <button id="matrixTest" class="btn">Matrix Test</button>
        <button id="reinit" class="btn warn">Re-Init Models</button>
        <button id="selfTest" class="btn">Self-Test</button>
        <button id="copyDiag" class="btn">Copy Diag</button>
        <button id="copyBundle" class="btn">Copy Bug Bundle</button>
      </div>
    </details>
  </aside>
</div>
<div id="errbanner" class="errbanner"></div>

<script type="module">
/************ EARLY UI + LOG (runs even if CDN import fails) ************/
const $=id=>document.getElementById(id);
const img=$('inputImage'), wrap=$('canvasWrap'), canvas=$('overlay'), ctx=canvas.getContext('2d',{willReadFrequently:true});
const fileInput=$('file'), runBtn=$('runBtn'), diag=$('diagDump'), logEl=$('terminal'), fpsChip=$('fpsChip');
const status={wasm:$('st-wasm'),obj:$('st-obj'),pose:$('st-pose'),face:$('st-face'),hands:$('st-hands'),seg:$('st-seg'),image:$('st-image'),run:$('st-run')};
const tgEdges=$('tgEdges'), opEdges=$('opEdges');
const dropHint=$('dropHint');
const STATE={modelsReady:false,imageReady:false};
const log=(m,ok)=>{ const d=document.createElement('div'); d.textContent=m; d.className='log'+(ok===true?' ok':ok===false?' err':''); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; };
const setChip=(el,ok,labelOK='OK',labelERR='ERR')=>{ el.textContent=ok?labelOK:labelERR; el.classList.toggle('ok',!!ok); el.classList.toggle('err',!ok); };
function resize(){ if(!img.naturalWidth) return; const r=wrap.getBoundingClientRect(); const ia=img.naturalWidth/img.naturalHeight, ra=r.width/r.height; let w,h; if(ia>ra){w=r.width;h=w/ia;} else {h=r.height;w=h*ia;} canvas.width=w|0; canvas.height=h|0; img.style.width=w+'px'; img.style.height=h+'px'; }
function rgbToHsl(r,g,b){ r/=255;g/=255;b/=255; const mx=Math.max(r,g,b),mn=Math.min(r,g,b); let h,s,l=(mx+mn)/2; if(mx===mn){h=s=0;} else { const d=mx-mn; s=l>0.5? d/(2-mx-mn): d/(mx+mn); switch(mx){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;default:h=(r-g)/d+4;} h/=6; } return [h,s,l]; }
function analyzeColor(el,maxSide=180){ const c=document.createElement('canvas'),cx=c.getContext('2d'); const w=el.naturalWidth,h=el.naturalHeight; if(!w||!h) return null; const s=Math.min(1,maxSide/Math.max(w,h)); c.width=Math.max(1,(w*s)|0); c.height=Math.max(1,(h*s)|0); cx.drawImage(el,0,0,c.width,c.height); const d=cx.getImageData(0,0,c.width,c.height).data; let lumSum=0,n=0; for(let i=0;i<d.length;i+=24){ const r=d[i],g=d[i+1],b=d[i+2]; lumSum += (0.2126*r+0.7152*g+0.0722*b)/255; n++; } const avgL=lumSum/(n||1); const lighting=avgL>0.7?'bright':avgL<0.35?'dim':'moderate'; return {avg_brightness:+avgL.toFixed(3), lighting}; }
function drawEdges(alpha=0.4){ const w=canvas.width,h=canvas.height; if(!w||!h) return; const oc=document.createElement('canvas'); oc.width=w; oc.height=h; const ox=oc.getContext('2d',{willReadFrequently:true}); ox.drawImage(img,0,0,w,h); const src=ox.getImageData(0,0,w,h); const out=ox.createImageData(w,h); const Gx=[-1,0,1,-2,0,2,-1,0,1], Gy=[-1,-2,-1,0,0,0,1,2,1]; for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ let sx=0,sy=0,pi=0; for(let ky=-1;ky<=1;ky++){ for(let kx=-1;kx<=1;kx++){ const ix=((y+ky)*w+(x+kx))*4; const lum=0.2126*src.data[ix]+0.7152*src.data[ix+1]+0.0722*src.data[ix+2]; sx+=lum*Gx[pi]; sy+=lum*Gy[pi]; pi++; } } const m=Math.min(255,Math.hypot(sx,sy)); const o=(y*w+x)*4; out.data[o]=out.data[o+1]=out.data[o+2]=m; out.data[o+3]=m>40?255:0; } } ox.putImageData(out,0,0); ctx.save(); ctx.globalAlpha=alpha; ctx.drawImage(oc,0,0); ctx.restore(); }
function promptFallback(){ const c=analyzeColor(img); const basic = `subject centered, portrait shot${c?`, ${c.lighting} lighting`:''}`; const out = `${basic}
NEGATIVE: lowres, blur, watermark`; $('promptOut').value=out; $('promptChars').textContent=`${out.length} chars`; }
function imageLoadedUI(){ resize(); setChip(status.image,true,'Image — OK'); STATE.imageReady=true; log('Image loaded ✓', true); // draw fallback edges so user sees something even without models
  if(tgEdges?.checked) { ctx.clearRect(0,0,canvas.width,canvas.height); drawEdges(+opEdges.value||0.4); }
  promptFallback(); runBtn.disabled=false; }

// Upload bindings (always on)
function isImg(f){ return /^image\//i.test(f?.type||''); }
async function fileToDataUrlViaBitmap(file){ const bmp=await createImageBitmap(file).catch(()=>null); if(!bmp) return null; const c=document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height; const cx=c.getContext('2d'); cx.drawImage(bmp,0,0); return c.toDataURL('image/png'); }
function readAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(fr.error); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); }); }
async function loadFileToImage(file){ if(!file){ log('No file picked', false); return; } if(!isImg(file)){ log(`Unsupported file: ${file.type||'unknown'}`, false); setChip(status.image,false,'Image — ERR'); return; } let url=null; try{ url=await fileToDataUrlViaBitmap(file); if(!url) url=await readAsDataURL(file); }catch(e){ log('Decode fallback failed: '+(e?.message||e), false);} if(!url){ log('Could not decode image', false); setChip(status.image,false,'Image — ERR'); return; } img.decoding='async'; img.loading='eager'; img.onload=imageLoadedUI; img.onerror=()=>{ log('Image error: cannot decode/display', false); setChip(status.image,false,'Image — ERR'); STATE.imageReady=false; }; img.src=url; }
['dragenter','dragover'].forEach(ev=>$('canvasWrap').addEventListener(ev,(e)=>{ e.preventDefault(); $('dropHint').style.opacity='.38'; }));
['dragleave','drop'].forEach(ev=>$('canvasWrap').addEventListener(ev,(e)=>{ e.preventDefault(); $('dropHint').style.opacity='.18'; }));
$('canvasWrap').addEventListener('drop',(e)=>{ const f=e.dataTransfer?.files?.[0]; if(f) loadFileToImage(f); });
window.addEventListener('paste',(e)=>{ const item=[...(e.clipboardData?.items||[])].find(i=>i.type.startsWith('image/')); if(!item) return; const f=item.getAsFile(); if(f){ log('Pasted image…'); loadFileToImage(f);} });
fileInput.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(f){ log('Loading local image…'); loadFileToImage(f);} });
window.addEventListener('resize', resize); img.addEventListener('load', resize);
$('overlayTest').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='#9ad1ff'; ctx.shadowColor='#9ad1ff'; ctx.shadowBlur=8; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(canvas.width,canvas.height); ctx.moveTo(canvas.width,0); ctx.lineTo(0,canvas.height); ctx.stroke(); ctx.font='16px ui-sans-serif'; ctx.fillStyle='#9ad1ff'; ctx.fillText('OVERLAY OK',12,22); log('Overlay test drawn ✓', true); });
$('selfTest').addEventListener('click', ()=>{ diag.textContent=[`UA: ${navigator.userAgent}`,`Lang: ${navigator.language}`,`Platform: ${navigator.platform}`,`Cores: ${navigator.hardwareConcurrency||'?'} / Mem: ${navigator.deviceMemory||'?'}GB`].join('
'); log('Self-test captured environment ✓', true); });
$('copyDiag').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(diag.textContent); log('Diagnostics copied ✓', true);}catch{ log('Copy failed', false);} });
(function tick(){ const fpsv=(1000/16.7).toFixed(1); fpsChip.textContent=`FPS — ${fpsv}`; requestAnimationFrame(tick); })();
log('BOOT: UI wired ✓');

/************ Non-blocking vision import + full pipeline (loads after UI) ************/
let vision, FilesetResolver, ObjectDetector, PoseLandmarker, FaceLandmarker, ImageSegmenter, HandLandmarker;
let detector, poser, facer, hands, segmenter;
async function loadVision(){ const CANDS=[
  'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs',
  'https://unpkg.com/@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs',
  'https://ga.jspm.io/npm:@mediapipe/tasks-vision@0.10.21/vision_bundle.mjs'
]; let lastErr=''; for(const u of CANDS){ try{ vision=await import(u); break; }catch(e){ lastErr=e?.message||String(e); log(`Import fail: ${u} → ${lastErr}`, false); } }
 if(!vision){ setChip(status.wasm,false,'WASM — ERR'); log('tasks-vision NOT loaded. You can still upload and use overlays/edges/prompt fallback.', false); return false; }
 ({ FilesetResolver, ObjectDetector, PoseLandmarker, FaceLandmarker, ImageSegmenter, HandLandmarker } = vision); setChip(status.wasm,true,'WASM — OK'); log('WASM/module ready', true); return true; }
async function initModels(){ if(!vision){ const ok=await loadVision(); if(!ok) return; }
 try{ const fsr=await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.21/wasm');
  detector=await ObjectDetector.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite', delegate:'CPU' }, runningMode:'IMAGE', scoreThreshold:.5, maxResults:10 }); setChip(status.obj,true,'Object — OK');
  const delegate= $('safeMode')?.checked ? 'CPU' : 'GPU';
  poser=await PoseLandmarker.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task', delegate }, runningMode:'IMAGE', numPoses:1 }); setChip(status.pose,true,'Pose — OK');
  facer=await FaceLandmarker.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task', delegate }, runningMode:'IMAGE', numFaces:1, outputFacialTransformationMatrixes:true }); setChip(status.face,true,'Face — OK');
  hands=await HandLandmarker.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task', delegate }, runningMode:'IMAGE', numHands:2 }); setChip(status.hands,true,'Hands — OK');
  segmenter=await ImageSegmenter.createFromOptions(fsr,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/1/selfie_segmenter.task', delegate }, runningMode:'IMAGE', outputConfidenceMasks:true }); setChip(status.seg,true,'Seg — OK');
  STATE.modelsReady=true; runBtn.disabled=false; log('All models ready ✓', true);
  if(STATE.imageReady) runAll();
 }catch(e){ log('Init error: '+(e?.message||e), false); }
}

// Draw helpers used by pipeline
const LM={ NOSE:0, L_SH:11, R_SH:12, L_HIP:23, R_HIP:24, L_ELB:13, R_ELB:14, L_WR:15, R_WR:16, L_KNEE:25, R_KNEE:26, L_ANK:27, R_ANK:28 };
const EDGES=[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
function glowStroke(color, blur=12){ ctx.strokeStyle=color; ctx.shadowColor=color; ctx.shadowBlur=blur; }
function glowFill(color, blur=10){ ctx.fillStyle=color; ctx.shadowColor=color; ctx.shadowBlur=blur; }
function drawPose(res,a){ if(!res?.landmarks?.length) return; const l=res.landmarks[0]; ctx.save(); ctx.globalAlpha=a; ctx.lineWidth=3; glowStroke('rgba(102,255,153,.95)',12); EDGES.forEach(([i,j])=>{ const p=l[i], q=l[j]; if(!p||!q) return; ctx.beginPath(); ctx.moveTo(p.x*canvas.width,p.y*canvas.height); ctx.lineTo(q.x*canvas.width,q.y*canvas.height); ctx.stroke(); }); glowFill('rgba(102,255,153,.95)',8); [LM.L_SH,LM.R_SH,LM.L_HIP,LM.R_HIP,LM.NOSE].forEach(k=>{const p=l[k]; if(!p) return; ctx.beginPath(); ctx.arc(p.x*canvas.width,p.y*canvas.height,4,0,6.283); ctx.fill();}); ctx.restore(); }
function drawFace(face,a){ if(!face?.faceLandmarks?.length) return; const LMK = face.faceLandmarks; ctx.save(); ctx.globalAlpha=a; glowFill('rgba(255,220,140,.95)',6); LMK.forEach(l=>{ l.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x*canvas.width, p.y*canvas.height, 1.7, 0, 6.283); ctx.fill(); }); }); ctx.restore(); }
function scaleBox(b){ const sx=canvas.width/img.naturalWidth, sy=canvas.height/img.naturalHeight; return {x:b.originX*sx,y:b.originY*sy,w:b.width*sx,h:b.height*sy}; }
function drawObjects(res,a){ if(!res) return; ctx.save(); ctx.globalAlpha=a; ctx.lineWidth=2.5; ctx.font='12px ui-sans-serif'; res.detections.forEach(d=>{ const {x,y,w,h}=scaleBox(d.boundingBox); glowStroke('rgba(62,248,255,.95)',10); ctx.strokeRect(x,y,w,h); const name=d.categories?.[0]?.categoryName||'object', s=d.categories?.[0]?.score||0, lab=`${name} ${(s*100).toFixed(0)}%`; const tw=ctx.measureText(lab).width+12, th=18; glowFill('rgba(15,27,38,.92)',0); ctx.fillRect(x,Math.max(0,y-th),tw,th); glowStroke('rgba(62,248,255,.45)',0); ctx.strokeRect(x,Math.max(0,y-th),tw,th); ctx.fillStyle='#c7faff'; ctx.fillText(lab,x+6,Math.max(0,y-th)+13); }); ctx.restore(); }

async function runAll(){ log('Run start ▶', true); if(!STATE.imageReady){ log('No image loaded yet.', false); return; } if(!STATE.modelsReady){ log('Models not ready; running fallback only.', false); ctx.clearRect(0,0,canvas.width,canvas.height); if(tgEdges.checked) drawEdges(+opEdges.value||0.4); promptFallback(); return; }
  ctx.clearRect(0,0,canvas.width,canvas.height); setChip(status.run,false,'Detectors — …');
  // Perform detections
  let objs=null, pose=null, face=null;
  try{ pose=await poser.detect(img); }catch(e){ log('Pose detect failed: '+e.message,false); }
  try{ face=await facer.detect(img); }catch(e){ log('Face detect failed: '+e.message,false); }
  try{ objs=await detector.detect(img); }catch(e){ log('Object detect failed: '+e.message,false); }
  // Draw
  drawPose(pose,0.9); drawFace(face,0.9); drawObjects(objs,0.9); if(tgEdges.checked) drawEdges(+opEdges.value||0.4);
  // Minimal KPIs
  $('subjectList').innerHTML=''; const view=(pose?.landmarks?.length)?'frontal/3⁄4':'unknown'; ['view '+view].forEach(v=>{ const li=document.createElement('div'); li.className='pill'; li.innerHTML=`<span>Subject</span><span>${v}</span>`; $('subjectList').appendChild(li); });
  $('objectList').innerHTML = objs?.detections?.length ? objs.detections.map(d=>`<div class="pill"><span>${d.categories?.[0]?.categoryName||'obj'}</span><span>${(d.categories?.[0]?.score*100|0)}%</span></div>`).join('') : '<div class="pill"><span>—</span><span>n/a</span></div>';
  // Prompt (simple)
  const c=analyzeColor(img); const pos=`photorealistic, subject centered, ${(c?c.lighting:'moderate')} lighting`; const neg='lowres, blur, watermark'; const comb=`${pos}
NEGATIVE: ${neg}`; $('promptOut').value=comb; $('promptChars').textContent=`${comb.length} chars`;
  setChip(status.run,true,'Detectors — OK'); log('Analysis complete ✓', true);
}

runBtn.addEventListener('click', ()=>{ log('Run clicked', true); runAll(); });

// Boot vision asynchronously, but never block UI
initModels();
</script>
</body>
</html>
