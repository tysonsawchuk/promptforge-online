<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PromptForge — Image Intelligence Portal (Face Mapping • Scene Captioning • JSON/Embedding Export)</title>
  <meta name="description" content="PromptForge Image Intelligence: client-side face mapping with landmark mesh and ratios, full-image captioning, object tags (COCO-SSD), OCR (Tesseract), animated scan overlay, and pro exports for SDXL/Flux/MJ or LoRA/DreamBooth. 100% local-first." />
  <link rel="canonical" href="https://promptforge.online/image-intel.html" />
  <meta name="theme-color" content="#08131b" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="PromptForge — Image Intelligence Portal" />
  <meta property="og:description" content="Analyze → Measure → Explain. Live landmark mesh, creative ratios, animated scan, and JSON/embedding exports. J1NX assistant built in." />
  <meta property="og:image" content="/assets/og/imagetoprompt.png" />
  <meta property="og:url" content="https://promptforge.online/image-intel.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- JSON-LD: Organization + WebSite + Breadcrumbs + FAQ -->
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"PromptForge",
    "url":"https://promptforge.online/",
    "logo":"https://promptforge.online/assets/og/home.png",
    "sameAs":["https://x.com/GoreandGiggles","https://bsky.app/profile/goreandgiggles.bsky.social","https://promptforge.online/support.html"]
  }</script>
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"PromptForge",
    "url":"https://promptforge.online/",
    "potentialAction":{"@type":"SearchAction","target":"https://promptforge.online/?q={search_term_string}","query-input":"required name=search_term_string"}
  }</script>
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://promptforge.online/"},
      {"@type":"ListItem","position":2,"name":"Tools","item":"https://promptforge.online/#tools"},
      {"@type":"ListItem","position":3,"name":"Image Intelligence"}
    ]
  }</script>
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"What is the PromptForge Image Intelligence Portal?","acceptedAnswer":{"@type":"Answer","text":"A client-side lab that converts an image into a professional caption, structured prompt, landmark JSON, numeric facial ratios, and optional embeddings for image models (SDXL, Flux, Midjourney) or local LoRA/DreamBooth."}},
      {"@type":"Question","name":"Does it upload my images?","acceptedAnswer":{"@type":"Answer","text":"No. Analysis runs in your browser by default. You can explicitly export JSON to your device."}},
      {"@type":"Question","name":"How do I get a stylized copy (e.g., 'me as …')?","acceptedAnswer":{"@type":"Answer","text":"Use Face Mode to build a likeness chunk + ratios and paste into SDXL/Flux/MJ. For highest fidelity likeness, fine‑tune locally with your photos and include the exported landmarks/ratios as metadata."}},
      {"@type":"Question","name":"What's in the JSON?","acceptedAnswer":{"@type":"Answer","text":"Prompt chunk, 68+ pt normalized landmarks, measurement ratios (jaw/face, eye‑sep/eye‑width, nose/face), palette, alt text, and an optional embedding field."}}
    ]
  }</script>

  <style>
    :root{ --bg:#08131b; --ink:#e8f8ff; --muted:#9cc3d6; --aqua:#64f2e3; --aqua2:#23d7ba; --edge:#1b2a36; --card:#0c1922; --ok:#7ef1a6; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 10% -10%,rgba(100,242,227,.07),transparent 55%),radial-gradient(1000px 600px at 120% -10%,rgba(35,215,186,.06),transparent 55%),var(--bg);color:var(--ink);font:14px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:var(--aqua)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}

    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:900;font-size:22px;letter-spacing:.4px;color:var(--aqua)}
    .crumbs{color:var(--muted);font-size:12px}
    .tool-links{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--edge);border-radius:999px;padding:.25rem .6rem;color:var(--muted);font-size:12px}

    .hero{margin-top:12px;display:grid;gap:12px;grid-template-columns:1.1fr .9fr}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:14px;box-shadow:0 14px 40px rgba(0,0,0,.55)}
    .hero h1{margin:.2rem 0 .4rem}
    .sub{color:var(--muted);font-size:12px}

    .grid{display:grid;gap:16px}
    @media(min-width:1024px){.grid{grid-template-columns:320px 1fr}}
    h3{margin:.2rem 0 .8rem;color:var(--muted);font-size:15px}

    .steps{position:sticky;top:14px;display:flex;flex-direction:column;gap:10px}
    .step{border-left:3px solid #0f2630;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(10,26,34,.6),rgba(10,26,34,.3))}
    .step.active{border-left-color:var(--aqua)}
    .step .num{display:inline-block;width:22px;height:22px;border-radius:50%;background:#0f2a33;border:1px solid var(--edge);text-align:center;line-height:22px;margin-right:8px;color:var(--aqua)}

    .choose{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border:1.5px solid var(--aqua);border-radius:12px;background:linear-gradient(90deg,#0a2831,#0a2e2b);color:#eafffb;font-weight:800;cursor:pointer;box-shadow:0 0 0 0 rgba(100,242,227,.45);transition:box-shadow .25s}
    .choose:hover{box-shadow:0 0 0 4px rgba(100,242,227,.15),0 0 24px rgba(100,242,227,.25)}
    #file{display:none}

    .btn{background:#0e1f27;border:1px solid var(--edge);color:var(--ink);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:var(--aqua);box-shadow:0 0 0 2px rgba(100,242,227,.12) inset}

    textarea,.outbox{width:100%;min-height:120px;background:#07141c;border:1px solid #0f2833;border-radius:12px;color:var(--ink);padding:10px;box-shadow:0 0 22px rgba(100,242,227,.08)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    #previewWrap{position:relative}
    #preview{width:100%;border-radius:10px;background:#061219}
    #overlay{position:absolute;left:0;top:0;width:100%;border-radius:10px;pointer-events:none}
    .legend{position:absolute;right:10px;top:10px;background:#08141caa;border:1px solid #10313b;border-radius:10px;padding:8px 10px;font:12px/1.3 ui-monospace,monospace}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60}
    .modal.open{display:flex}
    .sheet{background:var(--card);border:1px solid var(--edge);border-radius:14px;max-width:740px;width:92%;padding:16px}

    .ad-wrap{display:block;min-height:90px;border:1px dashed var(--edge);border-radius:12px;margin:8px 0;padding:8px;text-align:center;color:var(--muted)}
    .ad-right{display:flex;gap:8px;align-items:center}

    /* J1NX float (minimal, same visual language) */
    .j1nx-float-true{position:fixed;z-index:4000;right:2vw;bottom:calc(2.8vh + 125px);display:flex;flex-direction:column;align-items:center;pointer-events:all;user-select:none;min-width:0;max-width:360px}
    .j1nx-true-cutout-img{width:220px;height:220px;object-fit:contain;border-radius:24px;background:transparent!important;margin-bottom:-20px;position:relative;z-index:9;pointer-events:auto;transition:box-shadow .2s;box-shadow:none!important}
    .j1nx-bubble-true-main{background:rgba(22,23,31,0.97);border-radius:17px;box-shadow:0 4px 22px #be9cff66,0 0 0 3px #23231f;border:2px solid var(--aqua);padding:1.1em 1.3em 1em 1.3em;margin-top:0;margin-bottom:.3em;display:flex;flex-direction:column;align-items:center;min-width:280px;max-width:330px;position:relative;z-index:1}
    .j1nx-bubble-text-true{font-size:1.02em;color:#fff;margin:.42em 0 .20em 0;text-align:center;font-weight:600;text-shadow:0 1px 11px #1e1111cc;line-height:1.22;z-index:1}
    .j1nx-bubble-row-true{width:100%;display:flex;justify-content:center;gap:7px;margin:.13em 0 .10em 0}
    .j1nx-input-true{flex:1;font-size:1em;border-radius:8px;padding:7px 12px;border:1px solid var(--aqua);background:#171b22;color:var(--aqua);min-width:0}
    .j1nx-btn-true{font-size:.98em;padding:6.5px 14px;border-radius:8px;background:#22252b;border:1.3px solid var(--aqua);color:var(--aqua);font-family:inherit;font-weight:600;cursor:pointer;transition:background .13s,color .13s,border .13s;box-shadow:0 1.5px 9px #be9cff33}
    .j1nx-btn-true:hover{background:var(--aqua);color:#171b22;border-color:#fff}
    .j1nx-easteregg-true{font-size:.91em;color:#be9cff;background:#171b22e6;border-radius:7px 13px 12px 17px;margin-top:7px;padding:7px 17px 6px 13px;opacity:.85;pointer-events:none;text-align:center;width:94%;user-select:none;box-shadow:0 3px 13px #be9cff28;font-weight:600}
    @media(max-width:900px){.j1nx-float-true{min-width:99vw;max-width:99vw;right:1vw}.j1nx-bubble-true-main{min-width:97vw;max-width:99vw}.j1nx-true-cutout-img{width:96px;height:96px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">PromptForge — Image Intelligence Portal</div>
        <div class="crumbs">Home › Tools › Image Intelligence (Client‑Side)</div>
      </div>
      <div class="tool-links">
        <a class="pill" href="/">Home</a>
        <a class="pill" href="/picture.html">Picture Builder</a>
        <a class="pill" href="/movie.html">Movie Builder</a>
        <a class="pill" href="/ansiart.html">ANSI/ASCII Studio</a>
        <a class="pill" href="/compare.html">Model Compare</a>
        <a class="pill" href="/watermark.html">Watermark</a>
        <a class="pill" href="/playground.html">Prompt Patterns</a>
        <a class="pill" href="/support.html">Support</a>
        <a class="pill" href="/legal.html">Legal</a>
      </div>
    </div>

    <section class="hero">
      <div class="card">
        <h1>Analyze → Measure → Explain → Export</h1>
        <p class="sub">Upload a photo. We run a live face mesh with creative measurements, animate a scan overlay, then generate a professional, human‑sounding description of the <em>entire image</em> (caption + objects + OCR cues). Export JSON with normalized landmarks, numeric ratios, palette, and an optional embedding stub for SDXL/Flux/MJ or LoRA/DreamBooth.</p>
      </div>
      <div class="card ad-right">
        <div style="flex:1">
          <h3>Quick links</h3>
          <p class="sub">PromptForge tools & docs.</p>
          <div class="tool-links" style="margin-top:6px">
            <a class="pill" href="/picture.html">Image Prompt Builder</a>
            <a class="pill" href="/movie.html">Video Prompt Builder</a>
            <a class="pill" href="/ansiart.html">ANSI/ASCII Studio</a>
            <a class="pill" href="/watermark.html">Watermark & Privacy</a>
            <a class="pill" href="/playground.html">Prompt Techniques</a>
          </div>
        </div>
        <!-- 108x140 Juicy unit -->
        <div style="width:108px;min-width:108px;text-align:center">
          <script type="text/javascript" data-cfasync="false" async src="https://poweredby.jads.co/js/jads.js"></script>
          <ins id="1101940" data-width="108" data-height="140"></ins>
          <script type="text/javascript" data-cfasync="false" async>(adsbyjuicy = window.adsbyjuicy || []).push({"adzone":1101940});</script>
        </div>
      </div>
    </section>

    <main class="grid" style="margin-top:14px">
      <aside class="steps">
        <div class="card step active">
          <div><span class="num">1</span><strong>Choose Image</strong></div>
          <div class="sub">Portrait or scene. Private: runs in your browser.</div>
          <label for="file" class="choose" id="chooseBtn">➕ Choose Image</label>
          <input id="file" type="file" accept="image/*" />
          <div class="ad-wrap">
            <script async src="https://poweredby.jads.co/js/jads.js"></script>
            <ins id="1101674" data-width="auto" data-height="90"></ins>
            <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101674});}catch(e){}</script>
          </div>
        </div>
        <div class="card step">
          <div><span class="num">2</span><strong>Analyze</strong></div>
          <div class="sub">Enable Full‑AI to caption objects & OCR. Face Mode for landmarks + ratios.</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button id="analyze" class="btn primary" disabled>Run (Fast)</button>
            <button id="enable-face" class="btn">Face Mode</button>
            <button id="enable-ai" class="btn">Enable Full‑AI</button>
          </div>
          <div class="sub" id="progress" style="margin-top:6px">—</div>
        </div>
        <div class="card step">
          <div><span class="num">3</span><strong>Build & Export</strong></div>
          <div class="sub">Assemble prompt and export JSON/embedding for advanced workflows.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="build" class="btn">Build Prompt</button>
            <button id="exportJSON" class="btn">Export JSON</button>
          </div>
        </div>
        <div class="card step">
          <div><span class="num">?</span><strong>Help & FAQ</strong></div>
          <div class="sub">Use prompt directly or fine‑tune locally. Privacy details inside.</div>
          <a href="#faq" class="btn">Open FAQ</a>
          <button id="toggleJ1NX" class="btn">Open J1NX</button>
        </div>
      </aside>

      <section class="card">
        <h3>Preview</h3>
        <div id="previewWrap">
          <canvas id="preview" width="900" height="560"></canvas>
          <canvas id="overlay" width="900" height="560"></canvas>
          <div class="legend" id="legend">Ratios: jaw/face, eye‑sep/eye‑width, nose/face • Units: px & norm</div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Professional Description</h3>
            <textarea id="caption" class="mono" placeholder="—"></textarea>
          </div>
          <div>
            <h3>Prompt</h3>
            <textarea id="promptOut" class="mono" placeholder="—"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px"><button id="copyPrompt" class="btn">Copy Prompt</button><button id="copyAlt" class="btn">Copy Alt‑text</button></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <h3>Objects & OCR</h3>
            <div id="objects" class="outbox mono">—</div>
            <div id="ocr" class="outbox mono" style="margin-top:8px">—</div>
          </div>
          <div>
            <h3>Palette & EXIF</h3>
            <div id="palette" class="outbox mono" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center"></div>
            <div id="exif" class="outbox mono" style="margin-top:8px">—</div>
          </div>
        </div>

        <div class="ad-wrap">
          <ins id="1101622" data-width="auto" data-height="250"></ins>
          <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101622});}catch(e){}</script>
        </div>

        <div class="card" id="faq" style="margin-top:12px">
          <h3>Help & FAQ — hidden in plain sight (read this)</h3>
          <details open>
            <summary><strong>How do I get a likeness or "me as <em>anything</em>"?</strong></summary>
            <p class="sub">Use Face Mode to generate a prompt chunk + ratios. Paste into SDXL/Flux/MJ. For highest fidelity, fine‑tune a local LoRA/DreamBooth using your photos; include exported landmarks/ratios as training metadata. You can then layer styles (e.g., cinematic ogre skin, swamp lighting) without losing identity.</p>
          </details>
          <details>
            <summary><strong>What's in the JSON export?</strong></summary>
            <p class="sub">Version, filename, image size; <code>prompt_chunk</code>; <code>palette</code>; <code>landmarks</code> (normalized); <code>measurements</code> ratios (jaw/face, eye‑sep/eye‑width, nose/face) plus px; and an <code>embedding</code> object. These are raw conditioning features for custom pipelines or training metadata.</p>
          </details>
          <details>
            <summary><strong>Privacy & security?</strong></summary>
            <p class="sub">Everything runs in your browser unless you export. Do not analyze images without permission or of minors. This portal does not identify people; it provides descriptors for creative generation only. See Legal for policy.</p>
          </details>
          <details>
            <summary><strong>Best‑results tips</strong></summary>
            <ul class="sub">
              <li>Use a sharp portrait (frontal or 3/4 view) with even light.</li>
              <li>Keep eyes visible; glasses may reduce landmark accuracy.</li>
              <li>When training a LoRA, include 10–20 varied shots and captions; add our JSON to your trainer as metadata.</li>
            </ul>
          </details>
        </div>

        <div class="ad-wrap">
          <ins id="1101675" data-width="auto" data-height="90"></ins>
          <script>try{(adsbyjuicy=window.adsbyjuicy||[]).push({adzone:1101675});}catch(e){}</script>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Consent Modal ===== -->
  <div id="consent" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <h3>Face Mapping — Consent</h3>
      <p class="sub">Analysis runs on‑device. Only export if you choose. Use with consent; do not process minors. This is <em>not</em> an identity matcher.</p>
      <label style="display:flex;align-items:center;gap:8px"><input id="agree" type="checkbox"> <span>I own/have permission to analyze this image.</span></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="deny" class="btn">Cancel</button><button id="accept" class="btn primary" disabled>Accept</button></div>
    </div>
  </div>

  <!-- ===== J1NX FLOAT (lightweight helper) ===== -->
  <div class="j1nx-float-true" id="j1nxFloatTrue" aria-label="J1nx chat" style="display:none">
    <img src="/j1nx/j1nx_cutout.png" alt="J1nx" class="j1nx-true-cutout-img" id="j1nxCutoutTrue"/>
    <div class="j1nx-bubble-true-main" id="j1nxBubbleTrueMain">
      <div class="j1nx-bubble-text-true" id="j1nxBubbleTextTrue">
        <b>J1nx:</b> Drop a photo, then hit <b>Face Mode</b> or <b>Full‑AI</b>. I’ll narrate what I see and help build your prompt.
      </div>
      <div class="j1nx-bubble-row-true">
        <input class="j1nx-input-true" id="j1nxInputTrue" placeholder="Ask J1nx…" maxlength="140" autocomplete="off"/>
        <button class="j1nx-btn-true" id="j1nxSendTrue">Send</button>
      </div>
      <div class="j1nx-bubble-row-true">
        <button class="j1nx-btn-true" id="j1nxClearTrue">Clear</button>
        <button class="j1nx-btn-true" id="j1nxSaveTrue">Save Chat</button>
      </div>
      <div class="j1nx-easteregg-true" id="j1nxEasterEggTrue">Double‑tap the bubble or type <b>unlock</b> …</div>
    </div>
  </div>

  <!-- ===== Dependencies (loaded on demand) & App Code ===== -->
  <script>
  // --- Utility: script/style lazy loader
  const Loader = {
    loaded: new Set(),
    js(src){ return new Promise((res,rej)=>{ if(Loader.loaded.has(src)) return res(); const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>{Loader.loaded.add(src); res();}; s.onerror=()=>rej(new Error('Failed '+src)); document.head.appendChild(s); }); },
  };

  // --- DOM refs
  const els = {
    file: document.getElementById('file'), chooseBtn: document.getElementById('chooseBtn'),
    preview: document.getElementById('preview'), overlay: document.getElementById('overlay'), legend: document.getElementById('legend'),
    analyze: document.getElementById('analyze'), enableFace: document.getElementById('enable-face'), enableAI: document.getElementById('enable-ai'),
    progress: document.getElementById('progress'),
    caption: document.getElementById('caption'), promptOut: document.getElementById('promptOut'),
    objects: document.getElementById('objects'), ocr: document.getElementById('ocr'),
    palette: document.getElementById('palette'), exif: document.getElementById('exif'),
    build: document.getElementById('build'), exportJSON: document.getElementById('exportJSON'),
    copyPrompt: document.getElementById('copyPrompt'), copyAlt: document.getElementById('copyAlt'),
    consent: document.getElementById('consent'), agree: document.getElementById('agree'), accept: document.getElementById('accept'), deny: document.getElementById('deny'),
    jOpen: document.getElementById('toggleJ1NX'), jWrap: document.getElementById('j1nxFloatTrue'), jBubble: document.getElementById('j1nxBubbleTextTrue'), jInput: document.getElementById('j1nxInputTrue'), jSend: document.getElementById('j1nxSendTrue'), jClear: document.getElementById('j1nxClearTrue'), jSave: document.getElementById('j1nxSaveTrue'), jEgg: document.getElementById('j1nxEasterEggTrue')
  };

  // --- State
  const state = {
    imgEl: null, imgName: '', imgW: 0, imgH: 0,
    faceEnabled: false, fullAIEnabled: false, consentOK: false,
    face: { landmarks: [], ratios: {}, boxes: [] },
    det: { objects: [], ocr: '', exif: {}, palette: [] },
    timers: { scan: null },
  };

  const ctx = els.preview.getContext('2d');
  const octx = els.overlay.getContext('2d');

  function fitDrawImage(img){
    const cw = els.preview.width, ch = els.preview.height;
    octx.clearRect(0,0,els.overlay.width, els.overlay.height);
    ctx.clearRect(0,0,cw,ch);
    const ar = img.width / img.height; const car = cw / ch;
    let dw, dh, dx, dy; if(ar > car){ dw = cw; dh = cw / ar; dx = 0; dy = (ch - dh)/2; } else { dh = ch; dw = ch * ar; dy = 0; dx = (cw - dw)/2; }
    ctx.drawImage(img, dx, dy, dw, dh);
    state.imgW = img.width; state.imgH = img.height;
  }

  function note(msg){ els.progress.textContent = msg; }

  // --- Scan overlay animation
  function startScan(){ stopScan(); let y=0; state.timers.scan = setInterval(()=>{ octx.clearRect(0,0,els.overlay.width, els.overlay.height); octx.fillStyle = 'rgba(35,215,186,0.12)'; octx.fillRect(0,y,els.overlay.width, 8); y = (y + 3) % els.overlay.height; }, 16); }
  function stopScan(){ if(state.timers.scan){ clearInterval(state.timers.scan); state.timers.scan = null; octx.clearRect(0,0,els.overlay.width, els.overlay.height);} }

  // --- Color utils
  const toHex = (r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');

  // --- File load
  els.chooseBtn.addEventListener('click', ()=> els.file.click());
  els.file.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    state.imgName = f.name || 'image';
    const url = URL.createObjectURL(f);
    const img = new Image(); img.onload = ()=>{ state.imgEl = img; fitDrawImage(img); els.analyze.disabled = false; note('Ready. Choose a mode then Run.'); URL.revokeObjectURL(url);}; img.src = url;
    // parse EXIF lazily
    try {
      await Loader.js('https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.min.js');
      const ab = await f.arrayBuffer();
      const tags = window['ExifReader'] ? ExifReader.load(ab) : {};
      state.det.exif = tags || {};
      const out = [];
      ['Make','Model','LensModel','FNumber','ExposureTime','ISOSpeedRatings','DateTimeOriginal'].forEach(k=>{ if(tags[k]) out.push(`${k}: ${tags[k].description || tags[k].value}`); });
      els.exif.textContent = out.join('\n') || '—';
    } catch(err){ els.exif.textContent = '—'; }
  });

  // --- Face Mode (MediaPipe FaceMesh)
  async function ensureFace(){
    if(!state.consentOK){ els.consent.classList.add('open'); return false; }
    if(!window.FaceMesh){
      note('Loading face mesh…');
      await Loader.js('https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js');
      await Loader.js('https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js');
    }
    if(!window._pfFace){
      const fm = new FaceMesh({locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`});
      fm.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
      fm.onResults(onFaceResults);
      window._pfFace = fm;
    }
    return true;
  }

  function normPoint(pt){ return [ +(pt.x).toFixed(5), +(pt.y).toFixed(5), +(pt.z||0).toFixed(5) ]; }
  function ratio(a,b){ return b? +(a/b).toFixed(4) : 0; }

  async function runFace(){
    if(!state.imgEl) return; if(!(await ensureFace())) return;
    startScan();
    const tmp = document.createElement('canvas'); tmp.width = state.imgEl.width; tmp.height = state.imgEl.height; tmp.getContext('2d').drawImage(state.imgEl,0,0);
    await window._pfFace.send({image: tmp});
    stopScan();
  }

  function onFaceResults(res){
    octx.clearRect(0,0,els.overlay.width, els.overlay.height);
    if(!res.multiFaceLandmarks || !res.multiFaceLandmarks.length){ note('No face found.'); state.face.landmarks=[]; state.face.ratios={}; return; }
    const lm = res.multiFaceLandmarks[0];
    // draw mesh (project to overlay canvas size)
    const w = els.overlay.width, h = els.overlay.height;
    octx.strokeStyle = 'rgba(100,242,227,.85)'; octx.lineWidth = 1.2; octx.beginPath();
    lm.forEach(p=>{ const x = p.x * w, y = p.y * h; octx.lineTo(x,y); }); octx.stroke();
    // compute simple measurements using common landmark indices
    const L = lm; // Mediapipe indices: approximate
    const idx = {
      chin: 152, top: 10, leftJaw: 234, rightJaw: 454,
      leftEyeIn: 133, rightEyeIn: 362, leftEyeOut: 33, rightEyeOut: 263,
      noseTip: 1
    };
    function dist(a,b){ const dx=L[a].x-L[b].x, dy=L[a].y-L[b].y; return Math.hypot(dx,dy); }
    const faceH = dist(idx.top, idx.chin);
    const jawW = dist(idx.leftJaw, idx.rightJaw);
    const eyeSep = dist(idx.leftEyeIn, idx.rightEyeIn);
    const eyeW = (dist(idx.leftEyeIn, idx.leftEyeOut)+dist(idx.rightEyeIn, idx.rightEyeOut))/2;
    const noseH = dist(idx.top, idx.noseTip);
    state.face.landmarks = lm.map(normPoint);
    state.face.ratios = {
      jaw_to_face: ratio(jawW, faceH),
      eyeSep_to_eyeW: ratio(eyeSep, eyeW),
      nose_to_face: ratio(noseH, faceH)
    };
    els.legend.textContent = `Ratios • jaw/face ${state.face.ratios.jaw_to_face}  • eye‑sep/eye‑width ${state.face.ratios.eyeSep_to_eyeW}  • nose/face ${state.face.ratios.nose_to_face}`;
    note('Face mesh complete.');
  }

  // --- Full‑AI (COCO‑SSD + Tesseract)
  async function ensureFullAI(){
    if(window._pfDetLoaded) return true;
    note('Loading detectors…');
    await Loader.js('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js');
    await Loader.js('https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2');
    await Loader.js('https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js');
    window._pfDetLoaded = true;
    return true;
  }

  async function runObjects(){
    if(!state.imgEl) return [];
    await ensureFullAI();
    const model = await cocoSsd.load({base:'lite_mobilenet_v2'});
    const preds = await model.detect(els.preview);
    return preds.map(p=>({label:p.class, score:+p.score.toFixed(3), box:p.bbox}));
  }

  async function runOCR(){
    if(!state.imgEl) return '';
    await ensureFullAI();
    const r = await Tesseract.recognize(els.preview, 'eng', { logger: m=>{ /* console.log(m); */ } });
    return (r && r.data && r.data.text ? r.data.text.trim() : '') || '';
  }

  // --- Palette (ColorThief)
  async function buildPalette(){
    if(!window.ColorThief) await Loader.js('https://cdn.jsdelivr.net/npm/color-thief-browser@2.0.2/dist/color-thief.umd.js');
    try{
      const thief = new ColorThief();
      const tmp = document.createElement('canvas'); tmp.width = state.imgEl.width; tmp.height = state.imgEl.height; tmp.getContext('2d').drawImage(state.imgEl,0,0);
      const img2 = new Image(); img2.src = tmp.toDataURL('image/jpeg'); await img2.decode();
      const palette = thief.getPalette(img2, 6);
      state.det.palette = palette.map(([r,g,b])=>toHex(r,g,b));
      els.palette.innerHTML = state.det.palette.map(hex=>`<span style="display:inline-flex;align-items:center;gap:6px;border:1px solid #123;padding:6px 8px;border-radius:8px"><i style="width:18px;height:18px;border-radius:4px;background:${hex};display:inline-block"></i><code>${hex}</code></span>`).join(' ');
    }catch(e){ els.palette.textContent = '—'; }
  }

  // --- Heuristic caption (when Full‑AI off or as base)
  function heuristicCaption(){
    const colors = state.det.palette && state.det.palette.slice(0,3).join(', ');
    const objects = (state.det.objects||[]).slice(0,4).map(o=>o.label).join(', ');
    const bits = [];
    if(objects) bits.push(objects);
    if(colors) bits.push(`tones of ${colors}`);
    const cap = `A well‑lit photo featuring ${bits.join(' with ')}.`;
    els.caption.value = cap;
    return cap;
  }

  // --- Build prompt text
  function buildPrompt(){
    const tags = (state.det.objects||[]).filter(o=>o.score>0.4).map(o=>o.label);
    const ratios = state.face.ratios || {};
    const palette = (state.det.palette||[]).slice(0,3).join(', ');
    const cap = els.caption.value.trim() || heuristicCaption();
    const chunk = [];
    if(ratios.jaw_to_face) chunk.push(`jaw/face ${ratios.jaw_to_face}`);
    if(ratios.eyeSep_to_eyeW) chunk.push(`eye‑sep/eye‑width ${ratios.eyeSep_to_eyeW}`);
    if(ratios.nose_to_face) chunk.push(`nose/face ${ratios.nose_to_face}`);
    const prompt = [
      cap,
      tags.length?`objects: ${tags.join(', ')}`: '',
      palette?`palette: ${palette}`:'',
      chunk.length?`face‑ratios: ${chunk.join(' • ')}`:''
    ].filter(Boolean).join(' \n ');
    els.promptOut.value = prompt;
    return prompt;
  }

  // --- Export JSON
  function exportJSON(){
    const data = {
      version: 'pf_imageintel_1',
      filename: state.imgName,
      image: { width: state.imgW, height: state.imgH },
      prompt_chunk: els.promptOut.value,
      caption: els.caption.value,
      palette: state.det.palette,
      landmarks: state.face.landmarks, // normalized [x,y,z]
      measurements: state.face.ratios,
      objects: state.det.objects,
      ocr: state.det.ocr,
      exif: state.det.exif ? Object.fromEntries(Object.entries(state.det.exif).slice(0,40).map(([k,v])=>[k, v && (v.description||v.value||'')])) : {},
      embedding: { type:'stub', dims:0 }
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (state.imgName||'image')+ '.pf_imageintel.json'; a.click(); URL.revokeObjectURL(a.href);
  }

  // --- Wire buttons
  els.enableFace.addEventListener('click', async()=>{ state.faceEnabled = !state.faceEnabled; els.enableFace.classList.toggle('primary', state.faceEnabled); if(state.faceEnabled && state.imgEl) runFace(); note(state.faceEnabled? 'Face Mode enabled.' : 'Face Mode disabled.'); });
  els.enableAI.addEventListener('click', async()=>{ state.fullAIEnabled = !state.fullAIEnabled; els.enableAI.classList.toggle('primary', state.fullAIEnabled); if(state.fullAIEnabled){ await ensureFullAI(); note('Full‑AI ready. Click Run.'); } else { note('Full‑AI disabled.'); } });

  els.analyze.addEventListener('click', async()=>{
    if(!state.imgEl){ note('Choose an image first.'); return; }
    startScan();
    // Palette first (fast)
    try{ await buildPalette(); }catch(e){}
    // Face if toggled
    if(state.faceEnabled){ await runFace(); }
    // Detectors if toggled
    if(state.fullAIEnabled){
      try{ state.det.objects = await runObjects(); }catch(e){ state.det.objects = []; }
      try{ state.det.ocr = await runOCR(); }catch(e){ state.det.ocr = ''; }
      els.objects.textContent = (state.det.objects||[]).map(o=>`${o.label} (${o.score})`).join(', ') || '—';
      els.ocr.textContent = state.det.ocr || '—';
    }
    // caption / prompt
    if(!els.caption.value) heuristicCaption();
    buildPrompt();
    stopScan(); note('Done. Build or Export next.');
  });

  els.build.addEventListener('click', ()=>{ buildPrompt(); note('Prompt refreshed.'); });
  els.exportJSON.addEventListener('click', ()=>{ exportJSON(); });
  els.copyPrompt.addEventListener('click', ()=>{ navigator.clipboard.writeText(els.promptOut.value||''); note('Prompt copied.'); });
  els.copyAlt.addEventListener('click', ()=>{ navigator.clipboard.writeText(els.caption.value||''); note('Alt‑text copied.'); });

  // Consent modal
  els.agree.addEventListener('change', ()=>{ els.accept.disabled = !els.agree.checked; });
  els.accept.addEventListener('click', ()=>{ state.consentOK = true; els.consent.classList.remove('open'); if(state.faceEnabled) runFace(); });
  els.deny.addEventListener('click', ()=>{ els.consent.classList.remove('open'); state.faceEnabled=false; els.enableFace.classList.remove('primary'); });

  // J1NX micro‑wiring
  els.jOpen.addEventListener('click', ()=>{ els.jWrap.style.display = els.jWrap.style.display==='none' ? 'flex' : 'none'; });
  const say = (t)=>{ els.jBubble.innerHTML += '<br/>' + (t||'').replace(/</g,'&lt;'); els.jBubble.scrollTop = els.jBubble.scrollHeight; };
  els.jSend?.addEventListener('click', ()=>{ const v = els.jInput.value.trim(); if(!v) return; say('<b>You:</b> '+v); els.jInput.value=''; });
  els.jClear?.addEventListener('click', ()=>{ els.jBubble.innerHTML = '<b>J1nx:</b> Reset. What\'s next?'; });
  els.jSave?.addEventListener('click', ()=>{ const blob = new Blob([els.jBubble.textContent||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='j1nx_chat.txt'; a.click(); URL.revokeObjectURL(a.href); });
  (function(){ let taps=0, tid; els.jWrap?.addEventListener('click', ()=>{ clearTimeout(tid); taps++; tid=setTimeout(()=>{ if(taps>=2){ els.jEgg.textContent='NSFW hint unlocked (demo): try the labs when available.'; els.jEgg.style.opacity=1; } taps=0; }, 240); }, {passive:true}); })();
  </script>
</body>
</html>
