<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ImageIntel Pro — Online Tasks Demo (v12.2)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="preconnect" href="https://storage.googleapis.com"/>
<meta name="theme-color" content="#0c1016"/>
<style>
  :root{ --bg:#0c1016;--panel:#101723;--ink:#e9f3ff;--dim:#9ab3c7;--edge:#1a2331;--hot:#ff6ea8;--aqua:#67f0e1;--vio:#a98eff;--gold:#ffd166;--ok:#3ddc97;--warn:#ffbe0b;--bad:#ff3b30; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  h1,h2,h3{margin:0 0 .5rem 0;font-weight:700}
  a{color:var(--aqua)}
  .bar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0c1016 0%,rgba(12,16,22,.85) 100%);backdrop-filter:saturate(1.3) blur(8px);border-bottom:1px solid #152131}
  .bar-inner{max-width:1400px;margin:0 auto;padding:.75rem 1rem;display:flex;gap:.75rem;align-items:center}
  .badge{font-size:.75rem;border:1px solid var(--vio);color:var(--vio);padding:.15rem .45rem;border-radius:.5rem}
  .wrap{max-width:1400px;margin:0 auto;padding:1rem}
  .row{display:grid;gap:12px}
  @media(min-width:1200px){.row{grid-template-columns:repeat(4,1fr)}}
  @media(min-width:740px) and (max-width:1199px){.row{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:739px){.row{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;overflow:hidden;position:relative}
  .card > header{display:flex;align-items:center;gap:.5rem;padding:.6rem .75rem;border-bottom:1px solid var(--edge);background:linear-gradient(180deg,#121a28,rgba(18,26,40,.4));}
  .card h3{font-size:.9rem;letter-spacing:.2px}
  .stage{position:relative;aspect-ratio:1/1;background:#0b1522;display:flex;align-items:center;justify-content:center}
  .stage img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
  .canvas{position:absolute;inset:0}
  .controls{display:flex;flex-wrap:wrap;gap:.5rem}
  .btn{background:#162233;border:1px solid #233146;color:#cfe7ff;border-radius:10px;padding:.55rem .8rem;font-weight:600;cursor:pointer}
  .btn.hot{border-color:var(--hot);color:#fff;background:linear-gradient(180deg,#2b1421,#1a0f16)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .segLegend{position:absolute;right:8px;bottom:8px;font-size:.72rem;background:#0c1016cc;padding:.3rem .5rem;border:1px solid #2a3a4f;border-radius:.5rem}
  .tabs{display:flex;gap:2px;margin-top:10px}
  .tab{flex:1;background:#0e1622;border:1px solid #24334a;padding:.6rem .8rem;border-radius:10px 10px 0 0;text-align:center;color:#b7d0ea;font-weight:700;cursor:pointer}
  .tab.active{background:#122033;border-bottom-color:transparent;color:#fff}
  .panel{border:1px solid #24334a;border-top:none;background:#0e1622;border-radius:0 10px 10px 10px;padding:.6rem}
  textarea,pre{width:100%;min-height:140px;background:#0a1220;border:1px solid #1f2a3d;border-radius:10px;color:#cfe7ff;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;padding:.8rem;line-height:1.4}
  .grid2{display:grid;gap:10px}
  @media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}
  .range{display:flex;gap:.6rem;align-items:center}
  .range input{flex:1}
  .pill{padding:.2rem .5rem;border-radius:999px;border:1px solid #2b3a4f;background:#0f1727;font-size:.72rem}
  .diag{font-size:.88rem;color:#bcd}
  .copy{position:absolute;right:.6rem;top:.6rem;z-index:4}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111c2d;color:#fff;border:1px solid #27405a;padding:.6rem 1rem;border-radius:999px;font-weight:700;box-shadow:0 8px 18px rgba(0,0,0,.35);opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translate(-50%,-6px)}
</style>
</head>
<body>
  <div class="bar">
    <div class="bar-inner">
      <h1 style="font-size:1rem;letter-spacing:.5px">ImageIntel Pro <span class="badge">v12.2 Online Beta</span></h1>
      <div style="margin-left:auto;display:flex;gap:.5rem">
        <button id="btnInstall" class="btn" disabled>Install (PWA)</button>
        <button id="btnSelfTest" class="btn">Self‑Test</button>
        <button id="btnAnalyze" class="btn hot">Analyze Image</button>
        <button id="btnClear" class="btn">Clear</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" style="margin-bottom:12px">
      <header>
        <h3>Step 1 · Load image</h3>
      </header>
      <div class="grid2" style="padding:10px">
        <div class="controls">
          <input type="file" id="file" accept="image/*;capture=camera" class="btn" />
          <button id="btnDemo" class="btn">Use Demo Photo</button>
          <input id="urlIn" placeholder="Paste image URL" class="btn" style="min-width:280px" />
          <button id="btnLoadUrl" class="btn">Load URL</button>
          <span class="pill" id="imgInfo">No image</span>
        </div>
        <div class="controls">
          <label class="range">Detail <input type="range" id="detail" min="0" max="1" step="0.01" value="0.7"/><span class="pill" id="detailVal">0.70</span></label>
          <label class="range">Accuracy <input type="range" id="accuracy" min="0" max="1" step="0.01" value="0.75"/><span class="pill" id="accVal">0.75</span></label>
          <label style="display:flex;gap:10px;align-items:center">
            <input type="checkbox" id="cbFace" checked/> Face
            <input type="checkbox" id="cbPose" checked/> Pose
            <input type="checkbox" id="cbSeg" checked/> Segments
            <input type="checkbox" id="cbObj" checked/> Objects
          </label>
        </div>
      </div>
    </div>

    <div class="row" id="stages">
      <section class="card">
        <header><h3>Face (468) — neon mesh</h3><button class="btn copy" data-copy="face">Copy PNG</button></header>
        <div class="stage" id="stageFace" data-drop>
          <div class="pill" style="position:absolute;inset:auto auto 8px 8px;opacity:.8">Drop image here</div>
          <img id="imgFace" alt=""/>
          <canvas class="canvas" id="cvFace" aria-label="face overlay"></canvas>
        </div>
      </section>
      <section class="card">
        <header><h3>Pose (33) — skeleton + labels</h3><button class="btn copy" data-copy="pose">Copy PNG</button></header>
        <div class="stage" id="stagePose" data-drop>
          <img id="imgPose" alt=""/>
          <canvas class="canvas" id="cvPose" aria-label="pose overlay"></canvas>
        </div>
      </section>
      <section class="card">
        <header><h3>Segments — person mask + scanlines</h3><button class="btn copy" data-copy="seg">Copy PNG</button></header>
        <div class="stage" id="stageSeg" data-drop>
          <img id="imgSeg" alt=""/>
          <canvas class="canvas" id="cvSeg" aria-label="segmentation overlay"></canvas>
          <div class="segLegend" id="segLegend">—</div>
        </div>
      </section>
      <section class="card">
        <header><h3>Objects — boxes + scores</h3><button class="btn copy" data-copy="obj">Copy PNG</button></header>
        <div class="stage" id="stageObj" data-drop>
          <img id="imgObj" alt=""/>
          <canvas class="canvas" id="cvObj" aria-label="object overlay"></canvas>
        </div>
      </section>
    </div>

    <div class="card" style="margin-top:12px">
      <header><h3>Step 2 · Outputs</h3></header>
      <div class="tabs">
        <div class="tab active" data-tab="prompt">SFW Prompt</div>
        <div class="tab" data-tab="json">JSON</div>
        <div class="tab" data-tab="diag">Diagnostics</div>
      </div>
      <div class="panel">
        <div id="panel-prompt">
          <div class="controls" style="justify-content:flex-end;margin-bottom:6px">
            <button class="btn" id="btnCopyPrompt">Copy Prompt</button>
            <button class="btn" id="btnCopyNeg">Copy Negative</button>
          </div>
          <textarea id="outPrompt"></textarea>
        </div>
        <div id="panel-json" hidden>
          <div class="controls" style="justify-content:flex-end;margin-bottom:6px"><button class="btn" id="btnCopyJSON">Copy JSON</button></div>
          <pre id="outJSON" class="diag"></pre>
        </div>
        <div id="panel-diag" hidden>
          <div class="controls" style="justify-content:flex-end;margin-bottom:6px"><button class="btn" id="btnCopyDiag">Copy Diag</button></div>
          <pre id="outDiag" class="diag"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied</div>

  <!-- MediaPipe Tasks (online) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.js"></script>
  <script>
  // ======= PWA (manifest + SW guarded) =======
  (function(){
    let deferred; const installBtn=document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferred=e; installBtn.disabled=false;});
    installBtn.onclick=()=> deferred && deferred.prompt();

    // Manifest (ok to use blob for manifest)
    const manifest={ name:"ImageIntel Pro", short_name:"ImageIntel", display:"standalone", background_color:"#0c1016", theme_color:"#0c1016", icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='18' fill='%230c1016'/><path d='M20 70 L45 30 L60 55 L70 45 L80 60' stroke='%2367f0e1' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>", sizes:"100x100", type:"image/svg+xml"}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'}); const url=URL.createObjectURL(blob); const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);

    // Service worker — ONLY register from http/https (or localhost) AND only from a real file path
    const SW_PATH='service-worker.js';
    async function tryRegisterSW(){
      if(!('serviceWorker' in navigator)) return diagAdd('SW: not supported in this browser');
      const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
      if(!secure){ diagAdd('SW: skipped (insecure origin '+location.protocol+')'); return; }
      try{
        const head = await fetch(SW_PATH,{method:'HEAD'}); // requires that you deploy a real file at this path
        if(!head.ok){ diagAdd('SW: skipped (missing \''+SW_PATH+'\' on server)'); return; }
        await navigator.serviceWorker.register(SW_PATH);
        diagAdd('SW: registered from '+SW_PATH);
      }catch(err){ diagAdd('SW: failed '+(err&&err.message?err.message:err)); }
    }
    // Defer SW registration to idle so it never blocks
    if(document.readyState==='complete') setTimeout(tryRegisterSW,0); else window.addEventListener('load',()=>{ els('.canvas').forEach(setupDprCanvas); diagAdd('UI ready'); });

  // Drag & Drop support on any stage
  els('[data-drop]').forEach(stage=>{
    stage.addEventListener('dragover',e=>{e.preventDefault(); stage.style.outline='2px dashed #67f0e1';});
    stage.addEventListener('dragleave',()=>{stage.style.outline='';});
    stage.addEventListener('drop',e=>{ e.preventDefault(); stage.style.outline=''; const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{fitImageToAllStages(img); imgInfo.textContent=`${f.name} — ${img.naturalWidth}×${img.naturalHeight}`; toast('Image loaded');}; img.src=url; });
  });
  })();

  // ======= Helpers =======
  const el = s=>document.querySelector(s); const els = s=>[...document.querySelectorAll(s)];
  const toast=msg=>{const t=el('#toast'); t.textContent=msg||'Copied'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200)}
  const copyText=t=>{navigator.clipboard.writeText(t||''); toast('Copied');}
  function fitImageToAllStages(img){ ['Face','Pose','Seg','Obj'].forEach(k=>{const tag=document.getElementById('img'+k); tag.src = img.src; tag.style.objectFit='contain';}); }
  function setupDprCanvas(canvas){ const parent=canvas.parentElement; const dpr=window.devicePixelRatio||1; const {width,height}=parent.getBoundingClientRect(); canvas.width=Math.max(1,Math.floor(width*dpr)); canvas.height=Math.max(1,Math.floor(height*dpr)); const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); return ctx; }
  window.addEventListener('resize',()=>{ ['cvFace','cvPose','cvSeg','cvObj'].forEach(id=>{const c=document.getElementById(id); if(!c) return; setupDprCanvas(c); }); if(window.__lastDetections) drawAll(window.__lastDetections,true); });

  // ======= Tab logic =======
  els('.tab').forEach(t=>t.onclick=()=>{ els('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); els('[id^=panel-]').forEach(p=>p.hidden=true); el('#panel-'+t.dataset.tab).hidden=false; });

  // ======= Inputs =======
  const imgInfo=el('#imgInfo');
  el('#detail').oninput=e=> el('#detailVal').textContent=parseFloat(e.target.value).toFixed(2);
  el('#accuracy').oninput=e=> el('#accVal').textContent=parseFloat(e.target.value).toFixed(2);
  el('#file').onchange=async e=>{const f=e.target.files&&e.target.files[0]; if(!f){ toast('No file'); return; }
    const url=URL.createObjectURL(f); const img=new Image();
    img.onload=()=>{fitImageToAllStages(img); imgInfo.textContent=`${f.name} — ${img.naturalWidth}×${img.naturalHeight}`; toast('Image loaded'); };
    img.onerror=()=>{ toast('File could not load'); diagAdd('File load error for '+(f&&f.name)); };
    img.src=url; };
    img.onload=()=>{fitImageToAllStages(img); imgInfo.textContent=`${new URL(u).hostname} — ${img.naturalWidth}×${img.naturalHeight}`; toast('Image loaded'); };
    img.onerror=()=>{ toast('Image load failed (CORS or URL)'); diagAdd('Image load failed for '+u); };
    img.src=u;
  }
  el('#btnLoadUrl').onclick=()=> loadFromUrl(el('#urlIn').value);
  el('#urlIn').addEventListener('keydown',e=>{ if(e.key==='Enter') loadFromUrl(e.target.value); });
  el('#btnDemo').onclick=()=>{ const url='https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?q=80&w=1200&auto=format&fit=crop'; const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{fitImageToAllStages(img); imgInfo.textContent=`Demo — ${img.naturalWidth}×${img.naturalHeight}`}; img.src=url; };

  // ======= Diagnostics helpers =======
  function diagAdd(msg){ const box=el('#outDiag'); box.textContent += (box.textContent?"\n":"") + msg; }

  // ======= MediaPipe Tasks setup (ONLINE) =======
  const visionNS = window.vision || {};
  const { FaceLandmarker, PoseLandmarker, ImageSegmenter, ObjectDetector, FilesetResolver } = visionNS;
  let faceTask, poseTask, segTask, objTask, fileset;

  async function ensureTasks(){
    if(fileset) return; if(!FilesetResolver){ diagAdd('Vision bundle not ready'); throw new Error('vision bundle missing'); }
    fileset = await FilesetResolver.forVisionTasks({ baseUrl: 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm' });
    diagAdd('FilesetResolver online');
  }
  async function loadEngines(){
    await ensureTasks(); const runningMode='IMAGE';
    faceTask = await FaceLandmarker.createFromOptions(fileset,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task' }, runningMode, numFaces:1, outputFaceBlendshapes:true, outputFacialTransformationMatrixes:true});
    poseTask = await PoseLandmarker.createFromOptions(fileset,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/2/pose_landmarker_full.task' }, runningMode, numPoses:1});
    segTask  = await ImageSegmenter.createFromOptions(fileset,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_multiclass_256/float32/1/selfie_multiclass_256.tflite' }, runningMode, outputCategoryMask:true});
    objTask  = await ObjectDetector.createFromOptions(fileset,{ baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float32/1/efficientdet_lite0.tflite'}, runningMode, scoreThreshold:0.4, maxResults:8 });
    diagAdd('Tasks ready (face/pose/seg/obj)');
  }

  // ======= Draw utils =======
  function circle(ctx,x,y,r,stroke,fill){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); if(fill){ctx.fillStyle=fill; ctx.fill()} ctx.lineWidth=2; ctx.strokeStyle=stroke; ctx.stroke(); }
  function line(ctx,a,b,stroke, width){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.strokeStyle=stroke; ctx.lineWidth=width||2; ctx.stroke(); }
  function text(ctx,str,x,y,color){ ctx.fillStyle=color; ctx.font='600 12px ui-monospace,monospace'; ctx.fillText(str,x+4,y-4); }
  function drawFace(cv, detections){ const ctx=setupDprCanvas(cv); ctx.clearRect(0,0,cv.width,cv.height); if(!detections || !detections.faceLandmarks?.length) return; const lm=detections.faceLandmarks[0];
    ctx.save(); ctx.lineJoin='round'; ctx.lineCap='round';
    const idx=[[10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109,10]];
    ctx.shadowColor='rgba(103,240,225,.7)'; ctx.shadowBlur=8; ctx.strokeStyle='#67f0e1'; ctx.lineWidth=2;
    idx.forEach(arr=>{ ctx.beginPath(); arr.forEach((i,j)=>{ const p=lm[i]; if(j===0) ctx.moveTo(p.x*cv.clientWidth, p.y*cv.clientHeight); else ctx.lineTo(p.x*cv.clientWidth, p.y*cv.clientHeight);}); ctx.stroke();});
    ctx.shadowBlur=18; ctx.fillStyle='rgba(169,142,255,.9)';
    for(let i=0;i<lm.length;i+=3){ const p=lm[i]; circle(ctx,p.x*cv.clientWidth,p.y*cv.clientHeight,1.8,'rgba(255,110,168,.8)','rgba(169,142,255,.9)'); }
    ctx.restore();
  }
  function drawPose(cv, detections){ const ctx=setupDprCanvas(cv); ctx.clearRect(0,0,cv.width,cv.height); if(!detections?.poseLandmarks?.length) return; const lm=detections.poseLandmarks[0]; const J=(i)=>({x:lm[i].x*cv.clientWidth,y:lm[i].y*cv.clientHeight});
    const bones=[[11,12],[11,13],[13,15],[12,14],[14,16],[11,12],[11,23],[12,24],[23,24],[23,25],[24,26],[25,27],[26,28]];
    ctx.lineCap='round'; ctx.lineJoin='round'; bones.forEach(([a,b])=> line(ctx,J(a),J(b),'#67f0e1',3));
    [11,12,13,14,15,16,23,24,25,26,27,28].forEach(i=>{ const p=J(i); circle(ctx,p.x,p.y,3,'#ff6ea8','#a98eff'); });
    const labels={11:'L-Shoulder',12:'R-Shoulder',23:'L-Hip',24:'R-Hip'}; Object.entries(labels).forEach(([i,name])=>{const p=J(+i); text(ctx,name,p.x,p.y,'#cfe7ff')});
  }
  function drawSeg(cv, seg){ const ctx=setupDprCanvas(cv); ctx.clearRect(0,0,cv.width,cv.height); if(!seg?.categoryMask) return; const {width,height} = seg.categoryMask; const mask=seg.categoryMask.getAsUint8Array(); const imgData=ctx.createImageData(width,height); for(let i=0;i<mask.length;i++){ const m=mask[i]; const o=i*4; if(m===1){ imgData.data[o]=103; imgData.data[o+1]=240; imgData.data[o+2]=225; imgData.data[o+3]=70; } else { imgData.data[o+3]=0; } } const tmp=document.createElement('canvas'); tmp.width=width; tmp.height=height; tmp.getContext('2d').putImageData(imgData,0,0); ctx.save(); ctx.imageSmoothingEnabled=true; ctx.globalCompositeOperation='lighter'; ctx.drawImage(tmp,0,0,cv.clientWidth,cv.clientHeight); ctx.restore(); ctx.strokeStyle='rgba(255,110,168,.6)'; ctx.setLineDash([8,6]); const y1=cv.clientHeight*.35, y2=cv.clientHeight*.55, y3=cv.clientHeight*.75; [y1,y2,y3].forEach((y,i)=>{ ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(cv.clientWidth-12,y); ctx.stroke(); text(ctx,['bust','waist','hips'][i],14,y,'#ffbed8'); }); el('#segLegend').textContent='person mask + bust/waist/hips scanlines'; }
  function drawObj(cv, detections){ const ctx=setupDprCanvas(cv); ctx.clearRect(0,0,cv.width,cv.height); if(!detections?.detections?.length) return; ctx.setLineDash([8,4]); ctx.lineWidth=2; detections.detections.forEach(d=>{ const [x,y,w,h]=[d.boundingBox.originX*cv.clientWidth, d.boundingBox.originY*cv.clientHeight, d.boundingBox.width*cv.clientWidth, d.boundingBox.height*cv.clientHeight]; ctx.strokeStyle='#ff6ea8'; ctx.strokeRect(x,y,w,h); const lab=`${d.categories[0].categoryName} ${(d.categories[0].score*100|0)}%`; ctx.fillStyle='#0c1016'; ctx.strokeStyle='#a98eff'; ctx.setLineDash([]); const tw=ctx.measureText(lab).width+10; ctx.fillRect(x,y-18, tw, 18); ctx.strokeRect(x,y-18, tw, 18); ctx.fillStyle='#fff'; ctx.fillText(lab,x+5,y-5); ctx.setLineDash([8,4]); }); }

  function drawAll(all, fromResize){ window.__lastDetections = all; if(el('#cbFace').checked) drawFace(el('#cvFace'), all); if(el('#cbPose').checked) drawPose(el('#cvPose'), all); if(el('#cbSeg').checked) drawSeg(el('#cvSeg'), all.seg); if(el('#cbObj').checked) drawObj(el('#cvObj'), all.obj); if(!fromResize) phasedPulse(); }
  function phasedPulse(){ const cards = els('.row .card'); const colors=['#67f0e1','#a98eff','#ff6ea8','#ffd166']; cards.forEach((c,i)=>{ c.style.boxShadow='none'; setTimeout(()=>{c.style.boxShadow=`0 0 0 2px ${colors[i]} inset, 0 12px 28px rgba(0,0,0,.35)`; setTimeout(()=>c.style.boxShadow='none',320);}, i*260); }); }

  // ======= Measurement / Prompt =======
  function computeStats(all){ const stats={}; if(all?.faceLandmarks?.[0]){ const lm=all.faceLandmarks[0]; const L=lm[33], R=lm[263]; const rad=Math.atan2((R.y-L.y),(R.x-L.x)); let deg=(rad*180/Math.PI); if(deg<0) deg+=180; stats.eye_tilt_deg=+(deg.toFixed(1)); const top=lm[10], bottom=lm[152], left=lm[234], right=lm[454]; const w=Math.hypot(right.x-left.x,right.y-left.y); const h=Math.hypot(bottom.x-top.x,bottom.y-top.y); const r=h/(w+1e-6); stats.face_shape=r>1.25?'long': r>1.05?'oval':'round'; }
    if(all?.poseLandmarks?.[0]){ const p=all.poseLandmarks[0]; const S=(a,b)=>Math.hypot((p[a].x-p[b].x),(p[a].y-p[b].y)); stats.shoulder_span=+((S(11,12))*100).toFixed(1); stats.hip_span=+((S(23,24))*100).toFixed(1); stats.shoulder_to_hip_ratio=+(stats.shoulder_span/(stats.hip_span||1)).toFixed(2); }
    if(all?.obj?.detections?.length){ stats.objects=all.obj.detections.slice(0,8).map(d=>({name:d.categories[0].categoryName, score:+(d.categories[0].score.toFixed(2))})); }
    if(all?.seg?.categoryMask){ const mask=all.seg.categoryMask.getAsUint8Array(); const person=mask.filter(v=>v===1).length; stats.person_coverage=+((person/mask.length)*100).toFixed(1); }
    return stats; }
  function makePrompt(stats){ const acc=+el('#accuracy').value; const tighten=x=> (acc>0.7? x : acc>0.4? x.replace(/\babout |roughly |around /g,'') : x.split(',').slice(0,Math.max(1,Math.floor(x.split(',').length*0.7))).join(', ')); const parts=[]; parts.push('portrait photo'); if(stats.face_shape) parts.push(`${stats.face_shape} face`); if(stats.eye_tilt_deg!=null) parts.push(`eye tilt ${stats.eye_tilt_deg}°`); if(stats.shoulder_span) parts.push(`shoulder span ~${stats.shoulder_span.toFixed(0)} (rel)`); if(stats.objects?.length){ const tops=stats.objects.slice(0,3).map(o=>o.name).join('/'); parts.push(`scene contains ${tops}`); } parts.push('photorealistic, sharp micro‑detail, minimal distortion'); return tighten(parts.join(', ')); }
  const NEG='lowres, bad anatomy, extra limbs, deformed, fused features, duplicate face, cartoonish, unrealistic skin, oversharpen';

  // ======= Analyze / Self‑Test =======
  el('#btnSelfTest').onclick=async()=>{
    const lines=[]; lines.push(`Origin: ${location.protocol}//${location.host}`);
    lines.push('SW support: '+(('serviceWorker' in navigator)?'yes':'no'));
    const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
    lines.push('Secure origin: '+(secure?'yes':'no')); lines.push('SW expected path: service-worker.js');
    try{ await ensureTasks(); lines.push('✅ FilesetResolver online'); }catch(e){ lines.push('❌ FilesetResolver failed: '+e.message); }
    el('#outDiag').textContent='Self‑Test (online)\n'+lines.join('\n'); els('.tab').forEach(t=>{ if(t.dataset.tab==='diag'){ t.click(); }});
  };

  el('#btnAnalyze').onclick=async()=>{
    try{
      if(!el('#imgFace').src){ toast('Load an image first'); return; }
      els('.canvas').forEach(c=>setupDprCanvas(c));
      el('#outDiag').textContent=`[${new Date().toLocaleTimeString()}] analyze start`;
      const t0=performance.now(); await loadEngines(); const img=el('#imgFace');
      const [face,pose,seg,obj] = await Promise.all([
        el('#cbFace').checked ? faceTask.detect(img) : null,
        el('#cbPose').checked ? poseTask.detect(img) : null,
        el('#cbSeg').checked  ? segTask.segment(img) : null,
        el('#cbObj').checked  ? objTask.detect(img) : null,
      ]);
      const all={ ...face, ...pose, seg, obj };
      drawAll(all);
      const stats=computeStats(all);
      const prompt=makePrompt(stats);
      el('#outPrompt').value=prompt;
      el('#outJSON').textContent=JSON.stringify({image:{w:img.naturalWidth,h:img.naturalHeight}, stats, prompt, negative:NEG}, null, 2);
      const t1=performance.now(); el('#outDiag').textContent+=`\n✓ done in ${(t1-t0).toFixed(0)} ms`; els('.tab').find(t=>t.dataset.tab==='prompt').click();
    }catch(e){ console.error(e); el('#outDiag').textContent+=`\n✗ error: ${e.message}`; els('.tab').find(t=>t.dataset.tab==='diag').click(); toast('Analyze failed'); }
  };

  el('#btnClear').onclick=()=>{ ['Face','Pose','Seg','Obj'].forEach(k=>{ const c=el('#cv'+k); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); el('#img'+k).src='';}); el('#outPrompt').value=''; el('#outJSON').textContent=''; el('#outDiag').textContent='Cleared'; };

  el('#btnCopyPrompt').onclick=()=>copyText(el('#outPrompt').value);
  el('#btnCopyNeg').onclick=()=>copyText(NEG);
  el('#btnCopyJSON').onclick=()=>copyText(el('#outJSON').textContent);
  el('#btnCopyDiag').onclick=()=>copyText(el('#outDiag').textContent);
  els('.copy').forEach(b=> b.onclick=()=>{ const id=b.dataset.copy; const stage=el('#stage'+id.charAt(0).toUpperCase()+id.slice(1)); const canvas=stage.querySelector('canvas'); const data=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download=`${id}.png`; a.click(); });

  window.addEventListener('load',()=>{ els('.canvas').forEach(setupDprCanvas); });
  </script>

  <!--
  To enable install/offline when deployed on your domain, add /service-worker.js next to this file with:
  self.addEventListener('install',e=>e.waitUntil(caches.open('imgintel-v1').then(c=>c.addAll(['./']))));
  self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match('./'))));
  -->
</body>
</html>
